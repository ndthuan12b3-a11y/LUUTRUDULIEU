<!DOCTYPE html><html lang="vi"><head>    <meta charset="UTF-8">    <meta name="robots" content="noindex">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>H·ªá Th·ªëng H√≥a ƒê∆°n - Luxury T·∫øt 2026 (Fullest Version)</title>        <script src="https://cdn.tailwindcss.com"></script>    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Pattaya&family=Mr+Dafoe&family=Mea+Culpa&display=swap" rel="stylesheet">        <style>        /* --- 1. C·∫§U H√åNH GIAO DI·ªÜN CH√çNH --- */        :root { --ruby: #9f1239; --gold: #fbbf24; --smooth: cubic-bezier(0.4, 0, 0.2, 1); }        body { background: #fffcf5; font-family: 'Plus Jakarta Sans', sans-serif; color: #4c0519; overflow-x: hidden; cursor: url('https://img.icons8.com/external-flaticons-lineal-color-flat-icons/32/external-fireworks-chinese-new-year-flaticons-lineal-color-flat-icons.png'), auto; }                canvas#fireworksCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        /* --- 2. T√çCH H·ª¢P CSS L·ªíNG ƒê√àN --- */        .truongdevs-lantern-container{ position:fixed; top:-5px; z-index:9000; pointer-events:none; transform-origin:top center; animation:truongdevs-swing 4s ease-in-out infinite alternate; }        .left-side{left:40px} .right-side{right:40px;animation-delay:1s}        .truongdevs-string{ width:3px; height:80px; margin:0 auto; background:linear-gradient(to bottom,#cfc09f,#b8860b); position:relative; }        .truongdevs-string::before{ content:''; position:absolute; top:-6px; left:-4px; width:12px; height:12px; border-radius:50%; background:radial-gradient(circle,#ffd700,#b8860b); box-shadow:0 1px 2px rgba(0,0,0,.35); }        .truongdevs-lantern{ position:relative; pointer-events:auto; cursor: pointer; }        .truongdevs-lantern-body{ width:120px; height:100px; border-radius:35px; background:radial-gradient(circle at 30% 30%,#ff5a5a,#7a0000); display:flex; align-items:center; justify-content:center; box-shadow: inset 0 0 12px rgba(255,200,120,.35), 0 0 10px rgba(255,140,60,.25), 0 0 20px rgba(255,120,40,.15); animation:truongdevs-glow 3s ease-in-out infinite; }        .truongdevs-lantern-text{ font-family:'Mr Dafoe',cursive; font-size:36px; color:#ffd700; text-shadow:0 0 4px rgba(255,220,150,.8); }        .truongdevs-lantern-top, .truongdevs-lantern-bottom{ width:60px; height:12px; margin:0 auto; background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b); }        .truongdevs-lantern-top{margin-bottom:-5px} .truongdevs-lantern-bottom{margin-top:-5px}        .truongdevs-tassels{ position:absolute; top:100%; left:50%; transform:translateX(-50%); text-align:center; transition:opacity .25s ease; }        .truongdevs-tassels span{ display:inline-block; width:4px; height:50px; margin:0 2px; background:linear-gradient(to bottom,#d2302c,#ff4d4d); border-radius:0 0 5px 5px; animation:truongdevs-tassel-sway 2s ease-in-out infinite alternate; }        .truongdevs-tassels span:nth-child(2){height:65px}        .truongdevs-scroll{ position:absolute; top:100%; left:50%; transform:translateX(-50%); width:0; opacity:0; background: linear-gradient(to right,rgba(255,255,255,.06),rgba(0,0,0,.15),rgba(255,255,255,.06)), #8b0000; border:2px solid #d4af37; box-shadow: 0 0 0 3px #8b0000, 0 0 0 5px #d4af37, 0 6px 12px rgba(0,0,0,.4); border-radius:2px; overflow:visible; transition:width .45s ease, opacity .25s ease; z-index: 9001; }        .truongdevs-scroll::before{ content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%); width:2px; height:10px; background:#ffd700; }        .truongdevs-scroll::after{ content:''; position:absolute; bottom:-12px; left:-12px; right:-12px; height:14px; background:linear-gradient(to right,#8a6e2f,#ffd700,#8a6e2f); border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,.45); }        .truongdevs-scroll-text{ font-family:'Mea Culpa',cursive; font-size:24px; color:#ffd700; display:flex; flex-direction:column; align-items:center; gap:2px; padding:10px 5px 15px; line-height:1.1; text-shadow:0 1px 1px rgba(0,0,0,.6); white-space: nowrap; overflow: hidden; }        .truongdevs-lantern:hover .truongdevs-tassels{opacity:0}        .truongdevs-lantern:hover .truongdevs-scroll{width:80px;opacity:1}        @keyframes truongdevs-swing{ from{transform:rotate(-3deg)} to{transform:rotate(3deg)} }        @keyframes truongdevs-tassel-sway{ from{transform:rotate(2deg)} to{transform:rotate(-2deg)} }        @keyframes truongdevs-glow{ 0%{filter:brightness(1)} 50%{filter:brightness(1.15)} 100%{filter:brightness(1)} }        @media (max-width:430px){ .truongdevs-lantern-container{transform:scale(.55);top:-12px} .left-side{left:-8px} .right-side{right:-8px} }        @media (min-width:431px) and (max-width:820px){ .truongdevs-lantern-container{transform:scale(.7);top:-10px} .left-side{left:10px} .right-side{right:10px} }        @media (min-width:821px) and (max-width:1400px){ .truongdevs-lantern-container{transform:scale(.85)} }
        /* --- 3. HEADER & UI H√ìA ƒê∆†N --- */        .app-gradient { background: radial-gradient(circle at 50% 0%, #dc2626, #991b1b, #450a0a); position: relative; border-bottom: 5px solid transparent; border-image: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) 1; box-shadow: 0 20px 60px rgba(153, 27, 27, 0.4); }                .lantern-chain { position: absolute; top: -5px; width: 100%; display: flex; justify-content: space-evenly; z-index: 20; pointer-events: none; }        .lantern-chain-item { width: 40px; height: 50px; background: radial-gradient(circle at 30% 30%, #ff6b6b, #991b1b); border-radius: 10px; position: relative; animation: small-swing 4s ease-in-out infinite; box-shadow: 0 10px 20px rgba(220, 38, 38, 0.5); border: 1px solid #fcd34d; }        .lantern-chain-item::before { content: ''; position: absolute; top: -20px; left: 50%; width: 1px; height: 20px; background: #fcd34d; }        @keyframes small-swing { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .tab-btn { font-weight: 700; color: rgba(255,255,255,0.7); transition: all 0.4s var(--smooth); }        .tab-btn.active { background: white; border-radius: 16px; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }        #tabTueThien.active { color: #2563eb !important; text-shadow: 0 0 10px rgba(37,99,235,0.3); }        #tabHungThinh.active { color: #059669 !important; text-shadow: 0 0 10px rgba(5,150,105,0.3); }        #tabPhucAn.active { color: #db2777 !important; text-shadow: 0 0 10px rgba(219,39,119,0.3); }
        .luxury-panel { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(25px); border-radius: 3rem; border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 30px 80px -10px rgba(159, 18, 57, 0.15); }        .invoice-card { background: white; border: 1px solid #ffe4e6; border-radius: 24px; transition: all 0.4s var(--smooth); position: relative; overflow: hidden; border-left: 6px solid var(--ruby); }        .invoice-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 20px 40px -10px rgba(220, 38, 38, 0.2); border-color: #fcd34d; }        .invoice-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent); transform: skewX(-25deg); transition: 0.5s; pointer-events: none; }        .invoice-card:hover::before { left: 150%; transition: 0.7s; }
        /* --- 4. HI·ªÜU ·ª®NG KH√ÅC --- */        .modal-content { transform: scale(0.8); opacity: 0; transition: all 0.5s var(--smooth); }        .flex .modal-content { transform: scale(1); opacity: 1; }        .btn-add { background: linear-gradient(135deg, #e11d48, #be123c); border: 2px solid #fcd34d; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.5); }        .flower { position: fixed; pointer-events: none; z-index: 50; animation: fall linear infinite; }        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }        .tet-title { font-family: 'Pattaya', cursive; text-shadow: 0 4px 15px rgba(0,0,0,0.3); }        .dash-item { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; transition: transform 0.3s; }        .dash-item:hover { transform: translateY(-3px); background: rgba(0,0,0,0.35); }
        #blacklistDisplay::-webkit-scrollbar { width: 6px; }        #blacklistDisplay::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }    </style></head><body>    <canvas id="fireworksCanvas"></canvas>
    <div class="truongdevs-lantern-container left-side">        <div class="truongdevs-string"></div>        <div class="truongdevs-lantern">            <div class="truongdevs-lantern-top"></div>            <div class="truongdevs-lantern-body"><span class="truongdevs-lantern-text">Xu√¢n</span></div>            <div class="truongdevs-lantern-bottom"></div>            <div class="truongdevs-tassels"><span></span><span></span><span></span></div>            <div class="truongdevs-scroll">                <div class="truongdevs-scroll-text"><span>Ch√∫c</span><span>T·∫øt</span><span>ƒê·∫øn</span><span>TrƒÉm</span><span>ƒêi·ªÅu</span><span>Nh∆∞</span><span>√ù</span></div>            </div>        </div>    </div>    <div class="truongdevs-lantern-container right-side">        <div class="truongdevs-string"></div>        <div class="truongdevs-lantern">            <div class="truongdevs-lantern-top"></div>            <div class="truongdevs-lantern-body"><span class="truongdevs-lantern-text">2026</span></div>            <div class="truongdevs-lantern-bottom"></div>            <div class="truongdevs-tassels"><span></span><span></span><span></span></div>            <div class="truongdevs-scroll">                <div class="truongdevs-scroll-text"><span>M·ª´ng</span><span>Xu√¢n</span><span>Sang</span><span>V·∫°n</span><span>S·ª±</span><span>Th√†nh</span><span>C√¥ng</span></div>            </div>        </div>    </div>
    <div id="flower-container"></div>    <div id="loadingIndicator" class="fixed inset-0 z-[10000] flex items-center justify-center bg-white">        <div class="w-16 h-16 border-4 border-orange-100 border-t-red-600 rounded-full animate-spin"></div>    </div>    <div id="toastContainer" class="fixed top-8 right-8 z-[10001] space-y-4 w-80 pointer-events-none"></div>
    <nav class="app-gradient pt-16 pb-28 px-4">        <div class="lantern-chain">            <div class="lantern-chain-item"></div><div class="lantern-chain-item"></div>            <div class="lantern-chain-item hidden md:block"></div><div class="lantern-chain-item hidden md:block"></div>            <div class="lantern-chain-item"></div><div class="lantern-chain-item"></div>        </div>        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] left-[-40px] w-48 opacity-90 pointer-events-none z-10 filter drop-shadow-2xl">        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] right-[-40px] w-48 opacity-90 pointer-events-none z-10 transform scale-x-[-1] filter drop-shadow-2xl">
        <div class="max-w-4xl mx-auto flex flex-col items-center relative z-20">            <h1 class="text-5xl md:text-6xl font-800 text-white mb-10 tet-title uppercase italic tracking-wide cursor-pointer">H√ìA ƒê∆†N 2026</h1>                        <div class="w-full max-w-xl bg-black/20 backdrop-blur-md p-2 rounded-[2rem] flex items-center border border-white/10 shadow-2xl">                <button id="tabTueThien" onclick="togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Tu·ªá Thi·ªán</button>                <button id="tabHungThinh" onclick="togglePharmacy('NT H∆∞ng Th·ªãnh', 'HungThinh');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">H∆∞ng Th·ªãnh</button>                <button id="tabPhucAn" onclick="togglePharmacy('NT Ph√∫c An', 'PhucAn');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Ph√∫c An</button>            </div>
            <div class="w-full max-w-xl mt-10 grid grid-cols-3 gap-6 text-white">                <div class="dash-item text-center p-4">                    <p id="totalCount" class="text-3xl font-900 text-yellow-300 drop-shadow-md">0</p>                    <p class="text-[10px] font-bold uppercase opacity-70 tracking-widest mt-1">T·ªïng Kho üßß</p>                </div>                <div class="dash-item text-center p-4">                    <p id="completedCount" class="text-3xl font-900 text-green-300 drop-shadow-md">0</p>                    <p class="text-[10px] font-bold uppercase opacity-70 tracking-widest mt-1">ƒê√£ Xong üå∏</p>                </div>                <div class="dash-item text-center p-4">                    <p id="pendingCount" class="text-3xl font-900 text-orange-200 drop-shadow-md">0</p>                    <p class="text-[10px] font-bold uppercase opacity-70 tracking-widest mt-1">C√≤n L·∫°i üèÆ</p>                </div>            </div>        </div>    </nav>
    <main class="max-w-4xl mx-auto px-4 -mt-20 relative z-30 pb-32">        <div class="luxury-panel p-8 md:p-12 min-h-[500px]">            <div class="flex flex-col md:flex-row gap-5 mb-10">                <div class="relative flex-1 rounded-[2rem]">                    <input type="text" id="mainSearch" oninput="applyFilters()" placeholder="T√¨m ki·∫øm nh√† cung c·∫•p..." class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-rose-50/60 border-2 border-transparent focus:bg-white outline-none font-bold text-slate-700 shadow-inner transition-all"><span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl">üîç</span>                </div>                <div class="flex bg-rose-50/80 p-2 rounded-[1.5rem] border border-rose-100 shadow-inner">                    <button id="filterAll" onclick="changeFilter('all')" class="px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase transition-all">T·∫•t c·∫£</button>                    <button id="filterUncompleted" onclick="changeFilter('uncompleted')" class="px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase transition-all hover:text-rose-700">Ch∆∞a xong</button>                </div>            </div>            <div id="invoiceDisplay" class="space-y-8"></div>        </div>    </main>
    <div class="fixed bottom-10 right-10 flex flex-col gap-5 items-end z-[9000]">        <button onclick="cleanupCompleted();" class="w-16 h-16 bg-white border border-rose-100 text-rose-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 active:rotate-12 transition-all group" title="D·ªçn d·∫πp ƒë√£ xong"><span class="text-3xl group-hover:animate-wiggle">üßπ</span></button>                <button onclick="toggleBlacklistModal();" class="w-16 h-16 bg-zinc-900 border border-zinc-700 text-white rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all group relative" title="S·ªï ƒêen T√†i Ch√≠nh">            <span class="text-3xl">üìì</span>            <span id="blacklistBadge" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full font-bold hidden">0</span>        </button>
        <button onclick="exportUncompletedToExcel();" class="w-16 h-16 bg-white border border-emerald-100 text-emerald-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all group relative" title="Xu·∫•t Excel">            <span class="text-3xl group-hover:animate-bounce">üí∞</span>        </button>        <button onclick="toggleRecycleBinModal();" class="w-16 h-16 bg-white border border-orange-100 text-orange-500 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all" title="Th√πng r√°c"><span class="text-3xl">üéÅ</span></button>        <button onclick="openAddForm();" class="w-20 h-20 btn-add text-white rounded-[1.8rem] flex items-center justify-center hover:rotate-12 hover:scale-110 active:scale-90 transition-all shadow-2xl"><span class="text-5xl drop-shadow-md">üèÆ</span></button>    </div>
    <div id="blacklistModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4 transition-opacity" onclick="toggleBlacklistModal(event)">        <div class="modal-content bg-zinc-900 w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col shadow-2xl border border-zinc-700" onclick="event.stopPropagation()">            <div class="flex justify-between items-center mb-6 text-white italic">                <h3 class="text-2xl font-900 flex items-center gap-2">S·ªï ƒêen T√†i Ch√≠nh üìì</h3>                <button onclick="document.getElementById('blacklistModal').classList.replace('flex', 'hidden')" class="w-10 h-10 flex items-center justify-center bg-zinc-800 rounded-full text-white hover:bg-red-600 transition-colors">‚úï</button>            </div>            <div id="blacklistDisplay" class="flex-1 overflow-y-auto space-y-3 px-1 custom-scrollbar"></div>        </div>    </div>
    <div id="modalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4 transition-opacity" onclick="closeForm(event)">        <div class="modal-content bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl border-t-[12px] border-rose-600" onclick="event.stopPropagation()">            <h3 id="modalTitle" class="text-3xl font-900 italic uppercase mb-8 text-rose-600 text-center drop-shadow-sm">H√≥a ƒê∆°n üßß</h3>            <input type="hidden" id="formId">            <div class="space-y-6">                <div>                    <label class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-2 tracking-widest">Nh√† cung c·∫•p</label>                    <input type="text" id="formName" class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-lg text-slate-800 transition-colors">                </div>                <div>                    <label class="block text-[11px] font-bold text-rose-600 uppercase mb-2 ml-2 tracking-widest">Ng√†y h√≥a ƒë∆°n</label>                    <input type="date" id="formDate" class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-slate-800 transition-colors">                </div>                <div>                    <label class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-2 tracking-widest">Link t√†i li·ªáu (n·∫øu c√≥)</label>                    <input type="url" id="formLink" placeholder="https://..." class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-sm text-blue-600 transition-colors">                </div>                <div class="flex gap-4 pt-4">                    <button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400 uppercase text-xs hover:bg-slate-50 rounded-xl transition-colors">H·ªßy B·ªè</button>                    <button onclick="handleSave()" class="flex-[2] py-4 bg-gradient-to-r from-rose-600 to-red-500 text-white font-bold rounded-2xl shadow-xl uppercase text-xs hover:shadow-2xl active:scale-95 transition-all">L∆∞u D·ªØ Li·ªáu</button>                </div>            </div>        </div>    </div>
    <div id="recycleModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4 transition-opacity" onclick="toggleRecycleBinModal(event)">        <div class="modal-content bg-white w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col shadow-2xl" onclick="event.stopPropagation()">            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-900 text-red-700 uppercase italic flex items-center gap-2">Th√πng R√°c üóëÔ∏è</h3><button onclick="toggleRecycleBinModal()" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 font-black hover:bg-red-50 hover:text-red-500 transition-colors">‚úï</button></div>            <div id="recycleDisplay" class="flex-1 overflow-y-auto space-y-3 px-1"></div>        </div>    </div>
    <script>        const firebaseConfig = { apiKey: "AIzaSyC737M2y1nwrGP48rEQ8dVhpV4DwUkysg", authDomain: "duanluutrunew.firebaseapp.com", projectId: "duanluutrunew", storageBucket: "duanluutrunew.appspot.com", messagingSenderId: "1008741702165", appId: "1:1008741702165:web:7e81901f4aac66cb9a0c1c" };        firebase.initializeApp(firebaseConfig);        const db = firebase.firestore(); const COLL = 'medx_invoices';        let currentPharmacy = 'NT Tu·ªá Thi·ªán', currentFilter = 'all', allInvoices = [], unsub = null;

        // --- BLACKLIST LOGIC (3 DAYS & 2026) ---
        function getBlacklist(data) {
            const today = new Date(); today.setHours(0,0,0,0);
            const limitDate = new Date("2026-01-01");
            return data.filter(item => {
                const itemDate = new Date(item.date);
                if (itemDate < limitDate && !item.everBlacklisted) return false;
                const diffDays = Math.ceil((today - itemDate) / (1000 * 60 * 60 * 24));
                if (!item.completed && diffDays > 3) {
                    if (!item.everBlacklisted) { db.collection(COLL).doc(item.id).update({ everBlacklisted: true }); }
                    return true;
                }
                return item.everBlacklisted === true;
            });
        }
        async function addToBlacklist(id) { if(confirm("Li·ªát nh√† cung c·∫•p n√†y v√†o S·ªï ƒêen?")) { await db.collection(COLL).doc(id).update({ everBlacklisted: true }); showToast("ƒê√£ v√†o S·ªï ƒêen üìì"); } }
        function updateBlacklistBadge(data) { const list = getBlacklist(data); const badge = document.getElementById('blacklistBadge'); if (list.length > 0) { badge.innerText = list.length; badge.classList.remove('hidden'); } else badge.classList.add('hidden'); }
        function renderBlacklist() { 
            const area = document.getElementById('blacklistDisplay'); const list = getBlacklist(allInvoices); 
            const today = new Date(); today.setHours(0,0,0,0);
            if (!list.length) { area.innerHTML = '<p class="text-center py-10 text-zinc-500 italic">Tr·ªëng ‚ú®</p>'; return; } 
            area.innerHTML = list.map(item => {
                const itemDate = new Date(item.date);
                const diffDays = Math.ceil((today - itemDate) / (1000 * 60 * 60 * 24));
                const delayText = diffDays > 0 ? `<span class="text-red-500 font-black underline">Tr·ªÖ ${diffDays} ng√†y</span>` : `<span class="text-zinc-400 italic">Ch∆∞a t·ªõi h·∫°n</span>`;
                return `<div class="flex items-center justify-between p-5 bg-zinc-800/50 rounded-2xl border border-zinc-700 group"><div class="flex-1"><p class="font-bold text-red-500 text-lg leading-tight">${item.name}</p><p class="text-[10px] text-zinc-400 mt-1">Ng√†y HD: ${item.date} ‚Ä¢ ${delayText}</p><span class="text-[9px] font-black uppercase mt-1 inline-block ${item.completed ? 'text-green-500' : 'text-orange-500'}">${item.completed ? 'ƒê√£ ho√†n th√†nh üå∏' : 'Ch∆∞a ho√†n th√†nh üèÆ'}</span></div><button onclick="confirmDelete('${item.id}')" class="p-3 bg-red-900/30 text-red-500 rounded-xl hover:bg-red-600 transition-all">‚úï</button></div>`;
            }).join(''); 
        }
        function toggleBlacklistModal(e) { const m = document.getElementById('blacklistModal'); if (e && e.target.id !== 'blacklistModal' && !e.target.closest('button[title="S·ªï ƒêen T√†i Ch√≠nh"]')) return; if (m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); renderBlacklist(); } else m.classList.replace('flex', 'hidden'); }

        // --- CORE LOGIC ---
        function loadData() { if (unsub) unsub(); unsub = db.collection(COLL).where('pharmacy', '==', currentPharmacy).where('isDeleted', '==', false).orderBy('date', 'desc').onSnapshot(snap => { allInvoices = []; snap.forEach(doc => allInvoices.push({ id: doc.id, ...doc.data() })); applyFilters(); if (!document.getElementById('blacklistModal').classList.contains('hidden')) renderBlacklist(); }); }
        function renderInvoices(data) {
            const display = document.getElementById('invoiceDisplay');
            if (!data.length) { display.innerHTML = '<p class="text-center py-20 opacity-40 text-rose-800 font-black uppercase tracking-[0.3em]">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'; return; }
            const groups = data.reduce((acc, item) => { acc[item.date] = acc[item.date] || []; acc[item.date].push(item); return acc; }, {});
            let html = '';
            Object.keys(groups).sort().reverse().forEach(dateStr => {
                const d = new Date(dateStr);
                html += `<div class="mb-12"><div class="sticky top-[-1px] z-10 bg-[#fffcf5]/95 backdrop-blur-md py-4 flex items-center justify-between border-b-2 border-orange-100"><div class="flex items-center gap-4"><div class="bg-white border border-rose-200 rounded-2xl p-1 shadow-sm text-center min-w-[60px]"><div class="text-[10px] font-black text-rose-400 uppercase">Ng√†y</div><div class="text-2xl font-900 text-rose-800">${d.getDate()}</div></div><div><p class="text-xs font-bold text-rose-300 uppercase tracking-widest">Th√°ng ${d.getMonth()+1}</p><p class="text-xl font-800 text-rose-900">${d.toLocaleDateString('vi-VN', { weekday: 'long' })}</p></div></div></div><div class="mt-4 space-y-4">`;
                groups[dateStr].forEach(item => {
                    html += `<div class="invoice-card flex items-center justify-between p-6 group"><div class="flex items-center gap-5"><button onclick="db.collection(COLL).doc('${item.id}').update({completed: ${!item.completed}})" class="w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all duration-500 ${item.completed ? 'bg-rose-600 text-yellow-300 border-yellow-400 rotate-[360deg]' : 'border-rose-100 text-slate-300'}">${item.completed ? 'üå∏' : 'üèÆ'}</button><div><p class="font-bold text-lg ${item.completed ? 'line-through opacity-40 text-slate-500' : 'text-slate-800'}">${item.name}</p><p class="text-[10px] font-bold text-rose-300 uppercase tracking-wider">${item.pharmacy}</p></div></div><div class="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                        ${item.link ? `<a href="${item.link}" target="_blank" class="p-3 bg-blue-50 text-blue-500 rounded-xl hover:bg-blue-100">üîó</a>` : ''}
                        <button onclick="addToBlacklist('${item.id}')" class="p-3 bg-zinc-100 text-zinc-900 rounded-xl hover:bg-zinc-800 hover:text-white" title="S·ªï ƒêen">üìì</button>
                        <button onclick="openEditForm('${item.id}')" class="p-3 bg-amber-50 text-amber-500 rounded-xl hover:bg-amber-100">‚úèÔ∏è</button>
                        <button onclick="confirmDelete('${item.id}')" class="p-3 bg-red-50 text-red-400 rounded-xl hover:bg-red-100" title="Th√πng r√°c">üóëÔ∏è</button>
                    </div></div>`;
                }); html += `</div></div>`;
            }); display.innerHTML = html;
        }
        async function handleSave() { const id = document.getElementById('formId').value; const name = document.getElementById('formName').value.trim(); const date = document.getElementById('formDate').value; const link = document.getElementById('formLink').value.trim(); if (!name || !date) return; if (id) await db.collection(COLL).doc(id).update({ name, date, link }); else await db.collection(COLL).add({ name, date, link, pharmacy: currentPharmacy, completed: false, isDeleted: false, everBlacklisted: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); closeModal(); showToast("ƒê√£ l∆∞u th√†nh c√¥ng! üßß"); }
        function togglePharmacy(name, themeId) { currentPharmacy = name; ['tabTueThien', 'tabHungThinh', 'tabPhucAn'].forEach(id => document.getElementById(id).classList.remove('active')); document.getElementById('tab' + themeId).classList.add('active'); loadData(); }
        function applyFilters() { const searchVal = document.getElementById('mainSearch').value.toLowerCase(); let filtered = allInvoices; if (currentFilter === 'uncompleted') filtered = filtered.filter(i => !i.completed); if (searchVal) filtered = filtered.filter(i => i.name.toLowerCase().includes(searchVal)); renderInvoices(filtered); document.getElementById('totalCount').innerText = allInvoices.length; document.getElementById('completedCount').innerText = allInvoices.filter(i => i.completed).length; document.getElementById('pendingCount').innerText = allInvoices.length - allInvoices.filter(i => i.completed).length; updateBlacklistBadge(allInvoices); }
        function changeFilter(type) { currentFilter = type; document.getElementById('filterAll').className = type === 'all' ? "px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase" : "px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase"; document.getElementById('filterUncompleted').className = type === 'uncompleted' ? "px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase" : "px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase"; applyFilters(); }
        function confirmDelete(id) { if(confirm("Chuy·ªÉn h√≥a ƒë∆°n n√†y v√†o th√πng r√°c?")) { db.collection(COLL).doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp() }); showToast("ƒê√£ chuy·ªÉn v√†o th√πng r√°c üóëÔ∏è"); } }
        function openAddForm() { document.getElementById('formId').value = ''; document.getElementById('formName').value = ''; document.getElementById('formDate').value = new Date().toLocaleDateString('en-CA'); document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        function openEditForm(id) { const item = allInvoices.find(i => i.id === id); document.getElementById('formId').value = item.id; document.getElementById('formName').value = item.name; document.getElementById('formDate').value = item.date; document.getElementById('formLink').value = item.link || ''; document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        function closeModal() { document.getElementById('modalOverlay').classList.replace('flex', 'hidden'); }
        function showToast(msg) { const c = document.getElementById('toastContainer'); const id = Date.now(); c.insertAdjacentHTML('beforeend', `<div id="${id}" class="bg-rose-900 text-white px-6 py-4 rounded-2xl shadow-xl border-l-4 border-yellow-400 font-bold">‚ú® ${msg}</div>`); setTimeout(() => document.getElementById(id)?.remove(), 3000); }
        function toggleRecycleBinModal(e) { const m = document.getElementById('recycleModal'); if (e && e.target.id !== 'recycleModal' && !e.target.closest('button[title="üéÅ"]')) return; if (m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); db.collection(COLL).where('isDeleted', '==', true).orderBy('deletedAt', 'desc').limit(20).onSnapshot(snap => { document.getElementById('recycleDisplay').innerHTML = snap.docs.map(doc => `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl mb-2"><span>${doc.data().name}</span><button onclick="db.collection(COLL).doc('${doc.id}').update({isDeleted:false})" class="text-blue-500 font-bold">Kh√¥i ph·ª•c</button></div>`).join(''); }); } else m.classList.replace('flex', 'hidden'); }
        async function cleanupCompleted() { const list = allInvoices.filter(i => i.completed); if (list.length && confirm(`D·ªçn d·∫πp ${list.length} m·ª•c?`)) { const batch = db.batch(); list.forEach(i => batch.update(db.collection(COLL).doc(i.id), { isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp() })); await batch.commit(); } }
        function exportUncompletedToExcel() { const data = allInvoices.filter(i => !i.completed); if (!data.length) return; const ws = XLSX.utils.json_to_sheet(data.map(i => ({ "Ng√†y": i.date, "Nh√† Cung C·∫•p": i.name, "Nh√† Thu·ªëc": i.pharmacy }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "CongNo"); XLSX.writeFile(wb, `CONG_NO_2026.xlsx`); }
        function closeForm(e) { if(e.target.id === 'modalOverlay') closeModal(); }

        // --- DECORATIONS ---
        const canvas = document.getElementById("fireworksCanvas"); const ctx = canvas.getContext("2d"); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        class Particle { constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.size = Math.random() * 5 + 1; this.speedX = Math.random() * 6 - 3; this.speedY = Math.random() * 6 - 3; this.life = Math.random() * 30 + 50; } update() { this.x += this.speedX; this.y += this.speedY; this.size *= 0.95; this.life--; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); } }
        const particles = []; function createFireworks(x, y) { const colors = ["#ff5733", "#33ff57", "#5733ff", "#f4ff33", "#ffd700", "#ff0000"]; for (let i = 0; i < 40; i++) { particles.push(new Particle(x, y, colors[Math.floor(Math.random() * colors.length)])); } }
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach((p, i) => { if (p.life <= 0 || p.size <= 0.1) particles.splice(i, 1); else { p.update(); p.draw(); } }); requestAnimationFrame(animate); } animate();
        window.addEventListener('click', (e) => { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') createFireworks(e.clientX, e.clientY); });
        setInterval(() => { const f = document.createElement('div'); f.className = 'flower'; f.innerHTML = `<img src="https://lutaweb.com/wp-content/uploads/2022/01/hoa-mai-1.png" style="width:${Math.random()*20+10}px">`; f.style.left = Math.random() * 100 + 'vw'; f.style.animationDuration = Math.random() * 5 + 7 + 's'; document.getElementById('flower-container').appendChild(f); setTimeout(() => f.remove(), 10000); }, 800);
        window.onload = () => { setTimeout(() => { document.getElementById('loadingIndicator').classList.add('hidden'); togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien'); }, 1000); };
    </script></body></html>
