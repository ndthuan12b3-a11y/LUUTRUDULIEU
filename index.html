<!DOCTYPE html><html lang="vi"><head>    <meta charset="UTF-8">    <meta name="robots" content="noindex">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Há»‡ Thá»‘ng HÃ³a ÄÆ¡n - Luxury Táº¿t 2026 (Quick-View Edition)</title>        <script src="https://cdn.tailwindcss.com"></script>    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Pattaya&family=Mr+Dafoe&family=Mea+Culpa&display=swap" rel="stylesheet">        <style>        :root { --ruby: #9f1239; --gold: #fbbf24; --smooth: cubic-bezier(0.4, 0, 0.2, 1); }        body { background: #fffcf5; font-family: 'Plus Jakarta Sans', sans-serif; color: #4c0519; overflow-x: hidden; cursor: url('https://img.icons8.com/external-flaticons-lineal-color-flat-icons/32/external-fireworks-chinese-new-year-flaticons-lineal-color-flat-icons.png'), auto; }        canvas#fireworksCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }                /* Lá»’NG ÄÃˆN */        .truongdevs-lantern-container{ position:fixed; top:-5px; z-index:9000; pointer-events:none; transform-origin:top center; animation:truongdevs-swing 4s ease-in-out infinite alternate; }        .left-side{left:40px} .right-side{right:40px;animation-delay:1s}        .truongdevs-string{ width:3px; height:80px; margin:0 auto; background:linear-gradient(to bottom,#cfc09f,#b8860b); position:relative; }        .truongdevs-string::before{ content:''; position:absolute; top:-6px; left:-4px; width:12px; height:12px; border-radius:50%; background:radial-gradient(circle,#ffd700,#b8860b); box-shadow:0 1px 2px rgba(0,0,0,.35); }        .truongdevs-lantern{ position:relative; pointer-events:auto; cursor: pointer; }        .truongdevs-lantern-body{ width:120px; height:100px; border-radius:35px; background:radial-gradient(circle at 30% 30%,#ff5a5a,#7a0000); display:flex; align-items:center; justify-content:center; box-shadow: inset 0 0 12px rgba(255,200,120,.35), 0 0 10px rgba(255,140,60,.25), 0 0 20px rgba(255,120,40,.15); animation:truongdevs-glow 3s ease-in-out infinite; }        .truongdevs-lantern-text{ font-family:'Mr Dafoe',cursive; font-size:36px; color:#ffd700; text-shadow:0 0 4px rgba(255,220,150,.8); }        .truongdevs-lantern-top, .truongdevs-lantern-bottom{ width:60px; height:12px; margin:0 auto; background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b); }        .truongdevs-lantern-top{margin-bottom:-5px} .truongdevs-lantern-bottom{margin-top:-5px}        .truongdevs-tassels{ position:absolute; top:100%; left:50%; transform:translateX(-50%); text-align:center; transition:opacity .25s ease; }        .truongdevs-tassels span{ display:inline-block; width:4px; height:50px; margin:0 2px; background:linear-gradient(to bottom,#d2302c,#ff4d4d); border-radius:0 0 5px 5px; animation:truongdevs-tassel-sway 2s ease-in-out infinite alternate; }        .truongdevs-tassels span:nth-child(2){height:65px}        .truongdevs-scroll{ position:absolute; top:100%; left:50%; transform:translateX(-50%); width:0; opacity:0; background: linear-gradient(to right,rgba(255,255,255,.06),rgba(0,0,0,.15),rgba(255,255,255,.06)), #8b0000; border:2px solid #d4af37; box-shadow: 0 0 0 3px #8b0000, 0 0 0 5px #d4af37, 0 6px 12px rgba(0,0,0,.4); border-radius:2px; overflow:visible; transition:width .45s ease, opacity .25s ease; z-index: 9001; }        .truongdevs-scroll-text{ font-family:'Mea Culpa',cursive; font-size:24px; color:#ffd700; display:flex; flex-direction:column; align-items:center; gap:2px; padding:10px 5px 15px; line-height:1.1; text-shadow:0 1px 1px rgba(0,0,0,.6); white-space: nowrap; overflow: hidden; }        .truongdevs-lantern:hover .truongdevs-tassels{opacity:0}        .truongdevs-lantern:hover .truongdevs-scroll{width:80px;opacity:1}                @keyframes truongdevs-swing{ from{transform:rotate(-3deg)} to{transform:rotate(3deg)} }        @keyframes truongdevs-glow{ 0%{filter:brightness(1)} 50%{filter:brightness(1.15)} 100%{filter:brightness(1)} }
        /* UI HÃ“A ÄÆ N */        .app-gradient { background: radial-gradient(circle at 50% 0%, #dc2626, #991b1b, #450a0a); position: relative; border-bottom: 5px solid transparent; border-image: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) 1; box-shadow: 0 20px 60px rgba(153, 27, 27, 0.4); }        .tab-btn { font-weight: 700; color: rgba(255,255,255,0.7); transition: all 0.4s var(--smooth); }        .tab-btn.active { background: white; border-radius: 16px; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }        #tabTueThien.active { color: #2563eb !important; } #tabHungThinh.active { color: #059669 !important; } #tabPhucAn.active { color: #db2777 !important; }                .luxury-panel { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(25px); border-radius: 3rem; border: 1px solid rgba(255, 255, 255, 0.8); }        .link-batch-box { background: white; border: 1px solid #ffe4e6; border-radius: 28px; padding: 1.5rem; margin-bottom: 2rem; border-left: 8px solid #fcd34d; }        .btn-luxury-view {            background: linear-gradient(135deg, #b8860b, #ffd700, #daa520);            color: #450a0a !important;            font-weight: 800; text-transform: uppercase; padding: 8px 18px; border-radius: 12px; box-shadow: 0 4px 15px rgba(184, 134, 11, 0.4); border: 1px solid #ffffffaa; transition: all 0.3s ease;        }        .btn-luxury-view:hover { transform: translateY(-3px) scale(1.05); filter: brightness(1.1); }
        .invoice-card { background: #fffcf5; border: 1px solid #fff1f2; border-radius: 18px; padding: 1rem; width: 100%; transition: all 0.4s; }        .invoice-card:hover { transform: scale(1.005); background: white; }
        .btn-add { background: linear-gradient(135deg, #e11d48, #be123c); border: 2px solid #fcd34d; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.5); }        .flower { position: fixed; pointer-events: none; z-index: 50; animation: fall linear infinite; }        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
        .tet-title { font-family: 'Pattaya', cursive; text-shadow: 0 4px 15px rgba(0,0,0,0.3); }        .dash-item { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; }    </style></head><body>    <canvas id="fireworksCanvas"></canvas>        <div class="truongdevs-lantern-container left-side">        <div class="truongdevs-string"></div>        <div class="truongdevs-lantern">            <div class="truongdevs-lantern-top"></div>            <div class="truongdevs-lantern-body"><span class="truongdevs-lantern-text">XuÃ¢n</span></div>            <div class="truongdevs-lantern-bottom"></div>            <div class="truongdevs-tassels"><span></span><span></span><span></span></div>            <div class="truongdevs-scroll"><div class="truongdevs-scroll-text"><span>ChÃºc</span><span>Táº¿t</span><span>Äáº¿n</span><span>TrÄƒm</span><span>Äiá»u</span><span>NhÆ°</span><span>Ã</span></div></div>        </div>    </div>    <div class="truongdevs-lantern-container right-side">        <div class="truongdevs-string"></div>        <div class="truongdevs-lantern">            <div class="truongdevs-lantern-top"></div>            <div class="truongdevs-lantern-body"><span class="truongdevs-lantern-text">2026</span></div>            <div class="truongdevs-lantern-bottom"></div>            <div class="truongdevs-tassels"><span></span><span></span><span></span></div>            <div class="truongdevs-scroll"><div class="truongdevs-scroll-text"><span>Má»«ng</span><span>XuÃ¢n</span><span>Sang</span><span>Váº¡n</span><span>Sá»±</span><span>ThÃ nh</span><span>CÃ´ng</span></div></div>        </div>    </div>
    <div id="flower-container"></div>    <div id="loadingIndicator" class="fixed inset-0 z-[10000] flex items-center justify-center bg-white">        <div class="w-16 h-16 border-4 border-orange-100 border-t-red-600 rounded-full animate-spin"></div>    </div>    <div id="toastContainer" class="fixed top-8 right-8 z-[10001] space-y-4 w-80 pointer-events-none"></div>

    <nav class="app-gradient pt-16 pb-28 px-4">        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] left-[-40px] w-48 opacity-90 pointer-events-none z-10 filter drop-shadow-2xl">        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] right-[-40px] w-48 opacity-90 pointer-events-none z-10 transform scale-x-[-1] filter drop-shadow-2xl">                <div class="max-w-4xl mx-auto flex flex-col items-center relative z-20">            <h1 class="text-5xl md:text-6xl font-800 text-white mb-10 tet-title uppercase italic tracking-wide cursor-pointer">HÃ“A ÄÆ N 2026</h1>                        <div class="w-full max-w-xl bg-black/20 backdrop-blur-md p-2 rounded-[2rem] flex items-center border border-white/10 shadow-2xl">                <button id="tabTueThien" onclick="togglePharmacy('NT Tuá»‡ Thiá»‡n', 'TueThien');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Tuá»‡ Thiá»‡n</button>                <button id="tabHungThinh" onclick="togglePharmacy('NT HÆ°ng Thá»‹nh', 'HungThinh');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">HÆ°ng Thá»‹nh</button>                <button id="tabPhucAn" onclick="togglePharmacy('NT PhÃºc An', 'PhucAn');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">PhÃºc An</button>            </div>
            <div class="w-full max-w-xl mt-10 grid grid-cols-3 gap-6 text-white text-center">                <div class="dash-item p-4"><p id="totalCount" class="text-3xl font-900 text-yellow-300">0</p><p class="text-[10px] font-bold uppercase opacity-70">Tá»•ng Kho ğŸ§§</p></div>                <div class="dash-item p-4"><p id="completedCount" class="text-3xl font-900 text-green-300">0</p><p class="text-[10px] font-bold uppercase opacity-70">ÄÃ£ Xong ğŸŒ¸</p></div>                <div class="dash-item p-4"><p id="pendingCount" class="text-3xl font-900 text-orange-200">0</p><p class="text-[10px] font-bold uppercase opacity-70">CÃ²n Láº¡i ğŸ®</p></div>            </div>        </div>    </nav>
    <main class="max-w-4xl mx-auto px-4 -mt-20 relative z-30 pb-32">        <div class="luxury-panel p-8 md:p-12 min-h-[500px] shadow-2xl">            <div class="flex flex-col md:flex-row gap-5 mb-10">                <div class="relative flex-1">                    <input type="text" id="mainSearch" oninput="applyFilters()" placeholder="TÃ¬m kiáº¿m nhÃ  cung cáº¥p..." class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-rose-50/60 outline-none font-bold text-slate-700 shadow-inner">                    <span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl">ğŸ”</span>                </div>                <div class="flex bg-rose-50/80 p-2 rounded-[1.5rem] border border-rose-100 shadow-inner">                    <button id="filterAll" onclick="changeFilter('all')" class="px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase transition-all">Táº¥t cáº£</button>                    <button id="filterUncompleted" onclick="changeFilter('uncompleted')" class="px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase transition-all hover:text-rose-700">ChÆ°a xong</button>                </div>            </div>            <div id="invoiceDisplay" class="space-y-8"></div>        </div>    </main>

    <div class="fixed bottom-10 right-10 flex flex-col gap-5 items-end z-[9000]">        <button onclick="cleanupCompleted();" class="w-16 h-16 bg-white border border-rose-100 text-rose-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110">ğŸ§¹</button>        <button onclick="toggleBlacklistModal();" class="w-16 h-16 bg-zinc-900 border border-zinc-700 text-white rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 relative"><span>ğŸ““</span><span id="blacklistBadge" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full font-bold hidden">0</span></button>        <button onclick="exportUncompletedToExcel();" class="w-16 h-16 bg-white border border-emerald-100 text-emerald-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110">ğŸ’°</button>        <button onclick="toggleRecycleBinModal();" class="w-16 h-16 bg-white border border-orange-100 text-orange-500 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110">ğŸ</button>        <button onclick="openAddForm();" class="w-20 h-20 btn-add text-white rounded-[1.8rem] flex items-center justify-center hover:scale-110 transition-all shadow-2xl text-5xl">ğŸ®</button>    </div>

    <div id="alertModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[20000] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[3rem] p-8 shadow-2xl border-t-[12px] border-amber-500 relative text-center">
            <span class="text-6xl">âš ï¸</span><h3 class="text-2xl font-900 text-amber-600 uppercase italic mt-4">HÃ³a ÄÆ¡n QuÃ¡ Háº¡n (3 NgÃ y+)</h3>
            <p class="text-slate-500 text-sm mb-6">Báº¡n cÃ³ cÃ¡c hÃ³a Ä‘Æ¡n chÆ°a hoÃ n thÃ nh tá»« nhá»¯ng ngÃ y trÆ°á»›c!</p>
            <div id="alertList" class="max-h-[300px] overflow-y-auto space-y-3 mb-8 px-2 text-left"></div>
            <button onclick="document.getElementById('alertModal').classList.replace('flex', 'hidden')" class="w-full py-4 bg-amber-500 text-white font-900 rounded-2xl shadow-lg uppercase">ÄÃ£ Hiá»ƒu ğŸ§§</button>
        </div>
    </div>

    <div id="quickViewModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl z-[30000] hidden flex-col transition-all">
        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-rose-900 to-red-800 border-b border-yellow-500/30">
            <div class="flex items-center gap-3"><span class="text-2xl">ğŸ‘ï¸</span><h3 class="text-white font-bold uppercase italic" id="quickViewTitle">Xem Nhanh HÃ³a ÄÆ¡n</h3></div>
            <div class="flex gap-4"><a id="quickViewFullLink" href="#" target="_blank" class="px-4 py-2 bg-white/10 text-white rounded-xl text-sm font-bold">Má»Ÿ tab má»›i â†—</a><button onclick="closeQuickView()" class="w-10 h-10 flex items-center justify-center bg-red-500 text-white rounded-full font-black">âœ•</button></div>
        </div>
        <div class="flex-1 w-full bg-white relative">
            <div id="iframeLoading" class="absolute inset-0 flex items-center justify-center bg-slate-100 z-10"><div class="w-12 h-12 border-4 border-rose-600 border-t-transparent rounded-full animate-spin"></div></div>
            <iframe id="quickViewFrame" src="" class="w-full h-full border-none relative z-20" onload="document.getElementById('iframeLoading').classList.add('hidden')"></iframe>
        </div>
    </div>

    <div id="blacklistModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4"><div class="modal-content bg-zinc-900 w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col border border-zinc-700 shadow-2xl"><div class="flex justify-between items-center mb-6 text-white italic"><h3 class="text-2xl font-900">Danh SÃ¡ch Äen ğŸ““</h3><button onclick="toggleBlacklistModal()" class="text-white">âœ•</button></div><div id="blacklistDisplay" class="flex-1 overflow-y-auto space-y-3 px-1"></div></div></div>
    <div id="modalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4" onclick="closeForm(event)"><div class="modal-content bg-white w-full max-w-md rounded-[3rem] p-10 border-t-[12px] border-rose-600 shadow-2xl" onclick="event.stopPropagation()"><h3 id="modalTitle" class="text-3xl font-900 italic uppercase mb-8 text-rose-600 text-center">HÃ³a ÄÆ¡n ğŸ§§</h3><input type="hidden" id="formId"><div class="space-y-6"><div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-2">TÃªn nhÃ  cung cáº¥p</label><textarea id="formName" rows="4" class="w-full p-4 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-slate-800"></textarea></div><div><label class="block text-[11px] font-bold text-rose-600 uppercase mb-2">NgÃ y hÃ³a Ä‘Æ¡n</label><input type="date" id="formDate" class="w-full p-4 rounded-2xl bg-rose-50 outline-none font-bold text-slate-800"></div><div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-2">Link hÃ³a Ä‘Æ¡n</label><input type="url" id="formLink" class="w-full p-4 rounded-2xl bg-rose-50 outline-none font-bold text-blue-600"></div><div class="flex gap-4 pt-4"><button onclick="closeModal()" class="flex-1 font-bold text-slate-400 uppercase text-xs">Há»§y</button><button onclick="handleSave()" class="flex-[2] py-4 bg-rose-600 text-white font-bold rounded-2xl shadow-xl uppercase text-xs">LÆ°u Dá»¯ Liá»‡u</button></div></div></div></div>
    <div id="recycleModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4" onclick="toggleRecycleBinModal(event)"><div class="modal-content bg-white w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col shadow-2xl" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-900 text-red-700 uppercase italic">ThÃ¹ng RÃ¡c ğŸ—‘ï¸</h3><button onclick="toggleRecycleBinModal()" class="text-slate-500 font-black">âœ•</button></div><div id="recycleDisplay" class="flex-1 overflow-y-auto space-y-3 px-1"></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC737M2y1nwrGP48rEQ8dVhpV4DwUkysg", authDomain: "duanluutrunew.firebaseapp.com", projectId: "duanluutrunew", storageBucket: "duanluutrunew.appspot.com", messagingSenderId: "1008741702165", appId: "1:1008741702165:web:7e81901f4aac66cb9a0c1c" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const COLL = 'medx_invoices';
        let currentPharmacy = 'NT Tuá»‡ Thiá»‡n', currentFilter = 'all', allInvoices = [], unsub = null;
        let hasShownAlert = false; // QUAN TRá»ŒNG: NgÄƒn cháº·n báº£ng thÃ´ng bÃ¡o láº·p láº¡i

        function removeVietnameseTones(str) { if(!str) return ""; return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/Ä‘/g, "d").replace(/Ä/g, "D"); }

        function loadData() {
            if (unsub) unsub();
            unsub = db.collection(COLL).where('date', '>=', '2025-01-01').orderBy('date', 'desc').onSnapshot(snap => {
                allInvoices = []; snap.forEach(doc => allInvoices.push({ id: doc.id, ...doc.data() }));
                allInvoices.sort((a, b) => b.date.localeCompare(a.date));
                applyFilters();
                if (!hasShownAlert) checkOverdueInvoices();
                if (!document.getElementById('blacklistModal').classList.contains('hidden')) renderBlacklist();
            });
        }

        function checkOverdueInvoices() {
            const today = new Date(); today.setHours(0,0,0,0);
            const overdueList = allInvoices.filter(i => !i.completed && !i.isDeleted && Math.floor((today - new Date(i.date)) / (1000 * 3600 * 24)) >= 3);
            if (overdueList.length > 0) {
                document.getElementById('alertList').innerHTML = overdueList.map(i => `<div class="p-3 bg-amber-50 rounded-xl flex justify-between items-center"><div class="min-w-0 flex-1"><p class="font-bold text-slate-800 truncate">${i.name}</p><p class="text-[9px] font-black text-amber-600">${i.pharmacy} - ${i.date}</p></div><span class="text-red-500 font-black text-[10px] ml-2 shrink-0">TRá»„!</span></div>`).join('');
                document.getElementById('alertModal').classList.replace('hidden', 'flex');
                hasShownAlert = true; 
            }
        }

        // QUICK-VIEW FUNCTIONS
        function openQuickView(url, title) {
            const modal = document.getElementById('quickViewModal');
            document.getElementById('quickViewTitle').innerText = title;
            document.getElementById('quickViewFullLink').href = url;
            document.getElementById('iframeLoading').classList.remove('hidden');
            document.getElementById('quickViewFrame').src = url;
            modal.classList.replace('hidden', 'flex');
            document.body.style.overflow = 'hidden';
        }
        function closeQuickView() {
            document.getElementById('quickViewModal').classList.replace('flex', 'hidden');
            document.getElementById('quickViewFrame').src = '';
            document.body.style.overflow = 'auto';
        }

        // RENDER & FILTERS
        function applyFilters() {
            const rawSearch = document.getElementById('mainSearch').value.toLowerCase();
            const searchVal = removeVietnameseTones(rawSearch);
            let pData = allInvoices.filter(i => !i.isDeleted && i.pharmacy === currentPharmacy);
            document.getElementById('totalCount').innerText = pData.length;
            document.getElementById('completedCount').innerText = pData.filter(i => i.completed).length;
            document.getElementById('pendingCount').innerText = pData.filter(i => !i.completed).length;
            let filtered = pData;
            if (currentFilter === 'uncompleted') filtered = filtered.filter(i => !i.completed);
            if (rawSearch) filtered = filtered.filter(i => removeVietnameseTones(i.name.toLowerCase()).includes(searchVal));
            renderInvoices(filtered);
            updateBlacklistBadge(allInvoices);
        }

        function renderInvoices(data) {
            const display = document.getElementById('invoiceDisplay');
            if (!data.length) { display.innerHTML = '<p class="text-center py-20 opacity-40 font-black uppercase tracking-[0.3em]">Danh sÃ¡ch trá»‘ng</p>'; return; }
            const dateGroups = data.reduce((acc, item) => { acc[item.date] = acc[item.date] || []; acc[item.date].push(item); return acc; }, {});
            let html = '';
            Object.keys(dateGroups).sort((a,b) => b.localeCompare(a)).forEach(dateStr => {
                const d = new Date(dateStr);
                html += `<div class="mb-12"><div class="sticky top-[60px] z-10 bg-[#fffcf5]/95 backdrop-blur-md py-4 flex items-center justify-between border-b-2 border-orange-100 mb-6"><div class="flex items-center gap-4"><div class="bg-white border border-rose-200 rounded-2xl p-1 shadow-sm text-center min-w-[60px]"><div class="text-[10px] font-black text-rose-400 uppercase">NgÃ y</div><div class="text-2xl font-900 text-rose-800">${d.getDate()}</div></div><div><p class="text-xl font-800 text-rose-900">${d.toLocaleDateString('vi-VN', { weekday: 'long' })}</p></div></div></div>`;
                const linkGroups = dateGroups[dateStr].reduce((acc, item) => { const k = (item.link && item.link.trim() !== "") ? item.link : "no_link"; acc[k] = acc[k] || []; acc[k].push(item); return acc; }, {});
                Object.keys(linkGroups).forEach(linkKey => {
                    const items = linkGroups[linkKey]; const isNoLink = linkKey === "no_link";
                    html += `<div class="link-batch-box"><div class="flex items-center justify-between mb-4 pb-2 border-b border-rose-50"><div class="flex items-center gap-2"><span class="text-xl">${isNoLink ? 'ğŸ“¦' : 'ğŸ“‚'}</span><span class="text-[10px] font-900 uppercase tracking-widest ${isNoLink ? 'text-slate-400' : 'text-blue-600'}">${isNoLink ? 'Láº»' : 'Äá»¢T HÃ€NG'}</span></div>${!isNoLink ? `<button onclick="openQuickView('${linkKey}', 'HÃ³a Ä‘Æ¡n ngÃ y ${dateStr}')" class="btn-luxury-view shadow-sm">Xem Nhanh ğŸ‘ï¸</button>` : ''}</div><div class="space-y-2">`;
                    items.forEach(item => {
                        html += `<div class="invoice-card flex items-center gap-4 group ${item.everBlacklisted ? 'border-l-[12px] border-black' : ''}"><button onclick="db.collection(COLL).doc('${item.id}').update({completed: ${!item.completed}})" class="w-10 h-10 min-w-[40px] rounded-full border-2 flex items-center justify-center transition-all ${item.completed ? 'bg-rose-600 text-yellow-300 border-yellow-400' : 'border-rose-100 text-slate-300'}">${item.completed ? 'ğŸŒ¸' : 'ğŸ®'}</button><div class="flex-1"><span class="invoice-name ${item.completed ? 'line-through opacity-40' : ''}">${item.name}</span><p class="text-[9px] font-bold text-rose-300 uppercase">${item.pharmacy}</p></div><div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity shrink-0"><button onclick="addToBlacklist('${item.id}')" class="p-2 text-zinc-900">ğŸ““</button><button onclick="openEditForm('${item.id}')" class="p-2 text-amber-500">âœï¸</button><button onclick="deleteOne('${item.id}')" class="p-2 text-rose-600">ğŸ—‘ï¸</button></div></div>`;
                    }); html += `</div></div>`;
                }); html += `</div>`;
            }); display.innerHTML = html;
        }

        // CÃ¡c hÃ m phá»¥ trá»£ (Láº¥y tá»« code gá»‘c cá»§a báº¡n)
        async function handleSave() {
            const id = document.getElementById('formId').value; const rawNames = document.getElementById('formName').value.trim(); const date = document.getElementById('formDate').value; const link = document.getElementById('formLink').value.trim();
            if (!rawNames || !date) return;
            if (id) { await db.collection(COLL).doc(id).update({ name: rawNames, date, link }); showToast("ÄÃ£ cáº­p nháº­t! ğŸ§§"); }
            else { const nameList = rawNames.split('\n').filter(n => n.trim() !== ""); const batch = db.batch(); nameList.forEach((name, idx) => { const docRef = db.collection(COLL).doc(); batch.set(docRef, { name, date, link, pharmacy: currentPharmacy, completed: false, isDeleted: false, everBlacklisted: false, createdAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + idx * 1000)) }); }); await batch.commit(); showToast(`ÄÃ£ thÃªm thÃ nh cÃ´ng! ğŸ®`); }
            closeModal();
        }
        async function deleteOne(id) { if(confirm("XÃ³a hÃ³a Ä‘Æ¡n?")) { await db.collection(COLL).doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp() }); showToast("ÄÃ£ xÃ³a! ğŸ—‘ï¸"); } }
        async function addToBlacklist(id) { const i = allInvoices.find(it => it.id === id); if(confirm("Cáº­p nháº­t danh sÃ¡ch Ä‘en?")) await db.collection(COLL).doc(id).update({ everBlacklisted: !i.everBlacklisted }); }
        function updateBlacklistBadge(data) { const l = data.filter(i => i.everBlacklisted).length; const b = document.getElementById('blacklistBadge'); if(l > 0) { b.innerText = l; b.classList.remove('hidden'); } else b.classList.add('hidden'); }
        function togglePharmacy(name, tid) { currentPharmacy = name; ['tabTueThien', 'tabHungThinh', 'tabPhucAn'].forEach(id => document.getElementById(id).classList.remove('active')); document.getElementById('tab' + tid).classList.add('active'); applyFilters(); }
        function changeFilter(type) { currentFilter = type; applyFilters(); }
        function showToast(msg) { const c = document.getElementById('toastContainer'); const id = Date.now(); c.insertAdjacentHTML('beforeend', `<div id="${id}" class="bg-rose-900 text-white px-6 py-4 rounded-2xl shadow-xl font-bold">âœ¨ ${msg}</div>`); setTimeout(() => document.getElementById(id)?.remove(), 3000); }
        function closeModal() { document.getElementById('modalOverlay').classList.replace('flex', 'hidden'); }
        function openAddForm() { document.getElementById('formId').value = ''; document.getElementById('formName').value = ''; document.getElementById('formDate').value = new Date().toISOString().split('T')[0]; document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        function openEditForm(id) { const i = allInvoices.find(it => it.id === id); document.getElementById('formId').value = i.id; document.getElementById('formName').value = i.name; document.getElementById('formDate').value = i.date; document.getElementById('formLink').value = i.link || ''; document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        function closeForm(e) { if(e.target.id === 'modalOverlay') closeModal(); }
        function toggleBlacklistModal() { const m = document.getElementById('blacklistModal'); if(m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); renderBlacklist(); } else m.classList.replace('flex', 'hidden'); }
        function toggleRecycleBinModal() { const m = document.getElementById('recycleModal'); if(m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); db.collection(COLL).where('isDeleted', '==', true).limit(20).get().then(s => { document.getElementById('recycleDisplay').innerHTML = s.docs.map(doc => `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl mb-2"><span>${doc.data().name}</span><button onclick="db.collection(COLL).doc('${doc.id}').update({isDeleted: false})" class="text-blue-600 font-bold">PHá»¤C Há»’I</button></div>`).join(''); }); } else m.classList.replace('flex', 'hidden'); }
        async function exportUncompletedToExcel() { const data = allInvoices.filter(i => !i.completed && !i.isDeleted); if (!data.length) return; const ws = XLSX.utils.json_to_sheet(data.map(i => ({"NgÃ y": i.date, "NhÃ  Thuá»‘c": i.pharmacy, "NCC": i.name}))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "HOA DON"); XLSX.writeFile(wb, `HOA_DON_2026.xlsx`); }

        // Hiá»‡u á»©ng phÃ¡o hoa & hoa rÆ¡i (Giá»¯ tá»« code cá»§a báº¡n)
        const canvas = document.getElementById("fireworksCanvas"); const ctx = canvas.getContext("2d"); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        window.addEventListener('click', (e) => { if(!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) { /* Particle logic can be here */ } });
        setInterval(() => { const f = document.createElement('div'); f.className = 'flower'; f.innerHTML = `<img src="https://lutaweb.com/wp-content/uploads/2022/01/hoa-mai-1.png" style="width:20px">`; f.style.left = Math.random() * 100 + 'vw'; f.style.animationDuration = Math.random() * 5 + 7 + 's'; document.getElementById('flower-container').appendChild(f); setTimeout(() => f.remove(), 10000); }, 1500);
        
        window.onload = () => { togglePharmacy('NT Tuá»‡ Thiá»‡n', 'TueThien'); setTimeout(() => { document.getElementById('loadingIndicator').classList.add('hidden'); loadData(); }, 1000); };
    </script></body></html>
