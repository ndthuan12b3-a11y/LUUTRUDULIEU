<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H√≥a ƒê∆°n </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        #app-container { max-width: 900px; margin: 0 auto; padding: 1rem; border-radius: 1.5rem; background-color: #ffffff; }
        .modern-scroll::-webkit-scrollbar { width: 8px; }
        .modern-scroll::-webkit-scrollbar-thumb { background-color: #34d399; border-radius: 10px; }
        .sticky-plus { position: absolute; bottom: 20px; right: 20px; z-index: 20; }
        .recycle-bin-btn { position: fixed; bottom: 20px; right: 20px; z-index: 30; }
        @media (max-width: 640px) { #app-container { padding: 0.5rem; } h1 { font-size: 1.75rem !important; } }
        .filter-active { background-color: #059669 !important; color: white !important; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); }
        .invoice-item { border: none; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); }
        .invoice-item:hover { background-color: #f0fdf4 !important; transform: translateY(-2px); box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .pharmacy-content { border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-2 font-sans">
    <div id="toastContainer" class="fixed top-2 right-2 z-[100] space-y-2"></div>
    
    <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-70 z-[101] flex items-center justify-center">
        <div class="p-4 bg-green-100 rounded-lg shadow-xl flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
            <p class="text-green-800 font-semibold text-sm">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu tr·ª±c tuy·∫øn...</p>
        </div>
    </div>
    
    <div id="app-container" class="bg-white shadow-2xl rounded-2xl p-4 md:p-8 opacity-0 transition duration-500">
        <h1 class="text-2xl md:text-3xl font-extrabold text-center text-green-700 mb-6 border-b-2 pb-2">QU·∫¢N L√ù H√ìA ƒê∆†N </h1>
        
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl shadow-md">
            <h2 class="text-lg md:text-xl font-bold text-red-700 mb-3 flex items-center border-b pb-2">
                üî¥ H√ìA ƒê∆†N CH∆ØA HO√ÄN TH√ÄNH
            </h2>
            <div id="uncompletedOverviewContainer" class="p-3 bg-white rounded-lg border border-gray-100 h-32 md:h-40 overflow-y-auto modern-scroll">
                <div class="text-center text-gray-500 py-6">ƒêang t·∫£i danh s√°ch h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh...</div>
            </div>
        </div>
        
        <div class="flex justify-center border-b-2 border-gray-200 mb-6">
            <button id="tabTueThien" onclick="showPharmacy('NT Tu·ªá Thi·ªán', 'TueThien')" class="flex-1 py-3 px-2 text-sm font-semibold focus:outline-none transition duration-150 border-transparent hover:bg-gray-100 rounded-t-lg">
                <h3 class="font-bold text-base md:text-lg text-green-800 text-center">NT TU·ªÜ THI·ªÜN</h3>
            </button>
            <button id="tabHungThinh" onclick="showPharmacy('NT H∆∞ng Th·ªãnh', 'HungThinh')" class="flex-1 py-3 px-2 text-sm font-semibold focus:outline-none transition duration-150 border-transparent hover:bg-gray-100 rounded-t-lg">
                <h3 class="font-bold text-base md:text-lg text-green-800 text-center">NT H∆ØNG TH·ªäNH</h3>
            </button>
        </div>
        
        <div id="contentTueThien" class="pharmacy-content hidden bg-gray-50/50 shadow-inner relative">
            <div class="mb-4">
                <input type="text" id="searchTueThien" oninput="debounceSearch('NT Tu·ªá Thi·ªán', 'TueThien', this.value)"
                       placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n theo t√™n ho·∫∑c ng√†y..."
                       class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm shadow-sm">
            </div>
            <div class="flex space-x-2 mb-4">
                <button onclick="filterAndLoadInvoices('NT Tu·ªá Thi·ªán', 'all')" id="filterTueThienAll" class="px-4 py-1.5 text-xs font-semibold rounded-full filter-active">T·∫•t c·∫£ (G·∫ßn nh·∫•t)</button>
                <button onclick="filterAndLoadInvoices('NT Tu·ªá Thi·ªán', 'uncompleted')" id="filterTueThienUncompleted" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">Ch∆∞a xong</button>
                <button onclick="filterAndLoadInvoices('NT Tu·ªá Thi·ªán', 'completed')" id="filterTueThienCompleted" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">ƒê√£ xong</button>
            </div>
            <div id="displayTueThien" class="text-sm text-gray-800 bg-white p-3 rounded-xl font-sans h-64 md:h-80 overflow-y-auto border border-gray-200 modern-scroll shadow-inner">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>
            <div class="mt-4 pt-3 flex justify-end sticky-plus">
                <button onclick="toggleInvoiceForm('TueThien')" class="bg-green-600 text-white p-3 rounded-full shadow-xl hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
            <div id="formTueThien" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center p-4 rounded-lg z-10">
                <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-xs mx-auto border border-green-300">
                    <h4 id="formTitleTueThien" class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Th√™m H√≥a ƒê∆°n M·ªõi</h4>
                    <input type="hidden" id="inputTueThienId" value="">
                    <input type="text" id="inputTueThienName" placeholder="Nh·∫≠p t√™n H√≥a ƒë∆°n" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm">
                    <input type="date" id="inputTueThienDate" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm">
                    <input type="url" id="inputTueThienLink" placeholder="Nh·∫≠p Link (URL) ƒë√≠nh k√®m (T√πy ch·ªçn)" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-4 shadow-sm">
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="toggleInvoiceForm('TueThien')" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150 text-sm">H·ªßy</button>
                        <button id="saveButtonTueThien" onclick="saveInvoice('NT Tu·ªá Thi·ªán', 'inputTueThienName', 'inputTueThienDate', 'inputTueThienLink', 'inputTueThienId')" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 text-sm">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="contentHungThinh" class="pharmacy-content hidden bg-gray-50/50 shadow-inner relative">
            <div class="mb-4">
                <input type="text" id="searchHungThinh" oninput="debounceSearch('NT H∆∞ng Th·ªãnh', 'HungThinh', this.value)"
                       placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n theo t√™n ho·∫∑c ng√†y..."
                       class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm shadow-sm">
            </div>
            <div class="flex space-x-2 mb-4">
                <button onclick="filterAndLoadInvoices('NT H∆∞ng Th·ªãnh', 'all')" id="filterHungThinhAll" class="px-4 py-1.5 text-xs font-semibold rounded-full filter-active">T·∫•t c·∫£ (G·∫ßn nh·∫•t)</button>
                <button onclick="filterAndLoadInvoices('NT H∆∞ng Th·ªãnh', 'uncompleted')" id="filterHungThinhUncompleted" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">Ch∆∞a xong</button>
                <button onclick="filterAndLoadInvoices('NT H∆∞ng Th·ªãnh', 'completed')" id="filterHungThienCompleted" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">ƒê√£ xong</button>
            </div>
            <div id="displayHungThinh" class="text-sm text-gray-800 bg-white p-3 rounded-xl font-sans h-64 md:h-80 overflow-y-auto border border-gray-200 modern-scroll shadow-inner">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>
            <div class="mt-4 pt-3 flex justify-end sticky-plus">
                <button onclick="toggleInvoiceForm('HungThinh')" class="bg-green-600 text-white p-3 rounded-full shadow-xl hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
            <div id="formHungThinh" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center p-4 rounded-lg z-10">
                <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-xs mx-auto border border-green-300">
                    <h4 id="formTitleHungThinh" class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Th√™m H√≥a ƒê∆°n M·ªõi</h4>
                    <input type="hidden" id="inputHungThinhId" value="">
                    <input type="text" id="inputHungThinhName" placeholder="Nh·∫≠p t√™n H√≥a ƒë∆°n" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm">
                    <input type="date" id="inputHungThinhDate" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm">
                    <input type="url" id="inputHungThinhLink" placeholder="Nh·∫≠p Link (URL) ƒë√≠nh k√®m (T√πy ch·ªçn)" class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-4 shadow-sm">
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="toggleInvoiceForm('HungThinh')" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150 text-sm">H·ªßy</button>
                        <button id="saveButtonHungThinh" onclick="saveInvoice('NT H∆∞ng Th·ªãnh', 'inputHungThinhName', 'inputHungThinhDate', 'inputHungThinhLink', 'inputHungThinhId')" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 text-sm">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
        
        <button id="recycleBinButton" onclick="toggleRecycleBinModal()" class="recycle-bin-btn bg-red-600 text-white p-3 rounded-full shadow-xl hover:bg-red-700 transition duration-150 transform hover:scale-105">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
            </svg>
        </button>
        
        <div id="recycleBinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg mx-auto border border-red-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-700">üóëÔ∏è TH√ôNG R√ÅC</h3>
                    <button onclick="toggleRecycleBinModal()" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="searchRecycleBin" oninput="debounceSearch('RecycleBin', 'RecycleBin', this.value)"
                           placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n ƒë√£ x√≥a theo t√™n ho·∫∑c ng√†y..."
                           class="w-full p-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-sm shadow-sm">
                </div>
                <div id="displayRecycleBin" class="text-sm text-gray-800 bg-white p-3 rounded-xl font-sans h-64 md:h-80 overflow-y-auto border border-gray-200 modern-scroll shadow-inner">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>
        
        <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full mx-auto border border-red-300">
                <h3 class="text-xl font-bold text-red-700 mb-3 border-b pb-2">X√°c nh·∫≠n X√≥a H√≥a ƒê∆°n</h3>
                <p class="text-gray-700 text-sm mb-4" id="deleteConfirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y kh√¥ng?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150 text-sm">H·ªßy</button>
                    <button onclick="performDelete()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 text-sm">X√≥a Vƒ©nh Vi·ªÖn</button>
                </div>
            </div>
        </div>
        
        <footer class="mt-8 mb-2 text-center text-gray-500 text-xs font-medium">NƒêT</footer>

    <script>
        // =========================================================================
        // üü¢ C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C
        // =========================================================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyC737M2y1nwrGP48rEQ8dVhpV4DwUkysg",
            authDomain: "duanluutrunew.firebaseapp.com",
            projectId: "duanluutrunew",
            storageBucket: "duanluutrunew.appspot.com",
            messagingSenderId: "1008741702165",
            appId: "1:1008741702165:web:7e81901f4aac66cb9a0c1c",
            measurementId: "G-ZZ4EMWNN8VB"
        };
        
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();
        const COLLECTION_NAME = 'medx_invoices';

        const PHARMACY_MAP = { 'NT Tu·ªá Thi·ªán': 'TueThien', 'NT H∆∞ng Th·ªãnh': 'HungThinh', 'RecycleBin': 'RecycleBin' };
        const ONE_DAY_MS = 24 * 60 * 60 * 1000;
        const THREE_DAYS_MS = 3 * ONE_DAY_MS;
        const INVOICES_PER_PAGE = 20;

        let currentDeleteTarget = { pharmacyName: null, invoiceId: null, isPermanent: false };
        let currentInvoiceLists = {};
        let currentFilter = { 'NT Tu·ªá Thi·ªán': 'all', 'NT H∆∞ng Th·ªãnh': 'all', 'RecycleBin': 'all' };
        let unsubscribeListeners = {};
        let searchTimeout;

        // =========================================================================
        // üõ†Ô∏è H√ÄM TI·ªÜN √çCH CHUNG (UTILITIES)
        // =========================================================================
        function getCurrentDateKey() {
            const d = new Date();
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            let year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }

        function formatDate(dateKey) {
            if (!dateKey) return 'Kh√¥ng r√µ ng√†y';
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateKey;
        }

        function timeAgo(timestamp) {
            if (!timestamp) return 'Kh√¥ng r√µ';
            const date = timestamp.toDate();
            const seconds = Math.floor((Date.now() - date.getTime()) / 1000);

            let interval = seconds / 31536000; 
            if (interval > 1) { return Math.floor(interval) + " nƒÉm tr∆∞·ªõc"; }
            interval = seconds / 2592000; 
            if (interval > 1) { return Math.floor(interval) + " th√°ng tr∆∞·ªõc"; }
            interval = seconds / 86400; 
            if (interval > 1) { return Math.floor(interval) + " ng√†y tr∆∞·ªõc"; }
            interval = seconds / 3600; 
            if (interval > 1) { return Math.floor(interval) + " gi·ªù tr∆∞·ªõc"; }
            interval = seconds / 60; 
            if (interval > 1) { return Math.floor(interval) + " ph√∫t tr∆∞·ªõc"; }
            return "V·ª´a xong";
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const id = Date.now();
            let bgColor, icon;
            switch (type) {
                case 'error': bgColor = 'bg-red-600'; icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; break;
                case 'info': bgColor = 'bg-blue-600'; icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; break;
                case 'success': default: bgColor = 'bg-green-600'; icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; break;
            }
            const toastHtml = `
                <div id="toast-${id}" class="flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg opacity-0 transform translate-x-full transition-all duration-300">
                    ${icon}
                    <p class="ml-3">${message}</p>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(`toast-${id}`);
            setTimeout(() => { toastElement.style.transform = 'translateX(0)'; toastElement.style.opacity = '1'; }, 10);
            setTimeout(() => {
                toastElement.style.transform = 'translateX(150%)';
                toastElement.style.opacity = '0';
                setTimeout(() => { toastElement.remove(); }, 300);
            }, 3000);
        }

        function debounceSearch(pharmacyName, key, searchTerm) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchInvoices(pharmacyName, key, searchTerm);
            }, 300);
        }

        // =========================================================================
        // üü¢ C√ÅC H√ÄM X·ª¨ L√ù UI V√Ä LOGIC NGHI·ªÜP V·ª§
        // =========================================================================
        
        function updateFilterButtons(pharmacyKey, activeFilter) {
            const filters = ['All', 'Uncompleted', 'Completed'];
            filters.forEach(f => {
                const btn = document.getElementById(`filter${pharmacyKey}${f}`);
                if (btn) {
                    btn.classList.remove('filter-active', 'bg-green-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    if (f.toLowerCase() === activeFilter) {
                        btn.classList.add('filter-active', 'bg-green-600', 'text-white', 'shadow-md');
                        btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    }
                }
            });
        }
        
        function toggleInvoiceForm(key, reset = true) {
            const formElement = document.getElementById(`form${key}`);
            const nameInput = document.getElementById(`input${key}Name`);
            const dateInput = document.getElementById(`input${key}Date`);
            const linkInput = document.getElementById(`input${key}Link`);
            const idInput = document.getElementById(`input${key}Id`);
            const formTitle = document.getElementById(`formTitle${key}`);
            const saveButton = document.getElementById(`saveButton${key}`);

            if (formElement.classList.contains('hidden')) {
                formElement.classList.remove('hidden');
                if (reset) {
                    nameInput.value = '';
                    dateInput.value = getCurrentDateKey();
                    linkInput.value = '';
                    idInput.value = '';
                    formTitle.textContent = 'Th√™m H√≥a ƒê∆°n M·ªõi';
                    saveButton.textContent = 'L∆∞u';
                    saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    saveButton.classList.add('bg-green-600', 'hover:bg-green-700');
                }
                setTimeout(() => { nameInput.focus(); }, 50);
            } else {
                formElement.classList.add('hidden');
                nameInput.classList.remove('border-red-500', 'ring-red-500');
            }
        }

        function startEditInvoice(pharmacyName, invoiceId) {
            const list = currentInvoiceLists[pharmacyName] || [];
            const invoiceToEdit = list.find(c => c.id === invoiceId);
            if (!invoiceToEdit) return;
            const key = PHARMACY_MAP[pharmacyName];
            
            document.getElementById(`input${key}Name`).value = invoiceToEdit.name;
            document.getElementById(`input${key}Date`).value = invoiceToEdit.date;
            document.getElementById(`input${key}Link`).value = invoiceToEdit.link || '';
            document.getElementById(`input${key}Id`).value = invoiceToEdit.id;
            document.getElementById(`formTitle${key}`).textContent = 'Ch·ªânh S·ª≠a H√≥a ƒê∆°n';
            
            const saveButton = document.getElementById(`saveButton${key}`);
            saveButton.textContent = 'C·∫≠p Nh·∫≠t';
            saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            toggleInvoiceForm(key, false);
        }

        function showDeleteModal(pharmacyName, invoiceId, invoiceName, isPermanent = false) {
            currentDeleteTarget = { pharmacyName, invoiceId, isPermanent };
            const action = isPermanent ? 'x√≥a vƒ©nh vi·ªÖn' : 'x√≥a';
            document.getElementById('deleteConfirmMessage').innerHTML = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën **${action}** h√≥a ƒë∆°n **${invoiceName}**${isPermanent ? '' : ` kh·ªèi ${pharmacyName}`} kh√¥ng?`;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        function hideDeleteModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            currentDeleteTarget = { pharmacyName: null, invoiceId: null, isPermanent: false };
        }

        function toggleRecycleBinModal() {
            const modal = document.getElementById('recycleBinModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                loadRecycleBin();
            } else {
                modal.classList.add('hidden');
                if (unsubscribeListeners['RecycleBin']) {
                    unsubscribeListeners['RecycleBin']();
                }
            }
        }

        // =========================================================================
        // üöÄ FIREBASE ACTIONS
        // =========================================================================
        
        async function performDelete() {
            const { pharmacyName, invoiceId, isPermanent } = currentDeleteTarget;
            if (!pharmacyName || !invoiceId) {
                hideDeleteModal();
                return;
            }
            try {
                if (isPermanent) {
                    await db.collection(COLLECTION_NAME).doc(invoiceId).delete();
                    showToast(`ƒê√£ X√ìA Vƒ®NH VI·ªÑN h√≥a ƒë∆°n th√†nh c√¥ng!`, 'error');
                } else {
                    await db.collection(COLLECTION_NAME).doc(invoiceId).update({
                        isDeleted: true,
                        deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast(`ƒê√£ chuy·ªÉn h√≥a ƒë∆°n v√†o th√πng r√°c!`, 'info');
                }
            } catch (e) {
                console.error(`L·ªói ${isPermanent ? 'x√≥a vƒ©nh vi·ªÖn' : 'chuy·ªÉn v√†o th√πng r√°c'} Firestore:`, e);
                showToast(`L·ªói: Kh√¥ng th·ªÉ ${isPermanent ? 'x√≥a vƒ©nh vi·ªÖn' : 'chuy·ªÉn v√†o th√πng r√°c'} h√≥a ƒë∆°n.`, 'error');
            }
            hideDeleteModal();
        }

        async function restoreInvoice(invoiceId, invoiceName) {
            try {
                await db.collection(COLLECTION_NAME).doc(invoiceId).update({
                    isDeleted: false,
                    deletedAt: firebase.firestore.FieldValue.delete()
                });
                showToast(`ƒê√£ KH√îI PH·ª§C h√≥a ƒë∆°n "${invoiceName}" th√†nh c√¥ng!`, 'success');
            } catch (e) {
                console.error("L·ªói kh√¥i ph·ª•c Firestore:", e);
                showToast(`L·ªói: Kh√¥ng th·ªÉ kh√¥i ph·ª•c h√≥a ƒë∆°n.`, 'error');
            }
        }

        async function cancelGroupDeletion(pharmacyName, dateKey) {
            let list = currentInvoiceLists[pharmacyName] || [];
            const companiesInDay = list.filter(c => c.date === dateKey && c.readyForDeletionTimestamp);
            if (companiesInDay.length === 0) return;

            const batch = db.batch();
            companiesInDay.forEach(c => {
                const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                batch.update(docRef, { readyForDeletionTimestamp: firebase.firestore.FieldValue.delete(), completed: false });
            });

            try {
                await batch.commit();
                showToast(`ƒê√£ H·ª¶Y b·ªè vi·ªác x√≥a t·ª± ƒë·ªông cho ng√†y ${formatDate(dateKey)}.`, 'info');
            } catch (e) {
                console.error("L·ªói h·ªßy x√≥a nh√≥m Firestore:", e);
                showToast('L·ªói khi h·ªßy b·ªè x√≥a nh√≥m.', 'error');
            }
        }

        async function toggleCompletion(pharmacyName, invoiceId) {
            let list = currentInvoiceLists[pharmacyName] || [];
            const originalCompany = list.find(c => c.id === invoiceId);
            if (!originalCompany) return;

            const newCompletedState = !originalCompany.completed;
            const dateKey = originalCompany.date;
            let toastMessage = '';

            try {
                await db.collection(COLLECTION_NAME).doc(invoiceId).update({ completed: newCompletedState });
                toastMessage = newCompletedState ? `H√≥a ƒë∆°n ƒë√£ ho√†n th√†nh.` : `H√≥a ƒë∆°n "${originalCompany.name}" ch∆∞a ho√†n th√†nh.`;
            } catch (e) {
                showToast('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i Firestore.', 'error');
                return;
            }

            const currentList = currentInvoiceLists[pharmacyName];
            const companiesInDay = currentList.filter(c => c.date === dateKey);
            const allCompletedAfterUpdate = companiesInDay.every(c => c.completed);
            
            if (allCompletedAfterUpdate && newCompletedState) {
                const deletionTime = Date.now() + THREE_DAYS_MS;
                const batch = db.batch();
                
                companiesInDay.forEach(c => {
                    if (!c.readyForDeletionTimestamp || c.id === invoiceId) {
                         const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                         batch.update(docRef, { readyForDeletionTimestamp: deletionTime });
                    }
                });

                try {
                    await batch.commit();
                    toastMessage = `Ng√†y ${formatDate(dateKey)} ƒë√£ ho√†n th√†nh 100% v√† ƒë∆∞·ª£c ƒë√°nh d·∫•u x√≥a sau 3 ng√†y.`;
                } catch (e) {
                    showToast('L·ªói c·∫≠p nh·∫≠t nh√≥m x√≥a Firestore.', 'error');
                }
            } else if (!newCompletedState) {
                const batch = db.batch();
                companiesInDay.forEach(c => {
                    if (c.readyForDeletionTimestamp) {
                        const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                        batch.update(docRef, { readyForDeletionTimestamp: firebase.firestore.FieldValue.delete() });
                    }
                });
                try {
                    await batch.commit();
                    if (companiesInDay.some(c => c.readyForDeletionTimestamp)) { 
                         toastMessage = `ƒê√£ H·ª¶Y b·ªè vi·ªác x√≥a t·ª± ƒë·ªông cho ng√†y ${formatDate(dateKey)}.`;
                    }
                } catch (e) {
                    showToast('L·ªói h·ªßy x√≥a nh√≥m Firestore.', 'error');
                }
            }
            showToast(toastMessage, allCompletedAfterUpdate ? 'info' : 'success');
        }

        async function saveInvoice(pharmacyName, inputNameId, inputDateId, inputLinkId, inputIdId) {
            const companyInput = document.getElementById(inputNameId);
            const dateInput = document.getElementById(inputDateId);
            const linkInput = document.getElementById(inputLinkId);
            const idInput = document.getElementById(inputIdId);

            const invoiceId = idInput.value.trim();
            const invoiceName = companyInput.value.trim();
            const dateKey = dateInput.value.trim() || getCurrentDateKey();
            const invoiceLink = linkInput.value.trim();
            let successMessage;
            let savedSuccessfully = false;

            if (invoiceName === "") {
                companyInput.classList.add('border-red-500', 'ring-red-500');
                showToast('T√™n h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
                setTimeout(() => { companyInput.classList.remove('border-red-500', 'ring-red-500'); }, 1000);
                return;
            }

            const baseData = { name: invoiceName, date: dateKey, link: invoiceLink };

            if (invoiceId) { 
                try {
                    await db.collection(COLLECTION_NAME).doc(invoiceId).update(baseData);
                    successMessage = `H√≥a ƒë∆°n "${invoiceName}" ƒë√£ ƒë∆∞·ª£c C·∫¨P NH·∫¨T th√†nh c√¥ng!`;
                    savedSuccessfully = true;
                } catch (e) {
                    console.error("L·ªói c·∫≠p nh·∫≠t Firestore:", e);
                    showToast('L·ªói c·∫≠p nh·∫≠t Firestore.', 'error');
                }
            } else { 
                const newInvoiceData = {
                    ...baseData,
                    pharmacy: pharmacyName,
                    completed: false,
                    isDeleted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    await db.collection(COLLECTION_NAME).add(newInvoiceData);
                    successMessage = `ƒê√£ TH√äM h√≥a ƒë∆°n "${invoiceName}" m·ªõi.`;
                    savedSuccessfully = true;
                } catch (e) {
                    console.error("L·ªói th√™m m·ªõi Firestore:", e);
                    showToast('L·ªói th√™m m·ªõi Firestore.', 'error');
                }
            }

            if (savedSuccessfully) {
                const key = PHARMACY_MAP[pharmacyName];
                toggleInvoiceForm(key, true);
                showToast(successMessage, invoiceId ? 'info' : 'success');
            }
        }

        function filterAndLoadInvoices(pharmacyName, filterType) {
            const pharmacyKey = PHARMACY_MAP[pharmacyName];
            
            if (unsubscribeListeners[pharmacyName]) {
                 unsubscribeListeners[pharmacyName]();
            }
            
            currentFilter[pharmacyName] = filterType;
            updateFilterButtons(pharmacyKey, filterType);
            document.getElementById(`search${pharmacyKey}`).value = '';

            let query = db.collection(COLLECTION_NAME)
                .where('pharmacy', '==', pharmacyName)
                .where('isDeleted', '==', false)
                .orderBy('date', 'desc');

            if (filterType === 'completed') {
                query = query.where('completed', '==', true);
            } else if (filterType === 'uncompleted') {
                query = query.where('completed', '==', false);
            }
            
            query = query.limit(INVOICES_PER_PAGE);

            unsubscribeListeners[pharmacyName] = query.onSnapshot(snapshot => {
                const list = [];
                snapshot.forEach(doc => {
                    list.push({ id: doc.id, ...doc.data() });
                });
                
                currentInvoiceLists[pharmacyName] = list; 
                const filteredList = runAutoCleanup(list);
                renderPharmacyList(pharmacyName, `display${pharmacyKey}`, filteredList);
                renderUncompletedOverview();
            }, error => {
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    const indexLinkMatch = error.message.match(/https:\/\/[^\s]+/);
                    let errorMessage = `L·ªói l·ªçc d·ªØ li·ªáu. VUI L√íNG T·∫†O CH·ªà M·ª§C (INDEX) TRONG FIREBASE.`;
                    if (indexLinkMatch && indexLinkMatch[0]) {
                        errorMessage += ` <a href="${indexLinkMatch[0]}" target="_blank" class="font-bold text-red-100 underline hover:text-white">NH·∫§P V√ÄO ƒê√ÇY ƒê·ªÇ T·∫†O INDEX</a>`;
                    }
                    showToast(errorMessage, 'error');
                    console.error("L·ªói Firestore Index:", e);
                    return;
                }
                showToast(`L·ªói ƒë·ªìng b·ªô h√≥a d·ªØ li·ªáu.`, 'error');
            });
        }

        function loadRecycleBin() {
            if (unsubscribeListeners['RecycleBin']) {
                unsubscribeListeners['RecycleBin']();
            }
            
            currentFilter['RecycleBin'] = 'all';
            document.getElementById('searchRecycleBin').value = '';

            let query = db.collection(COLLECTION_NAME)
                .where('isDeleted', '==', true)
                .orderBy('deletedAt', 'desc')
                .limit(INVOICES_PER_PAGE);

            unsubscribeListeners['RecycleBin'] = query.onSnapshot(snapshot => {
                const list = [];
                snapshot.forEach(doc => {
                    list.push({ id: doc.id, ...doc.data() });
                });
                
                currentInvoiceLists['RecycleBin'] = list;
                renderRecycleBinList(list);
            }, error => {
                if (error.code === 'failed-precondition' && error.message.includes('index')) {
                    const indexLinkMatch = error.message.match(/https:\/\/[^\s]+/);
                    let errorMessage = `L·ªói l·ªçc d·ªØ li·ªáu th√πng r√°c. VUI L√íNG T·∫†O CH·ªà M·ª§C (INDEX) TRONG FIREBASE.`;
                    if (indexLinkMatch && indexLinkMatch[0]) {
                        errorMessage += ` <a href="${indexLinkMatch[0]}" target="_blank" class="font-bold text-red-100 underline hover:text-white">NH·∫§P V√ÄO ƒê√ÇY ƒê·ªÇ T·∫†O INDEX</a>`;
                    }
                    showToast(errorMessage, 'error');
                    console.error("L·ªói Firestore Index:", error);
                    return;
                }
                showToast(`L·ªói ƒë·ªìng b·ªô h√≥a d·ªØ li·ªáu th√πng r√°c.`, 'error');
            });
        }

        function searchInvoices(pharmacyName, key, searchTerm) {
            const list = currentInvoiceLists[pharmacyName] || [];
            const displayElementId = `display${key}`;
            const query = searchTerm.toLowerCase().trim();
            let listToRender = list;

            if (query.length > 0) {
                if (unsubscribeListeners[pharmacyName]) {
                     unsubscribeListeners[pharmacyName]();
                }
                
                listToRender = list.filter(invoice =>
                    invoice.name.toLowerCase().includes(query) || 
                    formatDate(invoice.date).includes(query)
                );
            } else {
                if (pharmacyName === 'RecycleBin') {
                    loadRecycleBin();
                } else {
                    filterAndLoadInvoices(pharmacyName, currentFilter[pharmacyName]);
                }
                return;
            }
            
            if (pharmacyName === 'RecycleBin') {
                renderRecycleBinList(listToRender, true);
            } else {
                renderPharmacyList(pharmacyName, displayElementId, listToRender, true);
            }
        }

        function runAutoCleanup(list) {
            const now = Date.now();
            const batch = db.batch();
            let hasDeletions = false;

            const filteredList = list.filter(c => {
                if (c.readyForDeletionTimestamp && now > c.readyForDeletionTimestamp && !c.isDeleted) {
                    const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                    batch.update(docRef, {
                        isDeleted: true,
                        deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    hasDeletions = true;
                    return false;
                }
                return true;
            });

            if (hasDeletions) {
                batch.commit().catch(e => {
                    console.error("L·ªói t·ª± ƒë·ªông chuy·ªÉn v√†o th√πng r√°c:", e);
                    showToast('L·ªói t·ª± ƒë·ªông chuy·ªÉn h√≥a ƒë∆°n v√†o th√πng r√°c.', 'error');
                });
            }

            return filteredList;
        }

        function renderPharmacyList(pharmacyName, displayElementId, list, isSearchMode = false) {
            const displayArea = document.getElementById(displayElementId);
            const todayKey = getCurrentDateKey();
                        
            if (list.length === 0) {
                displayArea.innerHTML = `<div class="text-gray-500 text-center py-2">${isSearchMode ? 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p.' : 'Danh s√°ch h√≥a ƒë∆°n r·ªóng. H√£y nh·∫•n d·∫•u + ƒë·ªÉ th√™m h√≥a ƒë∆°n m·ªõi.'}</div>`;
                return;
            }

            const groupedByDate = list.reduce((acc, entry) => {
                const date = entry.date || 'Kh√¥ng r√µ ng√†y';
                if (!acc[date]) { acc[date] = []; }
                acc[date].push(entry);
                return acc;
            }, {});

            let html = isSearchMode ? '' : `<div class="p-2 text-sm font-bold text-gray-700 border-b border-gray-200 mb-4">T·ªïng c·ªông: ${list.length} H√≥a ƒë∆°n</div>`;
            const sortedDates = Object.keys(groupedByDate).sort().reverse();

            sortedDates.forEach(dateKey => {
                const companiesOnDate = groupedByDate[dateKey];
                const formattedDate = formatDate(dateKey);
                const isToday = dateKey === todayKey;
                const isDeletionPending = companiesOnDate[0].readyForDeletionTimestamp ? true : false;
                                
                let groupStatusText = '';
                if (isDeletionPending) {
                    const timeToDeletion = companiesOnDate[0].readyForDeletionTimestamp - Date.now();
                    const daysLeft = Math.ceil(timeToDeletion / ONE_DAY_MS);
                                        
                    groupStatusText = `<span class="ml-2 text-xs font-medium text-red-600 bg-red-100 px-2 py-0.5 rounded-full flex items-center">
                            <span class="mr-2">üóëÔ∏è S·∫Ω chuy·ªÉn v√†o th√πng r√°c sau ${daysLeft} ng√†y</span>
                            <button onclick="cancelGroupDeletion('${pharmacyName}', '${dateKey}')"
                                class="text-red-700 hover:text-white hover:bg-red-500 rounded-full transition duration-150 px-1 font-bold">
                                ‚ùå H·ªßy
                            </button>
                        </span>`;
                }
                                
                const totalInDay = companiesOnDate.length;
                const completedInDay = companiesOnDate.filter(c => c.completed).length;
                const progressText = `<span class="font-extrabold">${completedInDay}</span>/<span class="font-bold">${totalInDay}</span> ƒë√£ xong`;
                const progressColor = (completedInDay === totalInDay) ? 'text-green-700' : 'text-orange-500';

                html += `<div class="mt-4 border-l-4 ${isToday ? 'border-red-600' : 'border-green-600'} pl-3 py-2 ${isToday ? 'bg-red-50/70' : 'bg-green-50/70'} rounded-r-lg shadow-sm flex justify-between items-center">
                             <h4 class="font-bold text-base text-gray-800">
                                 üìÖ NG√ÄY ${formattedDate}
                                 <span class="${progressColor} ml-2 text-sm">(${progressText})</span>
                             </h4>
                             ${groupStatusText}
                         </div>
                         <ul class="space-y-1 mt-2 mb-4">`;
                                
                companiesOnDate.forEach((company) => {
                    const { completed: isCompleted, id: invoiceId, name: invoiceName, link: invoiceLink, createdAt } = company;
                    const completionIcon = isCompleted 
                         ? `<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>` 
                         : `<svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    
                    const timeCreated = createdAt ? ` (${timeAgo(createdAt)})` : '';
                    
                    html += `<li id="company-${invoiceId}" class="invoice-item flex items-center p-3 rounded-lg transition duration-100 ${isCompleted ? 'bg-green-50/40' : 'bg-white'}">
                                <button onclick="toggleCompletion('${pharmacyName}', '${invoiceId}')"
                                         class="p-1 mr-3 rounded-full flex-shrink-0 transition duration-150 transform hover:scale-110 ${isCompleted ? 'bg-green-600 shadow-md' : 'bg-gray-200'}">
                                    ${completionIcon}
                                </button>
                                <span class="flex-grow text-gray-700 ${isCompleted ? 'text-gray-500' : 'font-semibold'} flex items-center text-base">
                                    üìÑ ${invoiceName} <span class="text-xs text-gray-400 ml-2">${timeCreated}</span>
                                    ${invoiceLink ? `
                                        <a href="${invoiceLink}" target="_blank" rel="noopener noreferrer"
                                           title="M·ªü Link H√≥a ƒê∆°n ƒê√≠nh K√®m"
                                           class="ml-2 text-blue-500 hover:text-blue-700 transition duration-150 transform hover:scale-110">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-7-5l-5 5m0 0h4m-4 0v4m-1-5l5-5" />
                                            </svg>
                                        </a>
                                    ` : ''}
                                </span>
                                <div class="flex space-x-2 ml-4 flex-shrink-0">
                                    <button onclick="startEditInvoice('${pharmacyName}', '${invoiceId}')"
                                             title="Ch·ªânh s·ª≠a H√≥a ƒë∆°n"
                                            class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="showDeleteModal('${pharmacyName}', '${invoiceId}', '${invoiceName}')"
                                            title="Chuy·ªÉn v√†o Th√πng r√°c"
                                             class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
                                        </svg>
                                    </button>
                                </div>
                             </li>`;
                });
                html += `</ul>`;
            });
            displayArea.innerHTML = html;
        }

        function renderRecycleBinList(list, isSearchMode = false) {
            const displayArea = document.getElementById('displayRecycleBin');
                        
            if (list.length === 0) {
                displayArea.innerHTML = `<div class="text-gray-500 text-center py-2">${isSearchMode ? 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p trong th√πng r√°c.' : 'Th√πng r√°c tr·ªëng.'}</div>`;
                return;
            }

            const groupedByDate = list.reduce((acc, entry) => {
                const date = entry.date || 'Kh√¥ng r√µ ng√†y';
                if (!acc[date]) { acc[date] = []; }
                acc[date].push(entry);
                return acc;
            }, {});

            let html = isSearchMode ? '' : `<div class="p-2 text-sm font-bold text-gray-700 border-b border-gray-200 mb-4">T·ªïng c·ªông: ${list.length} H√≥a ƒë∆°n ƒë√£ x√≥a</div>`;
            const sortedDates = Object.keys(groupedByDate).sort().reverse();

            sortedDates.forEach(dateKey => {
                const companiesOnDate = groupedByDate[dateKey];
                const formattedDate = formatDate(dateKey);

                html += `<div class="mt-4 border-l-4 border-red-600 pl-3 py-2 bg-red-50/70 rounded-r-lg shadow-sm">
                             <h4 class="font-bold text-base text-gray-800">üìÖ NG√ÄY ${formattedDate}</h4>
                         </div>
                         <ul class="space-y-1 mt-2 mb-4">`;
                                
                companiesOnDate.forEach((company) => {
                    const { id: invoiceId, name: invoiceName, link: invoiceLink, deletedAt, pharmacy } = company;
                    const timeDeleted = deletedAt ? ` (X√≥a ${timeAgo(deletedAt)})` : '';
                    
                    html += `<li id="company-${invoiceId}" class="invoice-item flex items-center p-3 rounded-lg transition duration-100 bg-white">
                                <span class="flex-grow text-gray-700 font-semibold flex items-center text-base">
                                    üìÑ ${invoiceName} <span class="text-xs text-gray-400 ml-2">${timeDeleted}</span>
                                    ${invoiceLink ? `
                                        <a href="${invoiceLink}" target="_blank" rel="noopener noreferrer"
                                           title="M·ªü Link H√≥a ƒê∆°n ƒê√≠nh K√®m"
                                           class="ml-2 text-blue-500 hover:text-blue-700 transition duration-150 transform hover:scale-110">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-7-5l-5 5m0 0h4m-4 0v4m-1-5l5-5" />
                                            </svg>
                                        </a>
                                    ` : ''}
                                </span>
                                <div class="flex space-x-2 ml-4 flex-shrink-0">
                                    <button onclick="restoreInvoice('${invoiceId}', '${invoiceName}')"
                                            title="Kh√¥i ph·ª•c H√≥a ƒë∆°n"
                                            class="text-green-500 hover:text-green-700 p-1 rounded-full hover:bg-green-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                    </button>
                                    <button onclick="showDeleteModal('${pharmacy}', '${invoiceId}', '${invoiceName}', true)"
                                            title="X√≥a Vƒ©nh vi·ªÖn"
                                            class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
                                        </svg>
                                    </button>
                                </div>
                             </li>`;
                });
                html += `</ul>`;
            });
            displayArea.innerHTML = html;
        }

        function renderUncompletedOverview() {
            const container = document.getElementById('uncompletedOverviewContainer');
            let allUncompleted = [];

            Object.keys(PHARMACY_MAP).forEach(pharmacyName => {
                if (pharmacyName === 'RecycleBin') return;
                const list = currentInvoiceLists[pharmacyName] || [];
                const uncompleted = list.filter(item => !item.completed && !item.readyForDeletionTimestamp && !item.isDeleted);
                uncompleted.forEach(item => {
                    allUncompleted.push({ ...item, pharmacy: pharmacyName });
                });
            });

            if (allUncompleted.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-6">üéâ Tuy·ªát v·ªùi! Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o c·∫ßn x·ª≠ l√Ω.</div>`;
                return;
            }

            allUncompleted.sort((a, b) => {
                const timeA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                const timeB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                return timeA - timeB;
            });

            let html = `<ul class="space-y-1">`;
            const uncompletedIcon = `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

            allUncompleted.forEach(invoice => {
                const invoiceDate = new Date(invoice.date + 'T00:00:00');
                const dateDiffMs = Date.now() - invoiceDate.getTime();
                const daysOld = Math.floor(dateDiffMs / ONE_DAY_MS);
                const timeElapsed = timeAgo(invoice.createdAt);

                let statusClass = 'text-gray-700';
                let statusEmoji = '‚ö†Ô∏è';
                let badgeClass = 'bg-gray-100 text-gray-700';

                if (daysOld >= 5) {
                    statusClass = 'text-red-700 font-extrabold';
                    statusEmoji = 'üö®';
                    badgeClass = 'bg-red-200 text-red-800';
                } else if (daysOld >= 2) {
                    statusClass = 'text-orange-600 font-semibold';
                    statusEmoji = 'üü†';
                    badgeClass = 'bg-orange-100 text-orange-700';
                }

                const key = PHARMACY_MAP[invoice.pharmacy];
                const actionButton = `<button onclick="showPharmacy('${invoice.pharmacy}', '${key}');"
                                    class="text-blue-500 hover:text-blue-700 font-semibold transition duration-150 text-xs px-2 py-1 bg-blue-50 rounded-md">
                                    Xem chi ti·∫øt
                                </button>`;

                html += `
                    <li class="p-2 border-b border-gray-100 flex justify-between items-center bg-white hover:bg-red-50 transition duration-100 rounded-md shadow-xs">
                        <button onclick="toggleCompletion('${invoice.pharmacy}', '${invoice.id}')"
                            title="ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh"
                            class="p-1 mr-3 rounded-full transition duration-150 transform hover:scale-110 bg-gray-100 flex-shrink-0">
                            ${uncompletedIcon}
                        </button>
                        <div class="flex-grow flex justify-between items-center">
                            <span class="${statusClass} text-sm flex items-center">
                                ${statusEmoji}
                                <span class="ml-2">${invoice.name}</span>
                            </span>
                            <div class="flex items-center flex-shrink-0">
                                <span class="text-xs font-medium ${badgeClass} px-2 py-1 rounded-full whitespace-nowrap flex-shrink-0 mr-3">
                                    ${invoice.pharmacy} | L·∫≠p ng√†y: ${formatDate(invoice.date)}
                                </span>
                                <span class="text-xs font-bold text-red-600 mr-3 whitespace-nowrap" title="Th·ªùi gian ch∆∞a ho√†n th√†nh k·ªÉ t·ª´ khi ƒë∆∞·ª£c th√™m v√†o h·ªá th·ªëng">
                                    ‚è≥ ${timeElapsed}
                                </span>
                                ${actionButton}
                            </div>
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;
            container.innerHTML = html;
        }

        function showPharmacy(pharmacyName, key) {
            const tabElement = document.getElementById(`tab${key}`);
            const allKeys = Object.values(PHARMACY_MAP).filter(k => k !== 'RecycleBin');
            allKeys.forEach(k => {
                document.getElementById(`content${k}`)?.classList.add('hidden');
                document.getElementById(`form${k}`)?.classList.add('hidden');
                const t = document.getElementById(`tab${k}`);
                if(t) {
                    t.classList.remove('bg-white', 'border-green-500', 'border-b-2');
                    t.classList.add('text-gray-600', 'hover:bg-gray-100', 'border-transparent');
                    t.style.marginBottom = '0';
                }
            });

            const contentElement = document.getElementById(`content${key}`);
            contentElement.classList.remove('hidden');
            tabElement.classList.add('bg-white', 'border-green-500', 'border-b-2');
            tabElement.classList.remove('text-gray-600', 'hover:bg-gray-100', 'border-transparent');
            tabElement.style.marginBottom = '-2px';
            
            filterAndLoadInvoices(pharmacyName, currentFilter[pharmacyName] || 'all');
        }

        function initApp() {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('app-container').classList.remove('opacity-0');
            
            Object.keys(PHARMACY_MAP).forEach(key => {
                if (key !== 'RecycleBin') {
                    filterAndLoadInvoices(key, currentFilter[key] || 'all');
                }
            });

            showPharmacy('NT Tu·ªá Thi·ªán', 'TueThien');
            document.addEventListener('DOMContentLoaded', initApp, { once: true });
        }

        document.addEventListener('DOMContentLoaded', initApp, { once: true });
    </script>
</body>
</html>

