<!DOCTYPE html><html lang="vi"><head>    <meta charset="UTF-8">    <meta name="robots" content="noindex">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>H·ªá Th·ªëng H√≥a ƒê∆°n - Luxury T·∫øt 2026 (Link Grouping)</title>        <script src="https://cdn.tailwindcss.com"></script>    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Pattaya&family=Mr+Dafoe&family=Mea+Culpa&display=swap" rel="stylesheet">        <style>        /* --- 1. GI·ªÆ NGUY√äN CSS GIAO DI·ªÜN CH√çNH --- */        :root { --ruby: #9f1239; --gold: #fbbf24; --smooth: cubic-bezier(0.4, 0, 0.2, 1); }        body { background: #fffcf5; font-family: 'Plus Jakarta Sans', sans-serif; color: #4c0519; overflow-x: hidden; cursor: url('https://img.icons8.com/external-flaticons-lineal-color-flat-icons/32/external-fireworks-chinese-new-year-flaticons-lineal-color-flat-icons.png'), auto; }                canvas#fireworksCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        /* --- 2. GI·ªÆ NGUY√äN CSS L·ªíNG ƒê√àN --- */        .truongdevs-lantern-container{ position:fixed; top:-5px; z-index:9000; pointer-events:none; transform-origin:top center; animation:truongdevs-swing 4s ease-in-out infinite alternate; }        .left-side{left:40px} .right-side{right:40px;animation-delay:1s}        .truongdevs-string{ width:3px; height:80px; margin:0 auto; background:linear-gradient(to bottom,#cfc09f,#b8860b); position:relative; }        .truongdevs-string::before{ content:''; position:absolute; top:-6px; left:-4px; width:12px; height:12px; border-radius:50%; background:radial-gradient(circle,#ffd700,#b8860b); box-shadow:0 1px 2px rgba(0,0,0,.35); }        .truongdevs-lantern{ position:relative; pointer-events:auto; cursor: pointer; }        .truongdevs-lantern-body{ width:120px; height:100px; border-radius:35px; background:radial-gradient(circle at 30% 30%,#ff5a5a,#7a0000); display:flex; align-items:center; justify-content:center; box-shadow: inset 0 0 12px rgba(255,200,120,.35), 0 0 10px rgba(255,140,60,.25), 0 0 20px rgba(255,120,40,.15); animation:truongdevs-glow 3s ease-in-out infinite; }        .truongdevs-lantern-text{ font-family:'Mr Dafoe',cursive; font-size:36px; color:#ffd700; text-shadow:0 0 4px rgba(255,220,150,.8); }        .truongdevs-lantern-top, .truongdevs-lantern-bottom{ width:60px; height:12px; margin:0 auto; background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b); }        .truongdevs-lantern-top{margin-bottom:-5px} .truongdevs-lantern-bottom{margin-top:-5px}        .truongdevs-tassels{ position:absolute; top:100%; left:50%; transform:translateX(-50%); text-align:center; transition:opacity .25s ease; }        .truongdevs-tassels span{ display:inline-block; width:4px; height:50px; margin:0 2px; background:linear-gradient(to bottom,#d2302c,#ff4d4d); border-radius:0 0 5px 5px; animation:truongdevs-tassel-sway 2s ease-in-out infinite alternate; }        .truongdevs-tassels span:nth-child(2){height:65px}        .truongdevs-scroll{ position:absolute; top:100%; left:50%; transform:translateX(-50%); width:0; opacity:0; background: linear-gradient(to right,rgba(255,255,255,.06),rgba(0,0,0,.15),rgba(255,255,255,.06)), #8b0000; border:2px solid #d4af37; box-shadow: 0 0 0 3px #8b0000, 0 0 0 5px #d4af37, 0 6px 12px rgba(0,0,0,.4); border-radius:2px; overflow:visible; transition:width .45s ease, opacity .25s ease; z-index: 9001; }        .truongdevs-scroll-text{ font-family:'Mea Culpa',cursive; font-size:24px; color:#ffd700; display:flex; flex-direction:column; align-items:center; gap:2px; padding:10px 5px 15px; line-height:1.1; text-shadow:0 1px 1px rgba(0,0,0,.6); white-space: nowrap; overflow: hidden; }        .truongdevs-lantern:hover .truongdevs-tassels{opacity:0}        .truongdevs-lantern:hover .truongdevs-scroll{width:80px;opacity:1}        @keyframes truongdevs-swing{ from{transform:rotate(-3deg)} to{transform:rotate(3deg)} }        @keyframes truongdevs-tassel-sway{ from{transform:rotate(2deg)} to{transform:rotate(-2deg)} }        @keyframes truongdevs-glow{ 0%{filter:brightness(1)} 50%{filter:brightness(1.15)} 100%{filter:brightness(1)} }
        /* --- 3. UI H√ìA ƒê∆†N & TABS GI·ªÆ NGUY√äN --- */        .app-gradient { background: radial-gradient(circle at 50% 0%, #dc2626, #991b1b, #450a0a); position: relative; border-bottom: 5px solid transparent; border-image: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) 1; box-shadow: 0 20px 60px rgba(153, 27, 27, 0.4); }                .lantern-chain { position: absolute; top: -5px; width: 100%; display: flex; justify-content: space-evenly; z-index: 20; pointer-events: none; }        .lantern-chain-item { width: 40px; height: 50px; background: radial-gradient(circle at 30% 30%, #ff6b6b, #991b1b); border-radius: 10px; position: relative; animation: small-swing 4s ease-in-out infinite; box-shadow: 0 10px 20px rgba(220, 38, 38, 0.5); border: 1px solid #fcd34d; }        .lantern-chain-item::before { content: ''; position: absolute; top: -20px; left: 50%; width: 1px; height: 20px; background: #fcd34d; }        @keyframes small-swing { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .tab-btn { font-weight: 700; color: rgba(255,255,255,0.7); transition: all 0.4s var(--smooth); }        .tab-btn.active { background: white; border-radius: 16px; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }        #tabTueThien.active { color: #2563eb !important; } #tabHungThinh.active { color: #059669 !important; } #tabPhucAn.active { color: #db2777 !important; }
        .luxury-panel { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(25px); border-radius: 3rem; border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 30px 80px -10px rgba(159, 18, 57, 0.15); }        
        /* C·∫£i ti·∫øn: Box ch·ª©a nh√≥m theo Link */        .link-batch-box { background: white; border: 1px solid #ffe4e6; border-radius: 28px; padding: 1.5rem; margin-bottom: 2rem; position: relative; border-left: 8px solid #fcd34d; transition: all 0.3s; }        .link-batch-box:hover { border-color: #fbbf24; box-shadow: 0 10px 30px rgba(159, 18, 57, 0.05); }        .invoice-card { background: #fffcf5; border: 1px solid #fff1f2; border-radius: 18px; transition: all 0.4s var(--smooth); margin-bottom: 0.75rem; }        .invoice-card:hover { transform: scale(1.01); background: white; }
        .btn-add { background: linear-gradient(135deg, #e11d48, #be123c); border: 2px solid #fcd34d; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.5); }        .flower { position: fixed; pointer-events: none; z-index: 50; animation: fall linear infinite; }        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }        .tet-title { font-family: 'Pattaya', cursive; text-shadow: 0 4px 15px rgba(0,0,0,0.3); }        .dash-item { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; transition: transform 0.3s; }        .timeline-month-header { position: sticky; top: -1px; z-index: 40; background: #fffcf5; padding: 15px 0; border-bottom: 2px dashed #fecaca; margin-bottom: 20px; }    </style></head><body>    <canvas id="fireworksCanvas"></canvas>
    <div class="truongdevs-lantern-container left-side">        <div class="truongdevs-string"></div>        <div class="truongdevs-lantern">            <div class="truongdevs-lantern-top"></div>            <div class="truongdevs-lantern-body"><span class="truongdevs-lantern-text">Xu√¢n</span></div>            <div class="truongdevs-lantern-bottom"></div>            <div class="truongdevs-tassels"><span></span><span></span><span></span></div>            <div class="truongdevs-scroll"><div class="truongdevs-scroll-text"><span>Ch√∫c</span><span>T·∫øt</span><span>ƒê·∫øn</span><span>TrƒÉm</span><span>ƒêi·ªÅu</span><span>Nh∆∞</span><span>√ù</span></div></div>        </div>    </div>    <div class="truongdevs-lantern-container right-side">        <div class="truongdevs-string"></div>        <div class="truongdevs-lantern">            <div class="truongdevs-lantern-top"></div>            <div class="truongdevs-lantern-body"><span class="truongdevs-lantern-text">2026</span></div>            <div class="truongdevs-lantern-bottom"></div>            <div class="truongdevs-tassels"><span></span><span></span><span></span></div>            <div class="truongdevs-scroll"><div class="truongdevs-scroll-text"><span>M·ª´ng</span><span>Xu√¢n</span><span>Sang</span><span>V·∫°n</span><span>S·ª±</span><span>Th√†nh</span><span>C√¥ng</span></div></div>        </div>    </div>
    <div id="flower-container"></div>    <div id="loadingIndicator" class="fixed inset-0 z-[10000] flex items-center justify-center bg-white">        <div class="w-16 h-16 border-4 border-orange-100 border-t-red-600 rounded-full animate-spin"></div>    </div>    <div id="toastContainer" class="fixed top-8 right-8 z-[10001] space-y-4 w-80 pointer-events-none"></div>

    <nav class="app-gradient pt-16 pb-28 px-4">        <div class="lantern-chain">            <div class="lantern-chain-item"></div><div class="lantern-chain-item"></div>            <div class="lantern-chain-item hidden md:block"></div><div class="lantern-chain-item"></div>        </div>        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] left-[-40px] w-48 opacity-90 pointer-events-none z-10 filter drop-shadow-2xl">        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] right-[-40px] w-48 opacity-90 pointer-events-none z-10 transform scale-x-[-1] filter drop-shadow-2xl">
        <div class="max-w-4xl mx-auto flex flex-col items-center relative z-20">            <h1 class="text-5xl md:text-6xl font-800 text-white mb-10 tet-title uppercase italic tracking-wide cursor-pointer">H√ìA ƒê∆†N 2026</h1>                                <div class="w-full max-w-xl bg-black/20 backdrop-blur-md p-2 rounded-[2rem] flex items-center border border-white/10 shadow-2xl">                <button id="tabTueThien" onclick="togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Tu·ªá Thi·ªán</button>                <button id="tabHungThinh" onclick="togglePharmacy('NT H∆∞ng Th·ªãnh', 'HungThinh');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">H∆∞ng Th·ªãnh</button>                <button id="tabPhucAn" onclick="togglePharmacy('NT Ph√∫c An', 'PhucAn');" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Ph√∫c An</button>            </div>
            <div class="w-full max-w-xl mt-10 grid grid-cols-3 gap-6 text-white text-center">                <div class="dash-item p-4"><p id="totalCount" class="text-3xl font-900 text-yellow-300">0</p><p class="text-[10px] font-bold uppercase opacity-70">T·ªïng Kho üßß</p></div>                <div class="dash-item p-4"><p id="completedCount" class="text-3xl font-900 text-green-300">0</p><p class="text-[10px] font-bold uppercase opacity-70">ƒê√£ Xong üå∏</p></div>                <div class="dash-item p-4"><p id="pendingCount" class="text-3xl font-900 text-orange-200">0</p><p class="text-[10px] font-bold uppercase opacity-70">C√≤n L·∫°i üèÆ</p></div>            </div>        </div>    </nav>
    <main class="max-w-4xl mx-auto px-4 -mt-20 relative z-30 pb-32">        <div class="luxury-panel p-8 md:p-12 min-h-[500px]">            <div class="flex flex-col md:flex-row gap-5 mb-10">                <div class="relative flex-1">                    <input type="text" id="mainSearch" oninput="applyFilters()" placeholder="T√¨m ki·∫øm nh√† cung c·∫•p..." class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-rose-50/60 border-2 border-transparent focus:bg-white outline-none font-bold text-slate-700 shadow-inner transition-all"><span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl">üîç</span>                </div>                <div class="flex bg-rose-50/80 p-2 rounded-[1.5rem] border border-rose-100 shadow-inner">                    <button id="filterAll" onclick="changeFilter('all')" class="px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase transition-all">T·∫•t c·∫£</button>                    <button id="filterUncompleted" onclick="changeFilter('uncompleted')" class="px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase transition-all hover:text-rose-700">Ch∆∞a xong</button>                </div>            </div>            <div id="invoiceDisplay" class="space-y-8"></div>        </div>    </main>
    <div class="fixed bottom-10 right-10 flex flex-col gap-5 items-end z-[9000]">        <button onclick="cleanupCompleted();" class="w-16 h-16 bg-white border border-rose-100 text-rose-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 active:rotate-12 transition-all" title="D·ªçn d·∫πp danh s√°ch ƒë√£ xong">üßπ</button>        <button onclick="toggleBlacklistModal();" class="w-16 h-16 bg-zinc-900 border border-zinc-700 text-white rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all relative" title="S·ªï ƒêen T√†i Ch√≠nh"><span>üìì</span><span id="blacklistBadge" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full font-bold hidden">0</span></button>        <button onclick="exportUncompletedToExcel();" class="w-16 h-16 bg-white border border-emerald-100 text-emerald-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all" title="Xu·∫•t Excel">üí∞</button>        <button onclick="toggleRecycleBinModal();" class="w-16 h-16 bg-white border border-orange-100 text-orange-500 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all" title="Th√πng r√°c">üéÅ</button>        <button onclick="openAddForm();" class="w-20 h-20 btn-add text-white rounded-[1.8rem] flex items-center justify-center hover:rotate-12 hover:scale-110 active:scale-90 transition-all shadow-2xl text-5xl">üèÆ</button>    </div>
    <div id="blacklistModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4 transition-opacity" onclick="toggleBlacklistModal(event)">        <div class="modal-content bg-zinc-900 w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col shadow-2xl border border-zinc-700" onclick="event.stopPropagation()">            <div class="flex justify-between items-center mb-6 text-white italic"><h3 class="text-2xl font-900 flex items-center gap-2">Danh S√°ch ƒêen üìì</h3><button onclick="toggleBlacklistModal()" class="w-10 h-10 flex items-center justify-center bg-zinc-800 rounded-full text-white hover:bg-red-600 transition-colors">‚úï</button></div>            <div id="blacklistDisplay" class="flex-1 overflow-y-auto space-y-3 px-1 custom-scrollbar"></div>        </div>    </div>
    <div id="modalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4 transition-opacity" onclick="closeForm(event)">        <div class="modal-content bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl border-t-[12px] border-rose-600" onclick="event.stopPropagation()">            <h3 id="modalTitle" class="text-3xl font-900 italic uppercase mb-8 text-rose-600 text-center">H√≥a ƒê∆°n üßß</h3>            <input type="hidden" id="formId">            <div class="space-y-6">                <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-2 tracking-widest">T√™n nh√† cung c·∫•p (M·ªói d√≤ng 1 nh√†)</label><textarea id="formName" rows="4" class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-lg text-slate-800 transition-colors"></textarea></div>                <div><label class="block text-[11px] font-bold text-rose-600 uppercase mb-2 ml-2 tracking-widest">Ng√†y h√≥a ƒë∆°n</label><input type="date" id="formDate" class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-slate-800 transition-colors"></div>                <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-2 tracking-widest">Link t√†i li·ªáu (D√πng ƒë·ªÉ t√°ch ƒë·ª£t)</label><input type="url" id="formLink" placeholder="https://..." class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-sm text-blue-600 transition-colors"></div>                <div class="flex gap-4 pt-4"><button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400 uppercase text-xs hover:bg-slate-50 rounded-xl transition-colors">H·ªßy B·ªè</button><button onclick="handleSave()" class="flex-[2] py-4 bg-gradient-to-r from-rose-600 to-red-500 text-white font-bold rounded-2xl shadow-xl uppercase text-xs hover:shadow-2xl active:scale-95 transition-all">L∆∞u D·ªØ Li·ªáu</button></div>            </div>        </div>    </div>
    <div id="recycleModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[10000] hidden items-center justify-center p-4 transition-opacity" onclick="toggleRecycleBinModal(event)">        <div class="modal-content bg-white w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col shadow-2xl" onclick="event.stopPropagation()">            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-900 text-red-700 uppercase italic">Th√πng R√°c üóëÔ∏è</h3><button onclick="toggleRecycleBinModal()" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 font-black hover:bg-red-50 hover:text-red-500 transition-colors">‚úï</button></div>            <div id="recycleDisplay" class="flex-1 overflow-y-auto space-y-3 px-1"></div>        </div>    </div>

    <script>
        // --- GI·ªÆ NGUY√äN TO√ÄN B·ªò LOGIC FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyC737M2y1nwrGP48rEQ8dVhpV4DwUkysg", authDomain: "duanluutrunew.firebaseapp.com", projectId: "duanluutrunew", storageBucket: "duanluutrunew.appspot.com", messagingSenderId: "1008741702165", appId: "1:1008741702165:web:7e81901f4aac66cb9a0c1c" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore(); const COLL = 'medx_invoices';
        let currentPharmacy = 'NT Tu·ªá Thi·ªán', currentFilter = 'all', allInvoices = [], unsub = null;

        function getBlacklist(data) { return data.filter(item => item.everBlacklisted === true); }
        async function addToBlacklist(id) { 
            const item = allInvoices.find(i => i.id === id);
            if(confirm(item.everBlacklisted ? "G·ª° kh·ªèi S·ªï ƒêen?" : "ƒê∆∞a v√†o S·ªï ƒêen?")) { 
                await db.collection(COLL).doc(id).update({ everBlacklisted: !item.everBlacklisted }); 
                showToast("ƒê√£ c·∫≠p nh·∫≠t S·ªï ƒêen! üìì"); 
            } 
        }
        function updateBlacklistBadge(data) { const list = getBlacklist(data); const b = document.getElementById('blacklistBadge'); if (list.length > 0) { b.innerText = list.length; b.classList.remove('hidden'); } else b.classList.add('hidden'); }
        function renderBlacklist() { 
            const area = document.getElementById('blacklistDisplay'); const list = getBlacklist(allInvoices); 
            if (!list.length) { area.innerHTML = '<p class="text-center py-10 text-zinc-500 italic">Tr·ªëng ‚ú®</p>'; return; } 
            area.innerHTML = list.map(item => `<div class="flex items-center justify-between p-5 bg-zinc-800/50 rounded-2xl border border-zinc-700 mb-3"><div class="flex-1"><p class="font-bold text-red-500 text-lg leading-tight">${item.name}</p><p class="text-[10px] text-zinc-400 mt-1">Ng√†y: ${item.date}</p></div><div class="flex gap-2"><button onclick="addToBlacklist('${item.id}')" class="p-3 bg-zinc-700 text-zinc-300 rounded-xl hover:text-white">üîì</button></div></div>`).join(''); 
        }

        function loadData() { 
            if (unsub) unsub(); 
            unsub = db.collection(COLL).where('pharmacy', '==', currentPharmacy).orderBy('date', 'desc').onSnapshot(snap => { 
                allInvoices = []; snap.forEach(doc => allInvoices.push({ id: doc.id, ...doc.data() })); 
                allInvoices.sort((a, b) => {
                    if (b.date !== a.date) return b.date.localeCompare(a.date);
                    return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                });
                applyFilters(); 
                if (!document.getElementById('blacklistModal').classList.contains('hidden')) renderBlacklist(); 
            }); 
        }
        
        async function handleSave() { 
            const id = document.getElementById('formId').value; const rawNames = document.getElementById('formName').value.trim(); const date = document.getElementById('formDate').value; const link = document.getElementById('formLink').value.trim(); 
            if (!rawNames || !date) return; 
            if (id) { await db.collection(COLL).doc(id).update({ name: rawNames, date, link }); showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng! üßß"); } 
            else {
                const nameList = rawNames.split(/[\n,]+/).map(n => n.trim()).filter(n => n !== "");
                const batch = db.batch(); const now = new Date();
                nameList.forEach((name, idx) => {
                    const docRef = db.collection(COLL).doc();
                    const staggeredTime = new firebase.firestore.Timestamp(Math.floor(now.getTime()/1000) + idx, 0);
                    batch.set(docRef, { name, date, link, pharmacy: currentPharmacy, completed: false, isDeleted: false, everBlacklisted: false, createdAt: staggeredTime });
                });
                await batch.commit(); showToast(`ƒê√£ th√™m th√†nh c√¥ng! üèÆ`);
            } closeModal(); 
        }

        function applyFilters() { 
            const searchVal = document.getElementById('mainSearch').value.toLowerCase(); 
            let filtered = allInvoices.filter(i => i.isDeleted !== true); 
            if (currentFilter === 'uncompleted') filtered = filtered.filter(i => !i.completed); 
            if (searchVal) filtered = filtered.filter(i => i.name.toLowerCase().includes(searchVal)); 
            renderInvoices(filtered); 
            document.getElementById('totalCount').innerText = allInvoices.filter(i => i.isDeleted !== true).length; 
            document.getElementById('completedCount').innerText = allInvoices.filter(i => i.completed && i.isDeleted !== true).length; 
            document.getElementById('pendingCount').innerText = allInvoices.filter(i => !i.completed && i.isDeleted !== true).length; 
            updateBlacklistBadge(allInvoices); 
        }

        // --- N√ÇNG C·∫§P H√ÄM RENDER: PH√ÇN LO·∫†I THEO NG√ÄY -> LINK ---
        function renderInvoices(data) {
            const display = document.getElementById('invoiceDisplay');
            if (!data.length) { display.innerHTML = '<p class="text-center py-20 opacity-40 font-black uppercase text-rose-800 tracking-[0.3em]">Danh s√°ch tr·ªëng</p>'; return; }
            
            // B∆∞·ªõc 1: Nh√≥m theo Th√°ng/NƒÉm
            const monthGroups = data.reduce((acc, item) => {
                const d = new Date(item.date);
                const key = `Th√°ng ${d.getMonth() + 1} nƒÉm ${d.getFullYear()}`;
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});

            let html = '';
            Object.keys(monthGroups).forEach(monthKey => {
                html += `
                <div class="month-block mb-10">
                    <div class="timeline-month-header flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üìÖ</span>
                            <h2 class="text-xl font-900 text-rose-800 uppercase italic">${monthKey}</h2>
                        </div>
                    </div>
                `;

                // B∆∞·ªõc 2: Nh√≥m theo ng√†y trong th√°ng ƒë√≥
                const dateGroups = monthGroups[monthKey].reduce((acc, item) => { acc[item.date] = acc[item.date] || []; acc[item.date].push(item); return acc; }, {});
                
                Object.keys(dateGroups).sort().reverse().forEach(dateStr => {
                    const d = new Date(dateStr);
                    html += `
                    <div class="mb-12">
                        <div class="sticky top-[60px] z-10 bg-[#fffcf5]/95 backdrop-blur-md py-4 flex items-center justify-between border-b-2 border-orange-100 mb-6">
                            <div class="flex items-center gap-4">
                                <div class="bg-white border border-rose-200 rounded-2xl p-1 shadow-sm text-center min-w-[60px]">
                                    <div class="text-[10px] font-black text-rose-400 uppercase">Ng√†y</div>
                                    <div class="text-2xl font-900 text-rose-800">${d.getDate()}</div>
                                </div>
                                <div><p class="text-xl font-800 text-rose-900">${d.toLocaleDateString('vi-VN', { weekday: 'long' })}</p></div>
                            </div>
                        </div>`;

                    // B∆∞·ªõc 3: TRONG M·ªñI NG√ÄY, NH√ìM THEO LINK (URL)
                    const linkGroups = dateGroups[dateStr].reduce((acc, item) => {
                        const linkKey = (item.link && item.link.trim() !== "") ? item.link : "no_link";
                        if (!acc[linkKey]) acc[linkKey] = [];
                        acc[linkKey].push(item);
                        return acc;
                    }, {});

                    Object.keys(linkGroups).forEach(linkKey => {
                        const items = linkGroups[linkKey];
                        const isNoLink = linkKey === "no_link";
                        
                        html += `
                        <div class="link-batch-box">
                            <div class="flex items-center justify-between mb-4 pb-2 border-b border-rose-50">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">${isNoLink ? 'üì¶' : 'üìÇ'}</span>
                                    <span class="text-[10px] font-900 uppercase tracking-widest ${isNoLink ? 'text-slate-400' : 'text-blue-600'}">
                                        ${isNoLink ? 'H√≥a ƒë∆°n l·∫ª' : 'DANH S√ÅCH H√ìA ƒê∆†N'}
                                    </span>
                                </div>
                                ${!isNoLink ? `<a href="${linkKey}" target="_blank" class="bg-blue-600 text-white text-[9px] font-bold px-3 py-1 rounded-full hover:bg-blue-700 transition-colors shadow-sm">Xem H√≥a ƒê∆°n ‚Üó</a>` : ''}
                            </div>
                            
                            <div class="space-y-2">`;
                            
                        items.forEach(item => {
                            html += `
                            <div class="invoice-card flex items-center justify-between p-4 group ${item.everBlacklisted ? 'border-red-500 border-l-[12px]' : ''}">
                                <div class="flex items-center gap-4">
                                    <button onclick="db.collection(COLL).doc('${item.id}').update({completed: ${!item.completed}})" class="w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all ${item.completed ? 'bg-rose-600 text-yellow-300 border-yellow-400 rotate-[360deg]' : 'border-rose-100 text-slate-300'}">
                                        ${item.completed ? 'üå∏' : 'üèÆ'}
                                    </button>
                                    <div>
                                        <p class="font-bold ${item.completed ? 'line-through opacity-40 text-slate-500' : 'text-slate-800'}">${item.name}</p>
                                        <p class="text-[9px] font-bold text-rose-300 uppercase">${item.pharmacy}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="addToBlacklist('${item.id}')" class="p-2 bg-zinc-100 text-zinc-900 rounded-lg hover:scale-110 transition-transform">üìì</button>
                                    <button onclick="openEditForm('${item.id}')" class="p-2 bg-amber-50 text-amber-500 rounded-lg">‚úèÔ∏è</button>
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    });
                    html += `</div>`;
                });
                html += `</div>`;
            }); display.innerHTML = html;
        }

        // --- GI·ªÆ NGUY√äN TO√ÄN B·ªò LOGIC C√íN L·∫†I ---
        async function cleanupCompleted() { 
            const list = allInvoices.filter(i => i.completed && !i.everBlacklisted && i.isDeleted !== true); 
            if (list.length && confirm(`D·ªçn d·∫πp ${list.length} m·ª•c ƒë√£ xong?`)) { 
                const batch = db.batch(); list.forEach(i => batch.update(db.collection(COLL).doc(i.id), { isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp() })); await batch.commit(); showToast("ƒê√£ d·ªçn d·∫πp h·ªá th·ªëng! üßπ");
            }
        }
        function finalDelete(id) { if(confirm("X√ìA Vƒ®NH VI·ªÑN?")) { db.collection(COLL).doc(id).delete(); showToast("ƒê√£ x√≥a! üíÄ"); } }
        function togglePharmacy(name, tid) { currentPharmacy = name; ['tabTueThien', 'tabHungThinh', 'tabPhucAn'].forEach(id => document.getElementById(id).classList.remove('active')); document.getElementById('tab' + tid).classList.add('active'); loadData(); }
        function changeFilter(type) { currentFilter = type; applyFilters(); }
        function openAddForm() { document.getElementById('formId').value = ''; document.getElementById('formName').value = ''; document.getElementById('formLink').value = ''; document.getElementById('formDate').value = new Date().toLocaleDateString('en-CA'); document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        function openEditForm(id) { const i = allInvoices.find(it => it.id === id); document.getElementById('formId').value = i.id; document.getElementById('formName').value = i.name; document.getElementById('formDate').value = i.date; document.getElementById('formLink').value = i.link || ''; document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        function closeModal() { document.getElementById('modalOverlay').classList.replace('flex', 'hidden'); }
        function toggleBlacklistModal(e) { const m = document.getElementById('blacklistModal'); if (e && e.target.id !== 'blacklistModal' && !e.target.closest('button[title="S·ªï ƒêen T√†i Ch√≠nh"]')) return; if (m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); renderBlacklist(); } else m.classList.replace('flex', 'hidden'); }
        function toggleRecycleBinModal(e) { const m = document.getElementById('recycleModal'); if (e && e.target.id !== 'recycleModal' && !e.target.closest('button[title="Th√πng r√°c"]')) return; if (m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); db.collection(COLL).where('isDeleted', '==', true).orderBy('deletedAt', 'desc').limit(20).onSnapshot(s => { document.getElementById('recycleDisplay').innerHTML = s.docs.map(doc => `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl mb-2"><span>${doc.data().name}</span><button onclick="db.collection(COLL).doc('${doc.id}').update({isDeleted:false})" class="text-blue-500 font-bold">Ph·ª•c h·ªìi</button></div>`).join(''); }); } else m.classList.replace('flex', 'hidden'); }
        function showToast(msg) { const c = document.getElementById('toastContainer'); const id = Date.now(); c.insertAdjacentHTML('beforeend', `<div id="${id}" class="bg-rose-900 text-white px-6 py-4 rounded-2xl shadow-xl border-l-4 border-yellow-400 font-bold">‚ú® ${msg}</div>`); setTimeout(() => document.getElementById(id)?.remove(), 3000); }
        function closeForm(e) { if(e.target.id === 'modalOverlay') closeModal(); }
        function exportUncompletedToExcel() { const d = allInvoices.filter(i => !i.completed && i.isDeleted !== true); if (!d.length) return; const ws = XLSX.utils.json_to_sheet(d.map(i => ({ "Ng√†y": i.date, "Nh√† Cung C·∫•p": i.name, "Nh√† Thu·ªëc": i.pharmacy, "Link": i.link || "" }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "CongNo"); XLSX.writeFile(wb, `CONG_NO_2026.xlsx`); }
        
        // --- GI·ªÆ NGUY√äN FIREWORKS ---
        const canvas = document.getElementById("fireworksCanvas"); const ctx = canvas.getContext("2d"); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        class Particle { constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.size = Math.random() * 5 + 1; this.speedX = Math.random() * 6 - 3; this.speedY = Math.random() * 6 - 3; this.life = Math.random() * 30 + 50; } update() { this.x += this.speedX; this.y += this.speedY; this.size *= 0.95; this.life--; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); } }
        const particles = []; function createFireworks(x, y) { const colors = ["#ff5733", "#33ff57", "#5733ff", "#ffd700", "#ff0000"]; for (let i = 0; i < 40; i++) { particles.push(new Particle(x, y, colors[Math.floor(Math.random() * colors.length)])); } }
        function animate() { ctx.clearRect(0, 0, canvas.width, canvas.height); particles.forEach((p, i) => { if (p.life <= 0 || p.size <= 0.1) particles.splice(i, 1); else { p.update(); p.draw(); } }); requestAnimationFrame(animate); } animate();
        window.addEventListener('click', (e) => { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') createFireworks(e.clientX, e.clientY); });
        setInterval(() => { const f = document.createElement('div'); f.className = 'flower'; f.innerHTML = `<img src="https://lutaweb.com/wp-content/uploads/2022/01/hoa-mai-1.png" style="width:${Math.random()*20+10}px">`; f.style.left = Math.random() * 100 + 'vw'; f.style.animationDuration = Math.random() * 5 + 7 + 's'; document.getElementById('flower-container').appendChild(f); setTimeout(() => f.remove(), 10000); }, 1000);
        window.onload = () => { setTimeout(() => { document.getElementById('loadingIndicator').classList.add('hidden'); togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien'); }, 1000); };
    </script></body></html>
