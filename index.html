<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H√≥a ƒê∆°n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <link rel="manifest" href="data:application/manifest+json,{'name': 'Qu·∫£n L√Ω H√≥a ƒê∆°n','short_name': 'H√≥a ƒê∆°n','start_url': '.','display': 'standalone','background_color': '#ffffff','theme_color': '#10b981','icons': [{'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTIiIGZpbGw9IiMxMGI5ODEiLz4KPHBhdGggZD0iTTEyIDhDNi4zIDggMiAxMi4zIDIgMTZTMi4zIDI0IDYgMjRIMTRDMjEuNyAyNCAyNCAyMC43IDI0IDE2UzIxLjcgMTYgMTYgMTZDNjMuNyAxNiAyIDExLjcgMiA2UzYuMyA4IDEyIDh6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K', 'sizes': '24x24', 'type': 'image/svg+xml'}]}">
    <style>
        /* CSS g·ªëc v√† c√°c n√¢ng c·∫•p Dark Mode, Responsive Design ƒë∆∞·ª£c gi·ªØ nguy√™n */
        #app-container { max-width: 900px; margin: 0 auto; padding: 1rem; border-radius: 1.5rem; background-color: #ffffff; }
        .modern-scroll::-webkit-scrollbar { width: 8px; }
        .modern-scroll::-webkit-scrollbar-thumb { background-color: #34d399; border-radius: 10px; }
        .sticky-plus { position: absolute; bottom: 20px; right: 20px; z-index: 20; }
        .recycle-bin-btn { position: fixed; bottom: 20px; right: 20px; z-index: 30; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #1f2937; color: #f9fafb; }
            #app-container { background-color: #1f2937; border: 1px solid #374151; }
            .invoice-item { background-color: #374151; color: #f9fafb; border-color: #4b5563; }
            .invoice-item:hover { background-color: #4b5563 !important; }
            .pharmacy-content { background-color: #1f2937; border-color: #4b5563; }
            #displayTueThien, #displayHungThinh, #displayRecycleBin { background-color: #374151; color: #f9fafb; border-color: #4b5563; }
            .uncompleted-overview { background-color: #374151; border-color: #4b5563; }
            .dark .text-gray-500 { color: #9ca3af !important; }
            .dark .bg-white, .dark .bg-gray-50 { background-color: #374151 !important; }
        }

        .uncompleted-overview { 
            height: auto; 
            min-height: 300px; 
            max-height: 50vh; 
            transition: max-height 0.3s ease, min-height 0.3s ease; 
        }
        .uncompleted-overview.collapsed { 
            min-height: 150px; 
            max-height: 25vh; 
        }
        .filter-active { background-color: #059669 !important; color: white !important; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); }
        .invoice-item { border: none; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); }
        .invoice-item:hover { background-color: #f0fdf4 !important; transform: translateY(-2px); box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .pharmacy-content { border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; }
        .pagination button.active { @apply bg-green-600 text-white; }
        #darkModeToggle { position: fixed; top: 20px; right: 20px; z-index: 40; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-2 font-sans">
    <div id="loadingSkeleton" class="animate-pulse space-y-3 p-3 hidden">
        <div class="h-4 bg-gray-200 rounded w-full dark:bg-gray-600"></div>
        <div class="h-4 bg-gray-200 rounded w-5/6 dark:bg-gray-600"></div>
        <div class="h-4 bg-gray-200 rounded w-4/6 dark:bg-gray-600"></div>
    </div>
    
    <button id="darkModeToggle" onclick="toggleDarkMode()" aria-label="Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô t·ªëi" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-2 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150">
        <svg id="darkModeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
    </button>
    <div id="toastContainer" class="fixed top-2 right-2 z-[100] space-y-2"></div>
    <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-70 dark:bg-gray-900 dark:bg-opacity-80 z-[101] flex items-center justify-center">
        <div class="p-4 bg-green-100 dark:bg-green-800 rounded-lg shadow-xl flex items-center space-x-3 animate-pulse">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 dark:border-green-300"></div>
            <p class="text-green-800 dark:text-green-200 font-semibold text-sm">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Firestore...</p>
        </div>
    </div>
    <div id="app-container" class="bg-white shadow-2xl rounded-2xl p-4 md:p-8 opacity-0 transition duration-500">
        <h1 class="text-2xl md:text-3xl font-extrabold text-center text-green-700 dark:text-green-400 mb-6 border-b-2 pb-2">QU·∫¢N L√ù H√ìA ƒê∆†N </h1>
        <div class="mb-6 p-4 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-xl shadow-md">
            <h2 class="text-lg md:text-xl font-bold text-red-700 dark:text-red-400 mb-3 flex items-center border-b pb-2">
                üî¥ H√ìA ƒê∆†N CH∆ØA HO√ÄN TH√ÄNH
            </h2>
            <div id="uncompletedOverviewContainer" class="p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-100 dark:border-gray-600 overflow-y-auto modern-scroll uncompleted-overview">
                <div class="text-center text-gray-500 py-6">ƒêang t·∫£i danh s√°ch h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh...</div>
            </div>
        </div>
        <div class="flex tab-buttons justify-center border-b-2 border-gray-200 dark:border-gray-700 mb-6">
            <button id="tabTueThien" onclick="togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien')" aria-label="·∫®n/Hi·ªán NT Tu·ªá Thi·ªán" class="flex-1 py-3 px-2 text-sm font-semibold focus:outline-none transition duration-150 border-transparent hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg tab-collapsed">
                <h3 class="font-bold text-base md:text-lg text-green-800 dark:text-green-300 text-center flex items-center justify-center">
                    NT TU·ªÜ THI·ªÜN
                    <svg class="tab-icon ml-2 h-4 w-4 text-green-600 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </h3>
            </button>
            <button id="tabHungThinh" onclick="togglePharmacy('NT H∆∞ng Th·ªãnh', 'HungThinh')" aria-label="·∫®n/Hi·ªán NT H∆∞ng Th·ªãnh" class="flex-1 py-3 px-2 text-sm font-semibold focus:outline-none transition duration-150 border-transparent hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg tab-collapsed">
                <h3 class="font-bold text-base md:text-lg text-green-800 dark:text-green-300 text-center flex items-center justify-center">
                    NT H∆ØNG TH·ªäNH
                    <svg class="tab-icon ml-2 h-4 w-4 text-green-600 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </h3>
            </button>
        </div>
        <div id="contentTueThien" class="pharmacy-content hidden bg-gray-50/50 dark:bg-gray-800/50 shadow-inner relative">
            <div class="mb-4">
                <input type="text" id="searchTueThien" oninput="debounceSearch('NT Tu·ªá Thi·ªán', 'TueThien', this.value)" aria-label="T√¨m ki·∫øm h√≥a ƒë∆°n"
                       placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n theo t√™n ho·∫∑c ng√†y..."
                       class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm shadow-sm dark:bg-gray-600 dark:text-gray-100">
            </div>
            <div class="flex filter-buttons space-x-2 mb-4">
                <button onclick="filterAndLoadInvoices('NT Tu·ªá Thi·ªán', 'all')" id="filterTueThienAll" aria-label="L·ªçc t·∫•t c·∫£ h√≥a ƒë∆°n" class="px-4 py-1.5 text-xs font-semibold rounded-full filter-active">T·∫•t c·∫£ (G·∫ßn nh·∫•t)</button>
                <button onclick="filterAndLoadInvoices('NT Tu·ªá Thi·ªán', 'uncompleted')" id="filterTueThienUncompleted" aria-label="L·ªçc h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500">Ch∆∞a xong</button>
                <button onclick="filterAndLoadInvoices('NT Tu·ªá Thi·ªán', 'completed')" id="filterTueThienCompleted" aria-label="L·ªçc h√≥a ƒë∆°n ƒë√£ ho√†n th√†nh" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500">ƒê√£ xong</button>
            </div>
            <div id="displayTueThien" class="text-sm text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700 p-3 rounded-xl font-sans h-64 md:h-80 lg:h-96 overflow-y-auto border border-gray-200 dark:border-gray-600 modern-scroll shadow-inner">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>
            <div id="paginationTueThien" class="pagination hidden"></div>
            <div class="mt-4 pt-3 flex justify-end sticky-plus">
                <button onclick="toggleInvoiceForm('TueThien')" aria-label="Th√™m h√≥a ƒë∆°n m·ªõi" class="bg-green-600 text-white p-3 rounded-full shadow-xl hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
            <div id="formTueThien" class="hidden absolute inset-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4 rounded-lg z-10">
                <div class="bg-white dark:bg-gray-700 p-6 rounded-2xl shadow-2xl w-full max-w-xs sm:max-w-sm mx-auto border border-green-300 dark:border-green-600">
                    <h4 id="formTitleTueThien" class="text-lg font-bold mb-4 text-gray-700 dark:text-gray-200 border-b pb-2">Th√™m H√≥a ƒê∆°n M·ªõi</h4>
                    <input type="hidden" id="inputTueThienId" value="">
                    <input type="text" id="inputTueThienName" placeholder="Nh·∫≠p t√™n H√≥a ƒë∆°n" aria-label="T√™n h√≥a ƒë∆°n" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm dark:bg-gray-600 dark:text-gray-100">
                    <input type="date" id="inputTueThienDate" aria-label="Ng√†y h√≥a ƒë∆°n" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm dark:bg-gray-600 dark:text-gray-100">
                    <input type="url" id="inputTueThienLink" placeholder="Nh·∫≠p Link (URL) ƒë√≠nh k√®m (T√πy ch·ªçn)" aria-label="Link ƒë√≠nh k√®m" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-4 shadow-sm dark:bg-gray-600 dark:text-gray-100">
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="toggleInvoiceForm('TueThien')" aria-label="H·ªßy th√™m/s·ª≠a" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-150 text-sm">H·ªßy</button>
                        <button id="saveButtonTueThien" onclick="saveInvoice('NT Tu·ªá Thi·ªán', 'inputTueThienName', 'inputTueThienDate', 'inputTueThienLink', 'inputTueThienId')" aria-label="L∆∞u h√≥a ƒë∆°n" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 text-sm">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="contentHungThinh" class="pharmacy-content hidden bg-gray-50/50 dark:bg-gray-800/50 shadow-inner relative">
            <div class="mb-4">
                <input type="text" id="searchHungThinh" oninput="debounceSearch('NT H∆∞ng Th·ªãnh', 'HungThinh', this.value)" aria-label="T√¨m ki·∫øm h√≥a ƒë∆°n"
                       placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n theo t√™n ho·∫∑c ng√†y..."
                       class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm shadow-sm dark:bg-gray-600 dark:text-gray-100">
            </div>
            <div class="flex filter-buttons space-x-2 mb-4">
                <button onclick="filterAndLoadInvoices('NT H∆∞ng Th·ªãnh', 'all')" id="filterHungThinhAll" aria-label="L·ªçc t·∫•t c·∫£ h√≥a ƒë∆°n" class="px-4 py-1.5 text-xs font-semibold rounded-full filter-active">T·∫•t c·∫£ (G·∫ßn nh·∫•t)</button>
                <button onclick="filterAndLoadInvoices('NT H∆∞ng Th·ªãnh', 'uncompleted')" id="filterHungThinhUncompleted" aria-label="L·ªçc h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500">Ch∆∞a xong</button>
                <button onclick="filterAndLoadInvoices('NT H∆∞ng Th·ªãnh', 'completed')" id="filterHungThinhCompleted" aria-label="L·ªçc h√≥a ƒë∆°n ƒë√£ ho√†n th√†nh" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500">ƒê√£ xong</button>
            </div>
            <div id="displayHungThinh" class="text-sm text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700 p-3 rounded-xl font-sans h-64 md:h-80 lg:h-96 overflow-y-auto border border-gray-200 dark:border-gray-600 modern-scroll shadow-inner">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>
            <div id="paginationHungThinh" class="pagination hidden"></div>
            <div class="mt-4 pt-3 flex justify-end sticky-plus">
                <button onclick="toggleInvoiceForm('HungThinh')" aria-label="Th√™m h√≥a ƒë∆°n m·ªõi" class="bg-green-600 text-white p-3 rounded-full shadow-xl hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
            <div id="formHungThinh" class="hidden absolute inset-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm flex items-center justify-center p-4 rounded-lg z-10">
                <div class="bg-white dark:bg-gray-700 p-6 rounded-2xl shadow-2xl w-full max-w-xs sm:max-w-sm mx-auto border border-green-300 dark:border-green-600">
                    <h4 id="formTitleHungThinh" class="text-lg font-bold mb-4 text-gray-700 dark:text-gray-200 border-b pb-2">Th√™m H√≥a ƒê∆°n M·ªõi</h4>
                    <input type="hidden" id="inputHungThinhId" value="">
                    <input type="text" id="inputHungThinhName" placeholder="Nh·∫≠p t√™n H√≥a ƒë∆°n" aria-label="T√™n h√≥a ƒë∆°n" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm dark:bg-gray-600 dark:text-gray-100">
                    <input type="date" id="inputHungThinhDate" aria-label="Ng√†y h√≥a ƒë∆°n" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3 shadow-sm dark:bg-gray-600 dark:text-gray-100">
                    <input type="url" id="inputHungThinhLink" placeholder="Nh·∫≠p Link (URL) ƒë√≠nh k√®m (T√πy ch·ªçn)" aria-label="Link ƒë√≠nh k√®m" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-4 shadow-sm dark:bg-gray-600 dark:text-gray-100">
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="toggleInvoiceForm('HungThinh')" aria-label="H·ªßy th√™m/s·ª≠a" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-150 text-sm">H·ªßy</button>
                        <button id="saveButtonHungThinh" onclick="saveInvoice('NT H∆∞ng Th·ªãnh', 'inputHungThinhName', 'inputHungThinhDate', 'inputHungThinhLink', 'inputHungThinhId')" aria-label="L∆∞u h√≥a ƒë∆°n" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 text-sm">L∆∞u</button>
                    </div>
                </div>
            </div>
        </div>
        <button id="recycleBinButton" onclick="toggleRecycleBinModal()" aria-label="M·ªü th√πng r√°c" class="recycle-bin-btn bg-red-600 text-white p-3 rounded-full shadow-xl hover:bg-red-700 transition duration-150 transform hover:scale-105">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
            </svg>
        </button>
        <div id="recycleBinModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-gray-900/80 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-700 p-6 rounded-2xl shadow-2xl w-full max-w-lg mx-auto border border-red-300 dark:border-red-600">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-700 dark:text-red-400">üóëÔ∏è TH√ôNG R√ÅC</h3>
                    <button onclick="toggleRecycleBinModal()" aria-label="ƒê√≥ng th√πng r√°c" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="searchRecycleBin" oninput="debounceSearch('RecycleBin', 'RecycleBin', this.value)" aria-label="T√¨m ki·∫øm trong th√πng r√°c"
                           placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n ƒë√£ x√≥a theo t√™n ho·∫∑c ng√†y..."
                           class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-sm shadow-sm dark:bg-gray-600 dark:text-gray-100">
                </div>
                <div id="displayRecycleBin" class="text-sm text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700 p-3 rounded-xl font-sans h-64 md:h-80 lg:h-96 overflow-y-auto border border-gray-200 dark:border-gray-600 modern-scroll shadow-inner">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>
                <div id="paginationRecycleBin" class="pagination hidden"></div>
                <div class="mt-4 flex justify-center">
                </div>
            </div>
        </div>
        <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-gray-900/80 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-700 p-6 rounded-2xl shadow-2xl max-w-xs w-full mx-auto border border-red-300 dark:border-red-600">
                <h3 class="text-xl font-bold text-red-700 dark:text-red-400 mb-3 border-b pb-2">X√°c nh·∫≠n X√≥a H√≥a ƒê∆°n</h3>
                <p class="text-gray-700 dark:text-gray-200 text-sm mb-4" id="deleteConfirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y kh√¥ng?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideDeleteModal()" aria-label="H·ªßy x√≥a" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-150 text-sm">H·ªßy</button>
                    <button onclick="performDelete()" aria-label="X√≥a vƒ©nh vi·ªÖn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 text-sm">X√≥a Vƒ©nh Vi·ªÖn</button>
                </div>
            </div>
        </div>
        <div id="invoiceDetailModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-gray-900/80 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-700 p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-auto border border-green-300 dark:border-green-600">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-bold text-green-700 dark:text-green-400">üìÑ Chi Ti·∫øt H√≥a ƒê∆°n</h3>
                    <button onclick="hideInvoiceDetailModal()" aria-label="ƒê√≥ng chi ti·∫øt h√≥a ƒë∆°n" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-3 text-sm text-gray-700 dark:text-gray-200">
                    <p><strong>T√™n H√≥a ƒê∆°n:</strong> <span id="detailInvoiceName" class="font-semibold text-base block"></span></p>
                    <p><strong>Nh√† Thu·ªëc:</strong> <span id="detailPharmacyName" class="font-semibold block"></span></p>
                    <p><strong>Ng√†y L·∫≠p:</strong> <span id="detailInvoiceDate" class="font-semibold block"></span></p>
                    <p><strong>Th·ªùi gian t·∫°o:</strong> <span id="detailCreatedAt" class="font-semibold block"></span></p>
                    <p class="flex items-center">
                        <strong>Li√™n K·∫øt:</strong>
                        <span id="detailInvoiceLink" class="font-semibold ml-2"></span>
                    </p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="hideInvoiceDetailModal()" aria-label="ƒê√≥ng" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition duration-150 text-sm">ƒê√≥ng</button>
                </div>
            </div>
        </div>
        <footer class="mt-8 mb-2 text-center text-gray-500 dark:text-gray-400 text-xs font-medium">NƒêT - Phi√™n b·∫£n 2025 (N√¢ng c·∫•p State Management & UX)</footer>
    </div>
<script>
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyC737M2y1nwrGP48rEQ8dVhpV4DwUkysg",
        authDomain: "duanluutrunew.firebaseapp.com",
        projectId: "duanluutrunew",
        storageBucket: "duanluutrunew.appspot.com",
        messagingSenderId: "1008741702165",
        appId: "1:1008741702165:web:7e81901f4aac66cb9a0c1c",
        measurementId: "G-ZZ4EMWNN8VB"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    const COLLECTION_NAME = 'medx_invoices';
    const PHARMACY_MAP = { 'NT Tu·ªá Thi·ªán': 'TueThien', 'NT H∆∞ng Th·ªãnh': 'HungThinh', 'RecycleBin': 'RecycleBin' };
    const ONE_DAY_MS = 24 * 60 * 60 * 1000;
    const THREE_DAYS_MS = 3 * ONE_DAY_MS;
    const INVOICES_PER_PAGE = 20;
    
    let currentDeleteTarget = { pharmacyName: null, invoiceId: null, isPermanent: false };
    let unsubscribeListeners = {};
    let searchTimeout = {};

    // =================================================================================
    // 1. N√ÇNG C·∫§P: STATE MANAGEMENT (AppStore & Observer Pattern)
    // =================================================================================
    const AppStore = {
        'TueThien': { list: [], filter: 'all', pagination: { lastDoc: null, hasMore: true } },
        'HungThinh': { list: [], filter: 'all', pagination: { lastDoc: null, hasMore: true } },
        'RecycleBin': { list: [], filter: 'all', pagination: { lastDoc: null, hasMore: true } },
        'Uncompleted': { list: [] }
    };

    let stateChangeObservers = {};

    function updateStore(pharmacyKey, newData, triggerRender = true) {
        Object.assign(AppStore[pharmacyKey], newData);
        if (triggerRender) {
            notify(pharmacyKey);
        }
    }

    function notify(key) {
        if (stateChangeObservers[key]) {
            stateChangeObservers[key]();
        }
    }
    
    function registerObservers() {
        stateChangeObservers['TueThien'] = () => {
            const state = AppStore['TueThien'];
            renderPharmacyList('NT Tu·ªá Thi·ªán', 'displayTueThien', state.list, false, true);
            renderPagination('NT Tu·ªá Thi·ªán', 'TueThien');
        };
        stateChangeObservers['HungThinh'] = () => {
            const state = AppStore['HungThinh'];
            renderPharmacyList('NT H∆∞ng Th·ªãnh', 'displayHungThinh', state.list, false, true);
            renderPagination('NT H∆∞ng Th·ªãnh', 'HungThinh');
        };
        stateChangeObservers['RecycleBin'] = () => {
            const state = AppStore['RecycleBin'];
            renderRecycleBinList(state.list, false, true);
            renderPagination('RecycleBin', 'RecycleBin');
        };
        stateChangeObservers['Uncompleted'] = () => {
            renderUncompletedOverview();
        };
    }
    
    // =================================================================================
    // CH·ª®C NƒÇNG CHUNG V√Ä TI·ªÜN √çCH
    // =================================================================================
    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        const icon = document.getElementById('darkModeIcon');
        const path = icon.querySelector('path');
        if (document.body.classList.contains('dark')) {
            path.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
        } else {
            path.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
        }
        localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
        const path = document.getElementById('darkModeIcon').querySelector('path');
        path.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
    }
    function getCurrentDateKey() {
        const d = new Date();
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        let year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    }
    function formatDate(dateKey) {
        if (!dateKey) return 'Kh√¥ng r√µ ng√†y';
        const parts = dateKey.split('-');
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return dateKey;
    }
    function timeAgo(timestamp) {
        if (!timestamp) return 'Kh√¥ng r√µ';
        const date = timestamp.toDate();
        const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) { return Math.floor(interval) + " nƒÉm tr∆∞·ªõc"; }
        interval = seconds / 2592000;
        if (interval > 1) { return Math.floor(interval) + " th√°ng tr∆∞·ªõc"; }
        interval = seconds / 86400;
        if (interval > 1) { return Math.floor(interval) + " ng√†y tr∆∞·ªõc"; }
        interval = seconds / 3600;
        if (interval > 1) { return Math.floor(interval) + " gi·ªù tr∆∞·ªõc"; }
        interval = seconds / 60;
        if (interval > 1) { return Math.floor(interval) + " ph√∫t tr∆∞·ªõc"; }
        return "V·ª´a xong";
    }
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const id = Date.now();
        let bgColor, icon;
        switch (type) {
            case 'error': bgColor = 'bg-red-600'; icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; break;
            case 'info': bgColor = 'bg-blue-600'; icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; break;
            case 'success': default: bgColor = 'bg-green-600'; icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; break;
        }
        const toastHtml = `
            <div id="toast-${id}" class="flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg opacity-0 transform translate-x-full transition-all duration-300 hover:scale-105">
                ${icon}
                <p class="ml-3">${message}</p>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(`toast-${id}`);
        setTimeout(() => { toastElement.style.transform = 'translateX(0)'; toastElement.style.opacity = '1'; }, 10);
        setTimeout(() => {
            toastElement.style.transform = 'translateX(150%)';
            toastElement.style.opacity = '0';
            setTimeout(() => { toastElement.remove(); }, 300);
        }, 3000);
    }
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }
    function debounceSearch(pharmacyName, key, searchTerm) {
        clearTimeout(searchTimeout[key]);
        searchTimeout[key] = setTimeout(() => {
            searchInvoices(pharmacyName, key, searchTerm);
        }, 400);
    }
    function updateFilterButtons(pharmacyKey, activeFilter) {
        const filters = ['All', 'Uncompleted', 'Completed'];
        filters.forEach(f => {
            const btn = document.getElementById(`filter${pharmacyKey}${f}`);
            if (btn) {
                btn.classList.remove('filter-active', 'bg-green-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-200', 'dark:hover:bg-gray-500');
                if (f.toLowerCase() === activeFilter) {
                    btn.classList.add('filter-active', 'bg-green-600', 'text-white', 'shadow-md');
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-200', 'dark:hover:bg-gray-500');
                }
            }
        });
    }
    function toggleInvoiceForm(key, reset = true) {
        const formElement = document.getElementById(`form${key}`);
        const nameInput = document.getElementById(`input${key}Name`);
        const dateInput = document.getElementById(`input${key}Date`);
        const linkInput = document.getElementById(`input${key}Link`);
        const idInput = document.getElementById(`input${key}Id`);
        const formTitle = document.getElementById(`formTitle${key}`);
        const saveButton = document.getElementById(`saveButton${key}`);
        if (formElement.classList.contains('hidden')) {
            formElement.classList.remove('hidden');
            if (reset) {
                nameInput.value = '';
                dateInput.value = getCurrentDateKey();
                linkInput.value = '';
                idInput.value = '';
                formTitle.textContent = 'Th√™m H√≥a ƒê∆°n M·ªõi';
                saveButton.textContent = 'L∆∞u';
                saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            setTimeout(() => { nameInput.focus(); }, 50);
        } else {
            formElement.classList.add('hidden');
            nameInput.classList.remove('border-red-500', 'ring-red-500');
            linkInput.classList.remove('border-red-500', 'ring-red-500');
        }
    }
    function startEditInvoice(pharmacyName, invoiceId) {
        const list = AppStore[PHARMACY_MAP[pharmacyName]].list || [];
        const invoiceToEdit = list.find(c => c.id === invoiceId);
        if (!invoiceToEdit) return;
        const key = PHARMACY_MAP[pharmacyName];
        document.getElementById(`input${key}Name`).value = invoiceToEdit.name;
        document.getElementById(`input${key}Date`).value = invoiceToEdit.date;
        document.getElementById(`input${key}Link`).value = invoiceToEdit.link || '';
        document.getElementById(`input${key}Id`).value = invoiceToEdit.id;
        document.getElementById(`formTitle${key}`).textContent = 'Ch·ªânh S·ª≠a H√≥a ƒê∆°n';
        const saveButton = document.getElementById(`saveButton${key}`);
        saveButton.textContent = 'C·∫≠p Nh·∫≠t';
        saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
        saveButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        toggleInvoiceForm(key, false);
    }
    function showDeleteModal(pharmacyName, invoiceId, invoiceName, isPermanent = false) {
        currentDeleteTarget = { pharmacyName, invoiceId, isPermanent };
        const action = isPermanent ? 'x√≥a vƒ©nh vi·ªÖn' : 'x√≥a';
        document.getElementById('deleteConfirmMessage').innerHTML = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën **${action}** h√≥a ƒë∆°n **${invoiceName}**${isPermanent ? '' : ` kh·ªèi ${pharmacyName}`} kh√¥ng?`;
        document.getElementById('deleteConfirmModal').classList.remove('hidden');
    }
    function hideDeleteModal() {
        document.getElementById('deleteConfirmModal').classList.add('hidden');
        currentDeleteTarget = { pharmacyName: null, invoiceId: null, isPermanent: false };
    }
    function toggleRecycleBinModal() {
        const modal = document.getElementById('recycleBinModal');
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            loadRecycleBin();
        } else {
            modal.classList.add('hidden');
            if (unsubscribeListeners['RecycleBin']) {
                unsubscribeListeners['RecycleBin']();
            }
            // Reset pagination for RecycleBin
            updateStore('RecycleBin', { pagination: { lastDoc: null, hasMore: true } }, false);
        }
    }
    function showInvoiceDetailModal(invoice) {
        document.getElementById('detailInvoiceName').textContent = invoice.name;
        document.getElementById('detailPharmacyName').textContent = invoice.pharmacy;
        document.getElementById('detailInvoiceDate').textContent = formatDate(invoice.date);
        document.getElementById('detailCreatedAt').textContent = invoice.createdAt ? new Date(invoice.createdAt).toLocaleString() : 'Kh√¥ng r√µ';
        const linkContainer = document.getElementById('detailInvoiceLink');
        linkContainer.innerHTML = '';
        if (invoice.link && isValidUrl(invoice.link)) {
            linkContainer.innerHTML = `
                <a href="${invoice.link}" target="_blank" rel="noopener noreferrer"
                    class="text-blue-500 hover:text-blue-700 font-bold flex items-center transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-7-5l-5 5m0 0h4m-4 0v4m-1-5l5-5" />
                    </svg>
                    M·ªü Li√™n K·∫øt
                </a>
            `;
        } else {
            linkContainer.textContent = 'Kh√¥ng c√≥ li√™n k·∫øt ƒë√≠nh k√®m.';
        }
        document.getElementById('invoiceDetailModal').classList.remove('hidden');
    }
    function hideInvoiceDetailModal() {
        document.getElementById('invoiceDetailModal').classList.add('hidden');
    }
    async function performDelete() {
        const { pharmacyName, invoiceId, isPermanent } = currentDeleteTarget;
        if (!pharmacyName || !invoiceId) {
            hideDeleteModal();
            return;
        }
        try {
            if (isPermanent) {
                await db.collection(COLLECTION_NAME).doc(invoiceId).delete();
                showToast(`ƒê√£ X√ìA Vƒ®NH VI·ªÑN h√≥a ƒë∆°n th√†nh c√¥ng!`, 'error');
            } else {
                await db.collection(COLLECTION_NAME).doc(invoiceId).update({
                    isDeleted: true,
                    deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast(`ƒê√£ chuy·ªÉn h√≥a ƒë∆°n v√†o th√πng r√°c!`, 'info');
            }
        } catch (e) {
            console.error(`L·ªói ${isPermanent ? 'x√≥a vƒ©nh vi·ªÖn' : 'chuy·ªÉn v√†o th√πng r√°c'} Firestore:`, e);
            showToast(`L·ªói: Kh√¥ng th·ªÉ ${isPermanent ? 'x√≥a vƒ©nh vi·ªÖn' : 'chuy·ªÉn v√†o th√πng r√°c'} h√≥a ƒë∆°n. Chi ti·∫øt: ${e.message.substring(0, 50)}...`, 'error');
        }
        hideDeleteModal();
    }
    async function restoreInvoice(invoiceId, invoiceName) {
        try {
            await db.collection(COLLECTION_NAME).doc(invoiceId).update({
                isDeleted: false,
                deletedAt: firebase.firestore.FieldValue.delete()
            });
            showToast(`ƒê√£ KH√îI PH·ª§C h√≥a ƒë∆°n "${invoiceName}" th√†nh c√¥ng!`, 'success');
        } catch (e) {
            console.error("L·ªói kh√¥i ph·ª•c Firestore:", e);
            showToast(`L·ªói: Kh√¥ng th·ªÉ kh√¥i ph·ª•c h√≥a ƒë∆°n. Chi ti·∫øt: ${e.message.substring(0, 50)}...`, 'error');
        }
    }
    async function cancelGroupDeletion(pharmacyName, dateKey) {
        const list = AppStore[PHARMACY_MAP[pharmacyName]].list || [];
        const companiesInDay = list.filter(c => c.date === dateKey && c.readyForDeletionTimestamp);
        if (companiesInDay.length === 0) return;
        const batch = db.batch();
        companiesInDay.forEach(c => {
            const docRef = db.collection(COLLECTION_NAME).doc(c.id);
            batch.update(docRef, { readyForDeletionTimestamp: firebase.firestore.FieldValue.delete(), completed: false });
        });
        try {
            await batch.commit();
            showToast(`ƒê√£ H·ª¶Y b·ªè vi·ªác x√≥a t·ª± ƒë·ªông cho ng√†y ${formatDate(dateKey)}.`, 'info');
        } catch (e) {
            console.error("L·ªói h·ªßy x√≥a nh√≥m Firestore:", e);
            showToast(`L·ªói khi h·ªßy b·ªè x√≥a nh√≥m: ${e.message.substring(0, 50)}...`, 'error');
        }
    }
    async function toggleCompletion(pharmacyName, invoiceId) {
        const key = PHARMACY_MAP[pharmacyName];
        const currentList = AppStore[key].list;
        const originalCompany = currentList.find(c => c.id === invoiceId);
        if (!originalCompany) return;
        const newCompletedState = !originalCompany.completed;
        const dateKey = originalCompany.date;
        let toastMessage = '';
        try {
            await db.collection(COLLECTION_NAME).doc(invoiceId).update({ completed: newCompletedState });
            toastMessage = newCompletedState ? `H√≥a ƒë∆°n ƒë√£ ho√†n th√†nh.` : `H√≥a ƒë∆°n "${originalCompany.name}" ch∆∞a ho√†n th√†nh.`;
        } catch (e) {
            showToast(`L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ${e.message.substring(0, 50)}...`, 'error');
            return;
        }
        
        // C·∫≠p nh·∫≠t client-side state t·∫°m th·ªùi (s·∫Ω ƒë∆∞·ª£c onSnapshot ghi ƒë√®)
        const updatedList = currentList.map(item => item.id === invoiceId ? { ...item, completed: newCompletedState } : item);
        
        // Logic Auto Cleanup Group
        const companiesInDay = updatedList.filter(c => c.date === dateKey);
        const allCompletedAfterUpdate = companiesInDay.every(c => c.completed);
        
        if (allCompletedAfterUpdate && newCompletedState) {
            const deletionTime = Date.now() + THREE_DAYS_MS;
            const batch = db.batch();
            companiesInDay.forEach(c => {
                if (!c.readyForDeletionTimestamp) {
                    const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                    batch.update(docRef, { readyForDeletionTimestamp: deletionTime });
                }
            });
            try {
                await batch.commit();
                toastMessage = `Ng√†y ${formatDate(dateKey)} ƒë√£ ho√†n th√†nh 100% v√† ƒë∆∞·ª£c ƒë√°nh d·∫•u x√≥a sau 3 ng√†y.`;
            } catch (e) {
                showToast(`L·ªói c·∫≠p nh·∫≠t nh√≥m x√≥a: ${e.message.substring(0, 50)}...`, 'error');
            }
        } else if (!newCompletedState) {
            const batch = db.batch();
            companiesInDay.forEach(c => {
                if (c.readyForDeletionTimestamp) {
                    const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                    batch.update(docRef, { readyForDeletionTimestamp: firebase.firestore.FieldValue.delete() });
                }
            });
            try {
                const existedCleanup = companiesInDay.some(c => c.readyForDeletionTimestamp);
                await batch.commit();
                if (existedCleanup) {
                      toastMessage = `ƒê√£ H·ª¶Y b·ªè vi·ªác x√≥a t·ª± ƒë·ªông cho ng√†y ${formatDate(dateKey)}.`;
                }
            } catch (e) {
                showToast(`L·ªói h·ªßy x√≥a nh√≥m: ${e.message.substring(0, 50)}...`, 'error');
            }
        }
        showToast(toastMessage, allCompletedAfterUpdate ? 'info' : 'success');
    }
    async function saveInvoice(pharmacyName, inputNameId, inputDateId, inputLinkId, inputIdId) {
        const companyInput = document.getElementById(inputNameId);
        const dateInput = document.getElementById(inputDateId);
        const linkInput = document.getElementById(inputLinkId);
        const idInput = document.getElementById(inputIdId);
        const invoiceId = idInput.value.trim();
        const invoiceName = companyInput.value.trim();
        const dateKey = dateInput.value.trim() || getCurrentDateKey();
        let invoiceLink = linkInput.value.trim();
        if (invoiceLink && !isValidUrl(invoiceLink)) {
            linkInput.classList.add('border-red-500', 'ring-red-500');
            showToast('Link kh√¥ng h·ª£p l·ªá (ph·∫£i l√† URL ƒë·∫ßy ƒë·ªß nh∆∞ https://...).', 'error');
            setTimeout(() => { linkInput.classList.remove('border-red-500', 'ring-red-500'); }, 1000);
            return;
        }
        let successMessage;
        let savedSuccessfully = false;
        if (invoiceName === "") {
            companyInput.classList.add('border-red-500', 'ring-red-500');
            showToast('T√™n h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
            setTimeout(() => { companyInput.classList.remove('border-red-500', 'ring-red-500'); }, 1000);
            return;
        }
        const baseData = { name: invoiceName, date: dateKey, link: invoiceLink || null };
        if (invoiceId) {
              try {
                await db.collection(COLLECTION_NAME).doc(invoiceId).update(baseData);
                successMessage = `H√≥a ƒë∆°n "${invoiceName}" ƒë√£ ƒë∆∞·ª£c C·∫¨P NH·∫¨T th√†nh c√¥ng!`;
                savedSuccessfully = true;
            } catch (e) {
                console.error("L·ªói c·∫≠p nh·∫≠t Firestore:", e);
                showToast(`L·ªói c·∫≠p nh·∫≠t: ${e.message.substring(0, 50)}...`, 'error');
            }
        } else {
              const newInvoiceData = {
                ...baseData,
                pharmacy: pharmacyName,
                completed: false,
                isDeleted: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                await db.collection(COLLECTION_NAME).add(newInvoiceData);
                successMessage = `ƒê√£ TH√äM h√≥a ƒë∆°n "${invoiceName}" m·ªõi.`;
                savedSuccessfully = true;
            } catch (e) {
                console.error("L·ªói th√™m m·ªõi Firestore:", e);
                showToast(`L·ªói th√™m m·ªõi: ${e.message.substring(0, 50)}...`, 'error');
            }
        }
        if (savedSuccessfully) {
            const key = PHARMACY_MAP[pharmacyName];
            toggleInvoiceForm(key, true);
            showToast(successMessage, invoiceId ? 'info' : 'success');
        }
    }
    
    // =================================================================================
    // 2. N√ÇNG C·∫§P: HI·ªÇN TH·ªä LOADING C·ª§ TH·ªÇ
    // =================================================================================
    function showDisplayLoading(key) {
        const displayArea = document.getElementById(`display${key}`);
        const skeleton = document.getElementById('loadingSkeleton').cloneNode(true);
        skeleton.classList.remove('hidden');
        let html = '';
        for (let i = 0; i < 5; i++) { html += skeleton.outerHTML; } // 5 items
        displayArea.innerHTML = html;
        // V√¥ hi·ªáu h√≥a n√∫t T·∫£i Th√™m
        const paginationContainer = document.getElementById(`pagination${key}`);
        if (paginationContainer) {
            paginationContainer.classList.remove('hidden');
            paginationContainer.innerHTML = '<button disabled class="bg-gray-400 dark:bg-gray-600 text-white px-4 py-2 rounded-lg">ƒêang t·∫£i...</button>';
        }
    }

    // =================================================================================
    // 3. N√ÇNG C·∫§P: SCROLL TO INVOICE (UX)
    // =================================================================================
    function scrollToInvoice(key, invoiceId) {
        // 1. M·ªü tab Nh√† Thu·ªëc n·∫øu n√≥ ƒëang ƒë√≥ng
        if (document.getElementById(`content${key}`).classList.contains('hidden')) {
            togglePharmacy(`NT ${key === 'TueThien' ? 'Tu·ªá Thi·ªán' : 'H∆∞ng Th·ªãnh'}`, key);
        }
        
        // 2. Cu·ªôn ƒë·∫øn v·ªã tr√≠
        setTimeout(() => {
            const invoiceElement = document.getElementById(`company-${invoiceId}`);
            if (invoiceElement) {
                invoiceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Hi·ªáu ·ª©ng highlight
                invoiceElement.classList.add('bg-yellow-100', 'ring-2', 'ring-yellow-500', 'dark:bg-yellow-900', 'dark:ring-yellow-400');
                setTimeout(() => {
                    invoiceElement.classList.remove('bg-yellow-100', 'ring-2', 'ring-yellow-500', 'dark:bg-yellow-900', 'dark:ring-yellow-400');
                }, 1500);
            } else {
                 // N·∫øu h√≥a ƒë∆°n kh√¥ng c√≥ trong danh s√°ch hi·ªán t·∫°i (v√≠ d·ª•: ƒëang ·ªü trang 1, h√≥a ƒë∆°n ·ªü trang 2)
                 showToast('H√≥a ƒë∆°n kh√¥ng hi·ªÉn th·ªã! H√£y t√¨m ki·∫øm ho·∫∑c chuy·ªÉn sang b·ªô l·ªçc "T·∫•t c·∫£".', 'info');
            }
        }, 300); 
    }

    // =================================================================================
    // LOGIC T·∫¢I D·ªÆ LI·ªÜU (ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng AppStore)
    // =================================================================================
    function togglePharmacy(pharmacyName, key) {
        const contentElement = document.getElementById(`content${key}`);
        const tabElement = document.getElementById(`tab${key}`);
        const allKeys = Object.values(PHARMACY_MAP).filter(k => k !== 'RecycleBin');
        const overview = document.getElementById('uncompletedOverviewContainer');

        if (!contentElement.classList.contains('hidden')) {
            // ƒê√≥ng tab
            contentElement.classList.add('hidden');
            tabElement.classList.add('tab-collapsed');
            tabElement.classList.remove('bg-white', 'border-green-500', 'border-b-2', 'dark:bg-gray-700', 'dark:border-green-400');
            tabElement.classList.add('text-gray-600', 'hover:bg-gray-100', 'border-transparent', 'dark:text-gray-400', 'dark:hover:bg-gray-700');
            tabElement.style.marginBottom = '0';
            document.getElementById(`form${key}`)?.classList.add('hidden');
            overview.classList.remove('collapsed');
            return;
        }
        // M·ªü tab
        allKeys.forEach(k => {
            if (k !== key) {
                const otherContent = document.getElementById(`content${k}`);
                const otherTab = document.getElementById(`tab${k}`);
                otherContent?.classList.add('hidden');
                otherTab?.classList.add('tab-collapsed');
                otherTab?.classList.remove('bg-white', 'border-green-500', 'border-b-2', 'dark:bg-gray-700', 'dark:border-green-400');
                otherTab?.classList.add('text-gray-600', 'hover:bg-gray-100', 'border-transparent', 'dark:text-gray-400', 'dark:hover:bg-gray-700');
                otherTab.style.marginBottom = '0';
                document.getElementById(`form${k}`)?.classList.add('hidden');
            }
        });
        contentElement.classList.remove('hidden');
        tabElement.classList.remove('tab-collapsed');
        tabElement.classList.add('bg-white', 'border-green-500', 'border-b-2', 'dark:bg-gray-700', 'dark:border-green-400');
        tabElement.classList.remove('text-gray-600', 'hover:bg-gray-100', 'border-transparent', 'dark:text-gray-400', 'dark:hover:bg-gray-700');
        tabElement.style.marginBottom = '-2px';
        overview.classList.add('collapsed');
        
        // Load d·ªØ li·ªáu
        if (!AppStore[key].list.length || unsubscribeListeners[pharmacyName] === undefined) {
             filterAndLoadInvoices(pharmacyName, AppStore[key].filter, true);
        } else {
             notify(key); // Force render from existing state
             notify('Uncompleted'); // Update Overview
        }
    }

    function filterAndLoadInvoices(pharmacyName, filterType, resetPagination = false) {
        const key = PHARMACY_MAP[pharmacyName];
        if (unsubscribeListeners[pharmacyName]) {
              unsubscribeListeners[pharmacyName]();
        }
        if (resetPagination) {
            updateStore(key, { filter: filterType, pagination: { lastDoc: null, hasMore: true } }, false);
        } else {
             updateStore(key, { filter: filterType }, false);
        }
        updateFilterButtons(key, filterType);
        document.getElementById(`search${key}`).value = '';
        
        showDisplayLoading(key); // HI·ªÇN TH·ªä SKELETON

        let query = db.collection(COLLECTION_NAME)
            .where('pharmacy', '==', pharmacyName)
            .where('isDeleted', '==', false)
            .orderBy('date', 'desc');

        if (filterType === 'completed') {
            query = query.where('completed', '==', true);
        } else if (filterType === 'uncompleted') {
            query = query.where('completed', '==', false);
        }
        query = query.limit(INVOICES_PER_PAGE);

        unsubscribeListeners[pharmacyName] = query.onSnapshot(snapshot => {
            const list = [];
            let lastVisible = null;
            snapshot.forEach(doc => {
                list.push({ id: doc.id, ...doc.data() });
                lastVisible = doc;
            });
            const filteredList = runAutoCleanup(list);
            
            updateStore(key, {
                list: filteredList,
                pagination: {
                    lastDoc: lastVisible,
                    hasMore: snapshot.size === INVOICES_PER_PAGE
                }
            });
            
            // C·∫≠p nh·∫≠t overview sau khi c·∫£ hai nh√† thu·ªëc ƒë√£ load
            const allUncompleted = getCombinedUncompletedList();
            updateStore('Uncompleted', { list: allUncompleted });
            
        }, error => {
            // X·ª≠ l√Ω l·ªói Indexing
            if (error.code === 'failed-precondition' && error.message.includes('index')) {
                // ... (Logic x·ª≠ l√Ω l·ªói index)
                showToast(`L·ªói l·ªçc d·ªØ li·ªáu. VUI L√íNG T·∫†O CH·ªà M·ª§C (INDEX) TRONG FIREBASE.`, 'error');
                console.error("L·ªói Firestore Index:", error);
                return;
            }
            showToast(`L·ªói ƒë·ªìng b·ªô h√≥a d·ªØ li·ªáu: ${error.message.substring(0, 50)}...`, 'error');
        });
    }

    function loadMoreInvoices(pharmacyName, key) {
        const state = AppStore[key];
        if (!state.pagination.hasMore || state.pagination.lastDoc === null) return;
        
        showDisplayLoading(key); // HI·ªÇN TH·ªä SKELETON KHI T·∫¢I TH√äM

        let query = db.collection(COLLECTION_NAME)
            .where('pharmacy', '==', pharmacyName)
            .where('isDeleted', '==', false)
            .orderBy('date', 'desc')
            .startAfter(state.pagination.lastDoc)
            .limit(INVOICES_PER_PAGE);
        
        if (state.filter === 'completed') {
            query = query.where('completed', '==', true);
        } else if (state.filter === 'uncompleted') {
            query = query.where('completed', '==', false);
        }
        
        query.get().then(snapshot => {
            const additionalList = [];
            let lastVisible = null;
            snapshot.forEach(doc => {
                additionalList.push({ id: doc.id, ...doc.data() });
                lastVisible = doc;
            });

            if (additionalList.length > 0) {
                const newList = [...state.list, ...additionalList];
                const filteredList = runAutoCleanup(newList); // Ch·∫°y cleanup tr√™n to√†n b·ªô danh s√°ch m·ªõi
                
                updateStore(key, {
                    list: filteredList,
                    pagination: {
                        lastDoc: lastVisible,
                        hasMore: snapshot.size === INVOICES_PER_PAGE
                    }
                });
            } else {
                 updateStore(key, { pagination: { ...state.pagination, hasMore: false } });
            }
        }).catch(error => {
            showToast(`L·ªói t·∫£i th√™m d·ªØ li·ªáu: ${error.message.substring(0, 50)}...`, 'error');
            // C·∫ßn c·∫≠p nh·∫≠t l·∫°i UI n·∫øu c√≥ l·ªói
            notify(key);
        });
    }

    function renderPagination(pharmacyName, key) {
        const paginationContainer = document.getElementById(`pagination${key}`);
        const state = AppStore[key];
        
        if (state.pagination.hasMore && (state.list.length > 0)) { // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ th·ªÉ t·∫£i th√™m v√† kh√¥ng ph·∫£i l√† list r·ªóng
            paginationContainer.classList.remove('hidden');
            paginationContainer.innerHTML = `
                <button onclick="loadMoreInvoices('${pharmacyName}', '${key}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">T·∫£i Th√™m</button>
            `;
        } else {
             paginationContainer.classList.add('hidden');
        }
    }

    function loadRecycleBin() {
        const key = 'RecycleBin';
        if (unsubscribeListeners[key]) {
            unsubscribeListeners[key]();
        }
        updateStore(key, { filter: 'all', pagination: { lastDoc: null, hasMore: true } }, false);
        document.getElementById('searchRecycleBin').value = '';
        showDisplayLoading(key); // HI·ªÇN TH·ªä SKELETON
        
        let query = db.collection(COLLECTION_NAME)
            .where('isDeleted', '==', true)
            .orderBy('deletedAt', 'desc')
            .limit(INVOICES_PER_PAGE);

        unsubscribeListeners[key] = query.onSnapshot(snapshot => {
            const list = [];
            let lastVisible = null;
            snapshot.forEach(doc => {
                list.push({ id: doc.id, ...doc.data() });
                lastVisible = doc;
            });
            updateStore(key, {
                list: list,
                pagination: {
                    lastDoc: lastVisible,
                    hasMore: snapshot.size === INVOICES_PER_PAGE
                }
            });
        }, error => {
            // X·ª≠ l√Ω l·ªói Indexing RecycleBin
            // ... (Logic x·ª≠ l√Ω l·ªói index)
            showToast(`L·ªói ƒë·ªìng b·ªô h√≥a d·ªØ li·ªáu th√πng r√°c.`, 'error');
        });
    }

    // Logic LoadMoreRecycleBin t∆∞∆°ng t·ª± LoadMoreInvoices nh∆∞ng s·ª≠ d·ª•ng AppStore['RecycleBin']
    function loadMoreRecycleBin() {
        const key = 'RecycleBin';
        const state = AppStore[key];
        if (!state.pagination.hasMore || state.pagination.lastDoc === null) return;

        showDisplayLoading(key);

        let query = db.collection(COLLECTION_NAME)
            .where('isDeleted', '==', true)
            .orderBy('deletedAt', 'desc')
            .startAfter(state.pagination.lastDoc)
            .limit(INVOICES_PER_PAGE);

        query.get().then(snapshot => {
            const additionalList = [];
            let lastVisible = null;
            snapshot.forEach(doc => {
                additionalList.push({ id: doc.id, ...doc.data() });
                lastVisible = doc;
            });

            if (additionalList.length > 0) {
                const newList = [...state.list, ...additionalList];
                updateStore(key, {
                    list: newList,
                    pagination: {
                        lastDoc: lastVisible,
                        hasMore: snapshot.size === INVOICES_PER_PAGE
                    }
                });
            } else {
                 updateStore(key, { pagination: { ...state.pagination, hasMore: false } });
            }
        }).catch(error => {
            showToast(`L·ªói t·∫£i th√™m th√πng r√°c: ${error.message.substring(0, 50)}...`, 'error');
            notify(key);
        });
    }


    function searchInvoices(pharmacyName, key, searchTerm) {
        const list = AppStore[key].list || [];
        const displayElementId = `display${key}`;
        const query = searchTerm.toLowerCase().trim();
        let listToRender = list;

        if (query.length > 0) {
            // H·ªßy onSnapshot n·∫øu ƒëang t√¨m ki·∫øm
            if (unsubscribeListeners[pharmacyName]) {
                  unsubscribeListeners[pharmacyName]();
            }
            listToRender = list.filter(invoice =>
                invoice.name.toLowerCase().includes(query) ||
                  formatDate(invoice.date).includes(query)
            );
            document.getElementById(`pagination${key}`).classList.add('hidden');
        } else {
            // Tr·ªü v·ªÅ ch·∫ø ƒë·ªô ƒë·ªìng b·ªô realtime
            if (pharmacyName === 'RecycleBin') {
                loadRecycleBin();
            } else {
                filterAndLoadInvoices(pharmacyName, AppStore[key].filter);
            }
            return;
        }

        if (pharmacyName === 'RecycleBin') {
            renderRecycleBinList(listToRender, true);
        } else {
            renderPharmacyList(pharmacyName, displayElementId, listToRender, true);
        }
    }

    function runAutoCleanup(list) {
        const now = Date.now();
        const batch = db.batch();
        let hasDeletions = false;
        // L∆ØU √ù: Logic t·ªëi ∆∞u n√™n ch·∫°y tr√™n SERVER (Cloud Functions) ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô tin c·∫≠y.
        const filteredList = list.filter(c => {
            if (c.readyForDeletionTimestamp && now > c.readyForDeletionTimestamp && !c.isDeleted) {
                const docRef = db.collection(COLLECTION_NAME).doc(c.id);
                batch.update(docRef, {
                    isDeleted: true,
                    deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hasDeletions = true;
                return false;
            }
            return true;
        });
        if (hasDeletions) {
            batch.commit().catch(e => {
                console.error("L·ªói t·ª± ƒë·ªông chuy·ªÉn v√†o th√πng r√°c (client):", e);
                showToast(`L·ªói t·ª± ƒë·ªông chuy·ªÉn: ${e.message.substring(0, 50)}...`, 'error');
            });
        }
        return filteredList;
    }

    // =================================================================================
    // LOGIC RENDER (ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng AppStore/Scroll to Invoice)
    // =================================================================================
    function renderPharmacyList(pharmacyName, displayElementId, list, isSearchMode = false, showPagination = false) {
        const displayArea = document.getElementById(displayElementId);
        const todayKey = getCurrentDateKey();
        
        if (list.length === 0) {
            displayArea.innerHTML = `<div class="text-gray-500 dark:text-gray-400 text-center py-2">${isSearchMode ? 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p.' : 'Danh s√°ch h√≥a ƒë∆°n r·ªóng. H√£y nh·∫•n d·∫•u + ƒë·ªÉ th√™m h√≥a ƒë∆°n m·ªõi.'}</div>`;
            return;
        }
        const groupedByDate = list.reduce((acc, entry) => {
            const date = entry.date || 'Kh√¥ng r√µ ng√†y';
            if (!acc[date]) { acc[date] = []; }
            acc[date].push(entry);
            return acc;
        }, {});
        let html = isSearchMode ? '' : `<div class="p-2 text-sm font-bold text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-600 mb-4">T·ªïng c·ªông: ${list.length} H√≥a ƒë∆°n</div>`;
        const sortedDates = Object.keys(groupedByDate).sort().reverse();
        
        sortedDates.forEach(dateKey => {
            const companiesOnDate = groupedByDate[dateKey];
            const formattedDate = formatDate(dateKey);
            const isToday = dateKey === todayKey;
            const isDeletionPending = companiesOnDate[0].readyForDeletionTimestamp ? true : false;
            let groupStatusText = '';
            
            if (isDeletionPending) {
                const timeToDeletion = companiesOnDate[0].readyForDeletionTimestamp - Date.now();
                const daysLeft = Math.ceil(timeToDeletion / ONE_DAY_MS);
                groupStatusText = `<span class="ml-2 text-xs font-medium text-red-600 dark:text-red-300 bg-red-100 dark:bg-red-900 px-2 py-0.5 rounded-full flex items-center">
                                <span class="mr-2">üóëÔ∏è S·∫Ω chuy·ªÉn v√†o th√πng r√°c sau ${daysLeft} ng√†y</span>
                                <button onclick="cancelGroupDeletion('${pharmacyName}', '${dateKey}')"
                                    class="text-red-700 dark:text-red-400 hover:text-white hover:bg-red-500 dark:hover:bg-red-700 rounded-full transition duration-150 px-1 font-bold">
                                    ‚ùå H·ªßy
                                </button>
                           </span>`;
            }
            const totalInDay = companiesOnDate.length;
            const completedInDay = companiesOnDate.filter(c => c.completed).length;
            const progressText = `<span class="font-extrabold">${completedInDay}</span>/<span class="font-bold">${totalInDay}</span> ƒë√£ xong`;
            const progressColor = (completedInDay === totalInDay) ? 'text-green-700 dark:text-green-400' : 'text-orange-500 dark:text-orange-400';
            
            html += `<div class="mt-4 border-l-4 ${isToday ? 'border-red-600' : 'border-green-600'} pl-3 py-2 ${isToday ? 'bg-red-50/70 dark:bg-red-900/70' : 'bg-green-50/70 dark:bg-green-900/70'} rounded-r-lg shadow-sm flex justify-between items-center flex-wrap">
                                 <h4 class="font-bold text-base text-gray-800 dark:text-gray-100 w-full sm:w-auto">
                                     üìÖ NG√ÄY ${formattedDate}
                                     <span class="${progressColor} ml-2 text-sm">(${progressText})</span>
                                 </h4>
                                 ${groupStatusText}
                             </div>
                             <ul class="space-y-1 mt-2 mb-4">`;
                                                                companiesOnDate.forEach((company) => {
                const { completed: isCompleted, id: invoiceId, name: invoiceName, link: invoiceLink, createdAt } = company;
                const completionIcon = isCompleted
                    ? `<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`
                    : `<svg class="w-5 h-5 text-gray-500 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                const timeCreated = createdAt ? ` (${timeAgo(createdAt)})` : '';
                                                html += `<li id="company-${invoiceId}" class="invoice-item flex items-center p-3 rounded-lg transition duration-100 ${isCompleted ? 'bg-green-50/40 dark:bg-gray-800/40' : 'bg-white dark:bg-gray-700'} flex-col sm:flex-row sm:items-center">
                                 <button onclick="toggleCompletion('${pharmacyName}', '${invoiceId}')" aria-label="${isCompleted ? 'ƒê√°nh d·∫•u ch∆∞a ho√†n th√†nh' : 'ƒê√°nh d·∫•u ho√†n th√†nh'}"
                                         class="p-1 mr-3 rounded-full flex-shrink-0 transition duration-150 transform hover:scale-110 ${isCompleted ? 'bg-green-600 shadow-md' : 'bg-gray-200 dark:bg-gray-600'} mb-2 sm:mb-0">
                                     ${completionIcon}
                                 </button>
                                 <span class="flex-grow text-gray-700 dark:text-gray-200 ${isCompleted ? 'text-gray-500 line-through dark:text-gray-400' : 'font-semibold'} flex items-center text-base w-full sm:w-auto mb-2 sm:mb-0">
                                     üìÑ ${invoiceName} <span class="text-xs text-gray-400 ml-2 block sm:inline">${timeCreated}</span>
                                     ${invoiceLink ? `
                                         <a href="${invoiceLink}" target="_blank" rel="noopener noreferrer"
                                            title="M·ªü Link H√≥a ƒê∆°n ƒê√≠nh K√®m"
                                            class="ml-2 text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition duration-150 transform hover:scale-110 block sm:inline">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-7-5l-5 5m0 0h4m-4 0v4m-1-5l5-5" />
                                             </svg>
                                         </a>
                                     ` : ''}
                                 </span>
                                 <div class="flex space-x-2 ml-4 flex-shrink-0 w-full sm:w-auto justify-end sm:justify-normal">
                                     <button onclick="startEditInvoice('${pharmacyName}', '${invoiceId}')" aria-label="Ch·ªânh s·ª≠a h√≥a ƒë∆°n"
                                             title="Ch·ªânh s·ª≠a H√≥a ƒë∆°n"
                                            class="text-blue-500 dark:text-blue-400 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50 dark:hover:bg-gray-600 transition duration-150 flex-1 sm:flex-none">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                         </svg>
                                     </button>
                                     <button onclick="showDeleteModal('${pharmacyName}', '${invoiceId}', '${invoiceName}')" aria-label="Chuy·ªÉn v√†o th√πng r√°c"
                                             title="Chuy·ªÉn v√†o Th√πng r√°c"
                                             class="text-red-500 dark:text-red-400 hover:text-red-700 p-1 rounded-full hover:bg-red-50 dark:hover:bg-gray-600 transition duration-150 flex-1 sm:flex-none">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
                                         </svg>
                                     </button>
                                 </div>
                             </li>`;
            });
            html += `</ul>`;
        });
        displayArea.innerHTML = html;
    }

    function renderRecycleBinList(list, isSearchMode = false, showPagination = false) {
        const displayArea = document.getElementById('displayRecycleBin');
        
        if (list.length === 0) {
            displayArea.innerHTML = `<div class="text-gray-500 dark:text-gray-400 text-center py-2">${isSearchMode ? 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p trong th√πng r√°c.' : 'Th√πng r√°c tr·ªëng.'}</div>`;
            return;
        }
        
        const groupedByDate = list.reduce((acc, entry) => {
            const date = entry.date || 'Kh√¥ng r√µ ng√†y';
            if (!acc[date]) { acc[date] = []; }
            acc[date].push(entry);
            return acc;
        }, {});
        let html = isSearchMode ? '' : `<div class="p-2 text-sm font-bold text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-600 mb-4">T·ªïng c·ªông: ${list.length} H√≥a ƒë∆°n ƒë√£ x√≥a</div>`;
        const sortedDates = Object.keys(groupedByDate).sort().reverse();
        
        sortedDates.forEach(dateKey => {
            const companiesOnDate = groupedByDate[dateKey];
            const formattedDate = formatDate(dateKey);
            html += `<div class="mt-4 border-l-4 border-red-600 pl-3 py-2 bg-red-50/70 dark:bg-red-900/70 rounded-r-lg shadow-sm">
                                 <h4 class="font-bold text-base text-gray-800 dark:text-gray-100">üìÖ NG√ÄY ${formattedDate}</h4>
                             </div>
                             <ul class="space-y-1 mt-2 mb-4">`;
                                                                companiesOnDate.forEach((company) => {
                const { id: invoiceId, name: invoiceName, link: invoiceLink, deletedAt, pharmacy } = company;
                const timeDeleted = deletedAt ? ` (X√≥a ${timeAgo(deletedAt)})` : '';
                                                html += `<li id="company-${invoiceId}" class="invoice-item flex items-center p-3 rounded-lg transition duration-100 bg-white dark:bg-gray-700 flex-col sm:flex-row sm:items-center">
                                 <span class="flex-grow text-gray-700 dark:text-gray-200 font-semibold flex items-center text-base w-full sm:w-auto mb-2 sm:mb-0">
                                     üìÑ ${invoiceName} <span class="text-xs text-gray-400 dark:text-gray-400 ml-2 block sm:inline">${timeDeleted}</span>
                                     ${invoiceLink ? `
                                         <a href="${invoiceLink}" target="_blank" rel="noopener noreferrer"
                                            title="M·ªü Link H√≥a ƒê∆°n ƒê√≠nh K√®m"
                                            class="ml-2 text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition duration-150 transform hover:scale-110 block sm:inline">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-7-5l-5 5m0 0h4m-4 0v4m-1-5l5-5" />
                                             </svg>
                                         </a>
                                     ` : ''}
                                 </span>
                                 <div class="flex space-x-2 ml-4 flex-shrink-0 w-full sm:w-auto justify-end sm:justify-normal">
                                     <button onclick="restoreInvoice('${invoiceId}', '${invoiceName}')" aria-label="Kh√¥i ph·ª•c h√≥a ƒë∆°n"
                                             title="Kh√¥i ph·ª•c H√≥a ƒë∆°n"
                                            class="text-green-500 dark:text-green-400 hover:text-green-700 p-1 rounded-full hover:bg-green-50 dark:hover:bg-gray-600 transition duration-150 flex-1 sm:flex-none">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                         </svg>
                                     </button>
                                     <button onclick="showDeleteModal('${pharmacy}', '${invoiceId}', '${invoiceName}', true)" aria-label="X√≥a vƒ©nh vi·ªÖn"
                                             title="X√≥a Vƒ©nh vi·ªÖn"
                                             class="text-red-500 dark:text-red-400 hover:text-red-700 p-1 rounded-full hover:bg-red-50 dark:hover:bg-gray-600 transition duration-150 flex-1 sm:flex-none">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
                                         </svg>
                                     </button>
                                 </div>
                             </li>`;
            });
            html += `</ul>`;
        });
        displayArea.innerHTML = html;
    }

    function getCombinedUncompletedList() {
        let allUncompleted = [];
        Object.keys(PHARMACY_MAP).forEach(pharmacyName => {
            if (pharmacyName === 'RecycleBin') return;
            const key = PHARMACY_MAP[pharmacyName];
            const list = AppStore[key].list || [];
            const uncompleted = list.filter(item => !item.completed && !item.readyForDeletionTimestamp && !item.isDeleted);
            uncompleted.forEach(item => {
                allUncompleted.push({ ...item, pharmacy: pharmacyName });
            });
        });

        // S·∫Øp x·∫øp theo th·ªùi gian t·∫°o c≈© nh·∫•t tr∆∞·ªõc
        allUncompleted.sort((a, b) => {
            const timeA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
            const timeB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
            return timeA - timeB;
        });

        return allUncompleted;
    }
    
    // =================================================================================
    // 4. C·∫¢I TI·∫æN: renderUncompletedOverview (Ph√¢n bi·ªát m√†u s·∫Øc NT)
    // =================================================================================
    function renderUncompletedOverview() {
        const container = document.getElementById('uncompletedOverviewContainer');
        const allUncompleted = AppStore['Uncompleted'].list;
        
        if (allUncompleted.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-6">üéâ Tuy·ªát v·ªùi! Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o c·∫ßn x·ª≠ l√Ω.</div>`;
            return;
        }

        let html = `<ul class="space-y-3">`; 
        const uncompletedIcon = `<svg class="w-5 h-5 text-gray-400 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        
        allUncompleted.forEach(invoice => {
            const invoiceDate = new Date(invoice.date + 'T00:00:00');
            const dateDiffMs = Date.now() - invoiceDate.getTime();
            const daysOld = Math.floor(dateDiffMs / ONE_DAY_MS);
            const timeElapsed = timeAgo(invoice.createdAt);
            
            // X·ª≠ l√Ω m√†u s·∫Øc theo NT
            let pharmacyColorClass = '';
            let pharmacyBadgeClass = '';
            let actionButtonBgClass = '';
            
            if (invoice.pharmacy === 'NT Tu·ªá Thi·ªán') {
                // Xanh D∆∞∆°ng (Blue)
                pharmacyColorClass = 'text-blue-600 dark:text-blue-400';
                pharmacyBadgeClass = 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300';
                actionButtonBgClass = 'bg-blue-50 dark:bg-blue-900/40 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900';
            } else if (invoice.pharmacy === 'NT H∆∞ng Th·ªãnh') {
                // Xanh L√° (Green)
                pharmacyColorClass = 'text-green-600 dark:text-green-400';
                pharmacyBadgeClass = 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300';
                actionButtonBgClass = 'bg-green-50 dark:bg-green-900/40 text-green-600 hover:bg-green-100 dark:hover:bg-green-900';
            }

            // X·ª≠ l√Ω m√†u c·∫£nh b√°o (∆Øu ti√™n c·∫£nh b√°o tu·ªïi th·ªç h∆°n m√†u NT cho t√™n h√≥a ƒë∆°n)
            let statusClass = 'text-gray-800 dark:text-gray-100'; 
            let statusEmoji = '‚ö†Ô∏è';
            let ageBadgeClass = '';
            
            if (daysOld >= 5) {
                statusClass = 'text-red-700 dark:text-red-400 font-extrabold';
                statusEmoji = 'üö®';
                ageBadgeClass = 'text-red-600 dark:text-red-400';
            } else if (daysOld >= 2) {
                statusClass = 'text-orange-600 dark:text-orange-400 font-semibold';
                statusEmoji = 'üü†';
                ageBadgeClass = 'text-orange-600 dark:text-orange-400';
            } else {
                 ageBadgeClass = 'text-gray-500 dark:text-gray-400';
            }
            
            const key = PHARMACY_MAP[invoice.pharmacy];
            
            html += `
                <li class="p-3 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm flex flex-col bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-gray-700 transition duration-150">
                    <div class="flex items-center justify-between mb-2 pb-2 border-b border-dashed border-gray-200 dark:border-gray-600">
                        <div class="flex items-center">
                            <button onclick="toggleCompletion('${invoice.pharmacy}', '${invoice.id}')"
                                title="ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh"
                                class="p-1 mr-3 rounded-full transition duration-150 transform hover:scale-110 bg-gray-100 dark:bg-gray-600 flex-shrink-0">
                                ${uncompletedIcon}
                            </button>
                            <span class="text-sm font-bold ${statusClass}">
                                ${statusEmoji} ${invoice.name}
                            </span>
                        </div>
                        <button onclick="scrollToInvoice('${key}', '${invoice.id}')"
                            title="M·ªü tab v√† cu·ªôn ƒë·∫øn h√≥a ƒë∆°n"
                            class="font-semibold transition duration-150 text-xs px-2 py-1 rounded-md shadow-sm flex-shrink-0 ${actionButtonBgClass}">
                            ‚ñ∂Ô∏è X·ª≠ L√Ω Ngay
                        </button>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center text-xs space-y-1 sm:space-y-0">
                        <span class="font-medium px-2 py-1 rounded-full whitespace-nowrap flex-shrink-0 ${pharmacyBadgeClass}">
                            üè† <strong class="${pharmacyColorClass}">${invoice.pharmacy}</strong> | Ng√†y l·∫≠p: ${formatDate(invoice.date)}
                        </span>
                        <span class="font-medium ml-0 sm:ml-2" title="Th·ªùi gian ch∆∞a ho√†n th√†nh k·ªÉ t·ª´ khi ƒë∆∞·ª£c th√™m v√†o h·ªá th·ªëng">
                            ‚è±Ô∏è Ch∆∞a x·ª≠ l√Ω: <strong class="${ageBadgeClass}">${timeElapsed}</strong>
                        </span>
                    </div>
                </li>
            `;
        });
        html += `</ul>`;
        container.innerHTML = html;
    }
    
    // =================================================================================
    // KH·ªûI T·∫†O APP
    // =================================================================================
    function initApp() {
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('app-container').classList.remove('opacity-0');
        
        registerObservers(); // ƒêƒÉng k√Ω c√°c h√†m render
        
        // V·∫´n t·∫£i d·ªØ li·ªáu cho c·∫£ hai nh√† thu·ªëc trong n·ªÅn
        Object.keys(PHARMACY_MAP).forEach(key => {
            if (key !== 'RecycleBin') {
                filterAndLoadInvoices(key, AppStore[key].filter, true);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
