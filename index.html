<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng H√≥a ƒê∆°n - Ultimate Luxury T·∫øt 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Pattaya&display=swap" rel="stylesheet">
    <style>
        /* --- 1. H·ªÜ TH·ªêNG M√ÄU S·∫ÆC LUXURY --- */
        :root {
            --ruby-red: #9f1239;
            /* Gradient V√†ng √Ånh Kim th·∫≠t s·ª± */
            --gold-metallic: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --glass: rgba(255, 255, 255, 0.92);
            /* Hi·ªáu ·ª©ng n·∫£y Bouncy */
            --smooth: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body { background: #fffcf5; font-family: 'Plus Jakarta Sans', sans-serif; color: #500724; overflow-x: hidden; }

        /* HEADER V·ªöI VI·ªÄN V√ÄNG √ÅNH KIM */
        .app-gradient {
            background: radial-gradient(circle at 50% 0%, #dc2626, #991b1b, #450a0a);
            position: relative;
            /* T·∫°o vi·ªÅn v√†ng √°nh kim */
            border-bottom: 5px solid transparent;
            border-image: var(--gold-metallic) 1;
            box-shadow: 0 20px 60px rgba(153, 27, 27, 0.4);
        }

        /* --- 2. HI·ªÜU ·ª®NG QU√âT S√ÅNG (SHIMMER) --- */
        .invoice-card {
            background: white; border: 1px solid #ffe4e6; border-radius: 24px;
            transition: all 0.4s var(--smooth); position: relative; overflow: hidden;
            border-left: 6px solid var(--ruby-red);
        }
        .invoice-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(220, 38, 38, 0.2);
            border-color: #fcd34d;
        }
        /* Lu·ªìng s√°ng qu√©t qua */
        .invoice-card::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.8), transparent);
            transform: skewX(-25deg); transition: 0.5s; pointer-events: none;
        }
        .invoice-card:hover::before { left: 150%; transition: 0.7s; }

        /* --- 3. D√ÄN L·ªíNG ƒê√àN 3D --- */
        .lantern-chain { position: absolute; top: -5px; width: 100%; display: flex; justify-content: space-evenly; z-index: 20; pointer-events: none; }
        .lantern-item {
            width: 45px; height: 60px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #991b1b);
            border-radius: 12px; position: relative;
            animation: swing 4s ease-in-out infinite;
            box-shadow: 0 15px 35px rgba(220, 38, 38, 0.6);
            border: 1px solid #fcd34d;
        }
        .lantern-item::before { content: ''; position: absolute; top: -20px; left: 50%; width: 2px; height: 20px; background: #b45309; }
        .lantern-item::after { content: 'üßß'; position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%); font-size: 16px; filter: drop-shadow(0 0 5px gold); }
        @keyframes swing { 0%, 100% { transform: rotate(-8deg); } 50% { transform: rotate(8deg); } }

        /* N√öT TAB CH·ªåN NH√Ä THU·ªêC */
        .tab-btn { font-weight: 700; color: rgba(255,255,255,0.7); transition: all 0.4s var(--smooth); position: relative; }
        .tab-btn.active { background: white; border-radius: 16px; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        /* M√†u ch·ªØ khi active */
        #tabTueThien.active { color: #2563eb !important; text-shadow: 0 0 10px rgba(37,99,235,0.3); }
        #tabHungThinh.active { color: #059669 !important; text-shadow: 0 0 10px rgba(5,150,105,0.3); }
        #tabPhucAn.active { color: #db2777 !important; text-shadow: 0 0 10px rgba(219,39,119,0.3); }

        /* --- 4. PANEL K√çNH M·ªú --- */
        .luxury-panel {
            background: var(--glass); backdrop-filter: blur(25px);
            border-radius: 3rem; border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 30px 80px -10px rgba(159, 18, 57, 0.15);
        }

        /* --- 5. MODAL BOUNCY (N·∫¢Y) --- */
        .modal-content { transform: scale(0.8); opacity: 0; transition: all 0.5s var(--smooth); }
        .flex .modal-content { transform: scale(1); opacity: 1; }

        /* C√ÇU ƒê·ªêI */
        .couplet { position: fixed; top: 140px; width: 130px; z-index: 90; pointer-events: none; filter: drop-shadow(5px 10px 10px rgba(0,0,0,0.3)); }
        .couplet-left { left: 20px; animation: float 6s ease-in-out infinite; }
        .couplet-right { right: 20px; animation: float 6s ease-in-out infinite 1s; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @media(max-width: 1500px) { .couplet { display: none; } }

        .btn-add { background: linear-gradient(135deg, #e11d48, #be123c); border: 2px solid #fcd34d; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.5); }
        .flower { position: fixed; pointer-events: none; z-index: 9999; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
        .tet-title { font-family: 'Pattaya', cursive; text-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* DASHBOARD ITEM */
        .dash-item { background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; }
    </style>
</head>
<body>
    <img src="https://lutaweb.com/wp-content/uploads/2021/12/chuc-tet-den-tram-dieu-nhu-y.png" class="couplet couplet-left">
    <img src="https://lutaweb.com/wp-content/uploads/2021/12/chuc-tet-den-tram-dieu-nhu-y-phai.png" class="couplet couplet-right">

    <div id="flower-container"></div>
    <div id="loadingIndicator" class="fixed inset-0 z-[999] flex items-center justify-center bg-white">
        <div class="w-16 h-16 border-4 border-orange-100 border-t-red-600 rounded-full animate-spin"></div>
    </div>
    <div id="toastContainer" class="fixed top-8 right-8 z-[1000] space-y-4 w-80 pointer-events-none"></div>

    <nav class="app-gradient pt-16 pb-28 px-4">
        <div class="lantern-chain">
            <div class="lantern-item"></div><div class="lantern-item"></div>
            <div class="lantern-item hidden md:block"></div><div class="lantern-item hidden md:block"></div>
            <div class="lantern-item"></div><div class="lantern-item"></div>
        </div>
        
        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] left-[-40px] w-48 opacity-90 pointer-events-none z-10 filter drop-shadow-2xl">
        <img src="https://img.icons8.com/color/480/bonsai.png" class="absolute bottom-[-30px] right-[-40px] w-48 opacity-90 pointer-events-none z-10 transform scale-x-[-1] filter drop-shadow-2xl">

        <div class="max-w-4xl mx-auto flex flex-col items-center relative z-20">
            <h1 class="text-5xl md:text-6xl font-800 text-white mb-10 tet-title uppercase italic tracking-wide">QU·∫¢N L√ù H√ìA ƒê∆†N 2026</h1>
            
            <div class="w-full max-w-xl bg-black/20 backdrop-blur-md p-2 rounded-[2rem] flex items-center border border-white/10 shadow-2xl">
                <button id="tabTueThien" onclick="togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien')" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Tu·ªá Thi·ªán</button>
                <button id="tabHungThinh" onclick="togglePharmacy('NT H∆∞ng Th·ªãnh', 'HungThinh')" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">H∆∞ng Th·ªãnh</button>
                <button id="tabPhucAn" onclick="togglePharmacy('NT Ph√∫c An', 'PhucAn')" class="tab-btn flex-1 py-4 uppercase rounded-2xl text-sm">Ph√∫c An</button>
            </div>

            <div class="w-full max-w-xl mt-10 grid grid-cols-3 gap-6 text-white">
                <div class="dash-item text-center p-4"><p id="totalCount" class="text-3xl font-900 text-yellow-300 drop-shadow-md">0</p><p class="text-[10px] font-bold uppercase opacity-70 tracking-widest mt-1">T·ªïng Kho üßß</p></div>
                <div class="dash-item text-center p-4"><p id="completedCount" class="text-3xl font-900 text-green-300 drop-shadow-md">0</p><p class="text-[10px] font-bold uppercase opacity-70 tracking-widest mt-1">ƒê√£ Xong üå∏</p></div>
                <div class="dash-item text-center p-4"><p id="pendingCount" class="text-3xl font-900 text-orange-200 drop-shadow-md">0</p><p class="text-[10px] font-bold uppercase opacity-70 tracking-widest mt-1">T·ªìn ƒê·ªçng üèÆ</p></div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 -mt-20 relative z-30 pb-32">
        <div class="luxury-panel p-8 md:p-12 min-h-[500px]">
            <div class="flex flex-col md:flex-row gap-5 mb-10">
                <div class="relative flex-1 rounded-[2rem]">
                    <input type="text" id="mainSearch" oninput="handleSearch(this.value)" placeholder="T√¨m ki·∫øm nh√† cung c·∫•p..." 
                           class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-rose-50/60 border-2 border-transparent focus:bg-white outline-none font-bold text-slate-700 shadow-inner transition-all">
                    <span class="absolute left-6 top-1/2 -translate-y-1/2 text-2xl">üîç</span>
                </div>
                <div class="flex bg-rose-50/80 p-2 rounded-[1.5rem] border border-rose-100 shadow-inner">
                    <button id="filterAll" onclick="changeFilter('all')" class="px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase transition-all">T·∫•t c·∫£</button>
                    <button id="filterUncompleted" onclick="changeFilter('uncompleted')" class="px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase transition-all hover:text-rose-700">Ch∆∞a xong</button>
                </div>
            </div>
            <div id="invoiceDisplay" class="space-y-8"></div>
        </div>
    </main>

    <div class="fixed bottom-10 right-10 flex flex-col gap-5 items-end z-[100]">
        <button onclick="cleanupCompleted()" class="w-16 h-16 bg-white border border-rose-100 text-rose-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 active:rotate-12 transition-all"><span class="text-3xl">üßπ</span></button>
        <button onclick="exportUncompletedToExcel()" class="w-16 h-16 bg-white border border-emerald-100 text-emerald-600 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all group relative">
            <span class="text-3xl group-hover:animate-bounce">üí∞</span>
            <span class="absolute -top-3 -right-3 text-[9px] bg-gradient-to-r from-emerald-500 to-emerald-400 text-white px-2 py-1 rounded-full font-black shadow-lg uppercase tracking-wider">Excel</span>
        </button>
        <button onclick="toggleRecycleBinModal()" class="w-16 h-16 bg-white border border-orange-100 text-orange-500 rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-all"><span class="text-3xl">üéÅ</span></button>
        <button onclick="openAddForm()" class="w-20 h-20 btn-add text-white rounded-[1.8rem] flex items-center justify-center hover:rotate-12 hover:scale-110 active:scale-90 transition-all shadow-2xl"><span class="text-5xl drop-shadow-md">üèÆ</span></button>
    </div>

    <div id="selectorModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[500] hidden items-center justify-center p-4 transition-opacity" onclick="closeSelector(event)">
        <div class="modal-content bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl border-t-[10px] border-rose-600 text-center" onclick="event.stopPropagation()">
            <h3 class="font-900 text-rose-800 text-sm uppercase tracking-[0.2em] mb-6">Chuy·ªÉn Nh√† Thu·ªëc üèÆ</h3>
            <div id="storeOptions" class="space-y-3"></div>
            <button onclick="document.getElementById('selectorModal').classList.replace('flex', 'hidden')" class="w-full mt-6 py-3 text-slate-400 font-bold text-xs uppercase">ƒê√≥ng l·∫°i</button>
        </div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[500] hidden items-center justify-center p-4 transition-opacity" onclick="closeForm(event)">
        <div class="modal-content bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl border-t-[12px] border-rose-600" onclick="event.stopPropagation()">
            <h3 id="modalTitle" class="text-3xl font-900 italic uppercase mb-8 text-rose-600 text-center drop-shadow-sm">H√≥a ƒê∆°n üßß</h3>
            <input type="hidden" id="formId">
            <div class="space-y-6">
                <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-2 tracking-widest">Nh√† cung c·∫•p</label><input type="text" id="formName" class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-lg"></div>
                <div><label class="block text-[11px] font-bold text-rose-600 uppercase mb-2 ml-2 tracking-widest">Ng√†y nh·∫≠n</label><input type="date" id="formDate" class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold"></div>
                <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-2 ml-2 tracking-widest">Link t√†i li·ªáu</label><input type="url" id="formLink" placeholder="https://..." class="w-full p-5 rounded-2xl bg-rose-50 border-2 border-transparent focus:border-rose-500 outline-none font-bold text-sm"></div>
                <div class="flex gap-4 pt-4"><button onclick="document.getElementById('modalOverlay').classList.replace('flex', 'hidden')" class="flex-1 py-4 font-bold text-slate-400 uppercase text-xs rounded-xl hover:bg-slate-50">H·ªßy B·ªè</button><button onclick="handleSave()" class="flex-[2] py-4 bg-gradient-to-r from-rose-600 to-red-500 text-white font-bold rounded-2xl shadow-xl uppercase text-xs hover:shadow-2xl active:scale-95 transition-all">L∆∞u D·ªØ Li·ªáu</button></div>
            </div>
        </div>
    </div>

    <div id="recycleModal" class="fixed inset-0 bg-black/60 backdrop-blur-lg z-[500] hidden items-center justify-center p-4 transition-opacity" onclick="toggleRecycleBinModal(event)">
        <div class="modal-content bg-white w-full max-w-lg rounded-[2.5rem] p-8 max-h-[80vh] flex flex-col shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-900 text-red-700 uppercase italic flex items-center gap-2">Th√πng R√°c <span class="text-3xl">üóëÔ∏è</span></h3><button onclick="document.getElementById('recycleModal').classList.replace('flex', 'hidden')" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-500 font-black hover:bg-red-50 hover:text-red-500">‚úï</button></div>
            <div id="recycleDisplay" class="flex-1 overflow-y-auto space-y-3 px-1"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyC737M2y1nwrGP48rEQ8dVhpV4DwUkysg", authDomain: "duanluutrunew.firebaseapp.com", projectId: "duanluutrunew", storageBucket: "duanluutrunew.appspot.com", messagingSenderId: "1008741702165", appId: "1:1008741702165:web:7e81901f4aac66cb9a0c1c" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const COLL = 'medx_invoices';
        let currentPharmacy = 'NT Tu·ªá Thi·ªán', currentFilter = 'all', invoices = [], unsub = null;

        window.addEventListener('keydown', (e) => { if (e.key === "Escape") { ['modalOverlay', 'selectorModal', 'recycleModal'].forEach(id => document.getElementById(id).classList.replace('flex', 'hidden')); } });
        function closeForm(e) { if(e.target.id === 'modalOverlay') e.target.classList.replace('flex', 'hidden'); }
        function closeSelector(e) { if(e.target.id === 'selectorModal') e.target.classList.replace('flex', 'hidden'); }
        function toggleRecycleBinModal(e) { const m = document.getElementById('recycleModal'); if (e && e.target.id !== 'recycleModal' && !e.target.closest('button[title="Th√πng r√°c"]')) return; if (m.classList.contains('hidden')) { m.classList.replace('hidden', 'flex'); loadRecycleData(); } else m.classList.replace('flex', 'hidden'); }

        function createFlower() {
            const container = document.getElementById('flower-container');
            const flower = document.createElement('div'); flower.className = 'flower';
            const img = document.createElement('img');
            img.src = Math.random() > 0.4 ? "https://lutaweb.com/wp-content/uploads/2022/01/hoa-mai-1.png" : "https://lutaweb.com/wp-content/uploads/2021/12/hoa-mai-2.png";
            img.style.width = Math.random() * 20 + 10 + 'px';
            flower.appendChild(img);
            flower.style.left = Math.random() * 100 + 'vw';
            flower.style.animationDuration = Math.random() * 5 + 8 + 's';
            container.appendChild(flower);
            setTimeout(() => flower.remove(), 13000);
        }
        setInterval(createFlower, 800);

        function showToast(msg, type='success') {
            const container = document.getElementById('toastContainer'); const id = Date.now();
            const html = `<div id="${id}" class="bg-gradient-to-r from-rose-900 to-red-800 text-white px-6 py-4 rounded-2xl shadow-2xl border-l-4 border-yellow-400 font-bold flex items-center gap-3 fade-in pointer-events-auto"><span class="text-2xl">${type === 'success' ? '‚ú®' : '‚ö†Ô∏è'}</span><span class="text-sm">${msg}</span></div>`;
            container.insertAdjacentHTML('beforeend', html);
            setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, 3500);
        }

        function togglePharmacy(name, themeId) {
            currentPharmacy = name; document.body.className = `theme-${themeId}`;
            document.getElementById('tabTueThien').classList.toggle('active', themeId === 'TueThien');
            document.getElementById('tabHungThinh').classList.toggle('active', themeId === 'HungThinh');
            document.getElementById('tabPhucAn').classList.toggle('active', themeId === 'PhucAn');
            loadData();
        }

        function loadData() {
            if (unsub) unsub();
            let q = db.collection(COLL).where('pharmacy', '==', currentPharmacy).where('isDeleted', '==', false).orderBy('date', 'desc');
            if (currentFilter === 'uncompleted') q = q.where('completed', '==', false);
            unsub = q.onSnapshot(snap => { invoices = []; snap.forEach(doc => invoices.push({ id: doc.id, ...doc.data() })); renderInvoices(invoices); });
        }

        function renderInvoices(data) {
            const display = document.getElementById('invoiceDisplay');
            document.getElementById('totalCount').innerText = data.length;
            document.getElementById('completedCount').innerText = data.filter(i => i.completed).length;
            document.getElementById('pendingCount').innerText = data.length - data.filter(i => i.completed).length;

            /* --- M√àO TH·∫¶N T√ÄI CHO TR·∫†NG TH√ÅI R·ªñNG --- */
            if (!data.length) { 
                display.innerHTML = `<div class="flex flex-col items-center justify-center py-20 opacity-70"><img src="https://img.icons8.com/external-flaticons-lineal-color-flat-icons/200/external-lucky-cat-chinese-new-year-flaticons-lineal-color-flat-icons-2.png" class="w-32 mb-4 animate-bounce"><p class="text-rose-800 font-black uppercase text-sm tracking-[0.3em]">Ch∆∞a c√≥ d·ªØ li·ªáu</p><p class="text-rose-400 text-xs mt-2 italic">H√£y th√™m h√≥a ƒë∆°n m·ªõi ƒë·ªÉ khai xu√¢n!</p></div>`; 
                return; 
            }

            const todayStr = new Date().toLocaleDateString('en-CA');
            const groups = data.reduce((acc, item) => { acc[item.date] = acc[item.date] || []; acc[item.date].push(item); return acc; }, {});
            
            let html = '';
            Object.keys(groups).sort().reverse().forEach(dateStr => {
                const d = new Date(dateStr); const dayOfWeek = d.toLocaleDateString('vi-VN', { weekday: 'long' });
                const items = groups[dateStr]; const dayTotal = items.length; const dayCompleted = items.filter(i => i.completed).length;
                let delayLabel = (dateStr < todayStr && items.some(i => !i.completed)) ? `<span class="bg-rose-600 text-white text-[10px] font-bold px-2 py-1 rounded-md ml-2 animate-pulse">TR·ªÑ H·∫†N</span>` : '';
                
                html += `<div class="mb-12">
                    <div class="date-sticky sticky top-[-1px] z-10 bg-[#fffcf5]/95 backdrop-blur-md py-4 flex items-center justify-between border-b-2 border-orange-100">
                        <div class="flex items-center gap-4">
                            <div class="bg-white border border-rose-200 rounded-2xl p-1 shadow-sm text-center min-w-[60px]"><div class="text-[10px] font-black text-rose-400 uppercase">Ng√†y</div><div class="text-2xl font-900 text-rose-800">${d.getDate()}</div></div>
                            <div><p class="text-xs font-bold text-rose-300 uppercase tracking-widest">Th√°ng ${d.getMonth()+1} ${delayLabel}</p><p class="text-xl font-800 text-rose-900">${dayOfWeek}</p></div>
                        </div>
                        <div class="text-right"><p class="text-[10px] font-bold text-rose-400 uppercase">Ti·∫øn ƒë·ªô</p><p class="text-lg font-900 text-slate-700"><span class="text-emerald-500">${dayCompleted}</span><span class="text-slate-300">/</span>${dayTotal}</p></div>
                    </div>
                    <div class="mt-4 space-y-4">`;
                
                items.forEach(item => {
                    const timeStr = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
                    html += `<div class="invoice-card flex items-center justify-between p-6 group">
                        <div class="flex items-center gap-5">
                            <button onclick="toggleStatus('${item.id}', ${item.completed})" class="w-12 h-12 rounded-full border-2 border-rose-100 flex items-center justify-center transition-all duration-500 ${item.completed ? 'bg-rose-600 text-yellow-300 rotate-[360deg] border-yellow-400 shadow-lg' : 'text-slate-300 hover:border-rose-400'}">${item.completed ? 'üå∏' : 'üèÆ'}</button>
                            <div><p class="font-bold text-lg ${item.completed ? 'line-through opacity-40 text-slate-500' : 'text-slate-800'} transition-all">${item.name}</p><p class="text-[10px] font-bold text-rose-300 uppercase tracking-wider">${timeStr}</p></div>
                        </div>
                        <div class="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openStoreSelector('${item.id}', '${item.pharmacy}')" class="p-3 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-100 transition-colors">üì¶</button>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="p-3 bg-blue-50 text-blue-500 rounded-xl hover:bg-blue-100 transition-colors">üîó</a>` : ''}
                            <button onclick="openEditForm('${item.id}')" class="p-3 bg-amber-50 text-amber-500 rounded-xl hover:bg-amber-100 transition-colors">‚úèÔ∏è</button>
                            <button onclick="confirmDelete('${item.id}')" class="p-3 bg-red-50 text-red-400 rounded-xl hover:bg-red-100 transition-colors">‚ùå</button>
                        </div>
                    </div>`;
                }); html += `</div></div>`;
            }); display.innerHTML = html;
        }

        async function cleanupCompleted() {
            const completedOnes = invoices.filter(i => i.completed && !i.isDeleted);
            if (!completedOnes.length) return showToast("Kh√¥ng c√≥ h√≥a ƒë∆°n ho√†n th√†nh!", "warning");
            if (!confirm(`D·ªçn d·∫πp ${completedOnes.length} h√≥a ƒë∆°n ƒë√£ xong?`)) return;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            try {
                const batch = db.batch();
                completedOnes.forEach(item => { const ref = db.collection(COLL).doc(item.id); batch.update(ref, { isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp() }); });
                await batch.commit(); showToast(`ƒê√£ d·ªçn d·∫πp ${completedOnes.length} m·ª•c!`, "success");
            } catch (e) { showToast("L·ªói h·ªá th·ªëng", "warning"); } finally { document.getElementById('loadingIndicator').classList.add('hidden'); }
        }

        async function toggleStatus(id, cur) { await db.collection(COLL).doc(id).update({ completed: !cur }); }
        function openStoreSelector(id, current) {
            const modal = document.getElementById('selectorModal'); const options = document.getElementById('storeOptions');
            const stores = [{ name: 'NT Tu·ªá Thi·ªán', col: 'bg-blue-600' }, { name: 'NT H∆∞ng Th·ªãnh', col: 'bg-emerald-600' }, { name: 'NT Ph√∫c An', col: 'bg-pink-600' }];
            options.innerHTML = stores.filter(s => s.name !== current).map(s => `<button onclick="executeTransfer('${id}', '${s.name}')" class="w-full p-4 ${s.col} text-white font-bold rounded-xl shadow-lg hover:scale-105 transition-transform uppercase text-xs tracking-wider mb-3">${s.name}</button>`).join('');
            modal.classList.replace('hidden', 'flex');
        }
        async function executeTransfer(id, target) { await db.collection(COLL).doc(id).update({ pharmacy: target }); document.getElementById('selectorModal').classList.replace('flex', 'hidden'); showToast(`ƒê√£ chuy·ªÉn sang ${target}`); }
        function openAddForm() { ['formId', 'formName', 'formLink'].forEach(id => document.getElementById(id).value = ''); document.getElementById('formDate').value = new Date().toLocaleDateString('en-CA'); document.getElementById('modalTitle').innerText = "Th√™m M·ªõi üßß"; document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); setTimeout(() => document.getElementById('formName').focus(), 100); }
        function openEditForm(id) { const item = invoices.find(i => i.id === id); document.getElementById('formId').value = item.id; document.getElementById('formName').value = item.name; document.getElementById('formDate').value = item.date; document.getElementById('formLink').value = item.link || ''; document.getElementById('modalTitle').innerText = "C·∫≠p Nh·∫≠t ‚úèÔ∏è"; document.getElementById('modalOverlay').classList.replace('hidden', 'flex'); }
        async function handleSave() { const name = document.getElementById('formName').value.trim(), date = document.getElementById('formDate').value, id = document.getElementById('formId').value; if (!name || !date) return showToast("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!", "warning"); const data = { name, date, link: document.getElementById('formLink').value.trim(), pharmacy: currentPharmacy }; if (id) await db.collection(COLL).doc(id).update(data); else await db.collection(COLL).add({ ...data, completed: false, isDeleted: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); document.getElementById('modalOverlay').classList.replace('flex', 'hidden'); showToast("L∆∞u th√†nh c√¥ng!"); }
        function confirmDelete(id) { if(confirm("Chuy·ªÉn v√†o th√πng r√°c?")) { db.collection(COLL).doc(id).update({ isDeleted: true, deletedAt: firebase.firestore.FieldValue.serverTimestamp() }); showToast("ƒê√£ chuy·ªÉn v√†o th√πng r√°c"); } }
        function loadRecycleData() { const area = document.getElementById('recycleDisplay'); db.collection(COLL).where('isDeleted', '==', true).orderBy('deletedAt', 'desc').limit(20).onSnapshot(snap => { if (snap.empty) { area.innerHTML = '<p class="text-center py-10 text-slate-300 italic">Th√πng r√°c tr·ªëng</p>'; return; } let html = ''; snap.forEach(doc => { const item = doc.data(); html += `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl mb-2 border border-slate-100"><div><p class="font-bold text-slate-700">${item.name}</p><p class="text-[10px] text-slate-400">${item.pharmacy}</p></div><div class="flex gap-2"><button onclick="restoreItem('${doc.id}')" class="text-blue-500 font-bold text-xs bg-blue-50 px-3 py-1.5 rounded-lg">Kh√¥i ph·ª•c</button><button onclick="hardDelete('${doc.id}')" class="text-red-400 hover:text-red-600 px-2">‚úï</button></div></div>`; }); area.innerHTML = html; }); }
        async function restoreItem(id) { await db.collection(COLL).doc(id).update({ isDeleted: false }); showToast("ƒê√£ kh√¥i ph·ª•c!"); }
        async function hardDelete(id) { if(confirm("X√≥a vƒ©nh vi·ªÖn kh√¥ng th·ªÉ kh√¥i ph·ª•c?")) await db.collection(COLL).doc(id).delete(); }
        function changeFilter(type) { currentFilter = type; document.getElementById('filterAll').className = type === 'all' ? "px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase transition-all" : "px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase transition-all hover:text-rose-700"; document.getElementById('filterUncompleted').className = type === 'uncompleted' ? "px-6 py-3 text-xs font-900 rounded-2xl bg-rose-600 text-white shadow-lg uppercase transition-all" : "px-6 py-3 text-xs font-900 rounded-2xl text-rose-900/50 uppercase transition-all hover:text-rose-700"; loadData(); }
        function exportUncompletedToExcel() { const data = invoices.filter(i => !i.completed); if (!data.length) return showToast("Kh√¥ng c√≥ m·ª•c t·ªìn ƒë·ªçng!", "warning"); for(let i=0; i<30; i++) { setTimeout(createFlower, i*30); } const rows = data.map((i, idx) => ({ "STT": idx + 1, "Ng√†y": i.date, "Nh√† Cung C·∫•p": i.name, "Nh√† Thu·ªëc": i.pharmacy })); const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "T·ªìn Kho T·∫øt"); XLSX.writeFile(wb, `BAO_CAO_TON_TET_${currentPharmacy}.xlsx`); showToast("Xu·∫•t file th√†nh c√¥ng! üßß"); }
        function handleSearch(v) { renderInvoices(invoices.filter(i => i.name.toLowerCase().includes(v.toLowerCase()))); }
        window.onload = () => { setTimeout(() => { document.getElementById('loadingIndicator').classList.add('hidden'); togglePharmacy('NT Tu·ªá Thi·ªán', 'TueThien'); }, 1000); };
    </script>
</body>
</html>

