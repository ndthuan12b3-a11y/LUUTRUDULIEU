<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng L∆∞u Tr·ªØ H√≥a ƒê∆°n Theo Ng√†y (Local Storage) - V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ƒê·∫£m b·∫£o khung n·ªôi dung ƒë∆∞·ª£c cƒÉn gi·ªØa v√† c√≥ k√≠ch th∆∞·ªõc t·ªëi ƒëa h·ª£p l√Ω */
        #app-container {
            max-width: 900px; /* TƒÉng k√≠ch th∆∞·ªõc t·ªëi ƒëa */
            margin: 0 auto;
            padding: 1rem;
        }
        /* Custom scrollbar style for modern look */
        .modern-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .modern-scroll::-webkit-scrollbar-thumb {
            background-color: #a7f3d0; /* green-200 */
            border-radius: 10px;
        }
        /* ƒê·∫£m b·∫£o Modal v√† Toast lu√¥n n·∫±m tr√™n c√πng */
        .z-50 {
            z-index: 50;
        }
        /* D√†nh cho n√∫t + n·∫±m c·ªë ƒë·ªãnh b√™n trong tab */
        .sticky-plus {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 20;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans" onload="initTabs()">
    <div id="toastContainer" class="fixed top-5 right-5 z-[100] space-y-2">
        </div>

    <div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-70 z-[101] flex items-center justify-center">
        <div class="p-4 bg-green-100 rounded-lg shadow-xl flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
            <p class="text-green-800 font-semibold">ƒêang t·∫£i ·ª©ng d·ª•ng...</p>
        </div>
    </div>

    <div id="app-container" class="bg-white shadow-xl rounded-xl p-6 md:p-8 opacity-0 transition duration-500">
        <h1 class="text-3xl font-extrabold text-center text-green-700 mb-6 border-b-2 pb-2">DANH S√ÅCH H√ìA ƒê∆†N MEDX</h1>

        <div class="mb-8 p-4 bg-red-50 border border-red-200 rounded-xl shadow-md">
            <h2 class="text-xl font-bold text-red-700 mb-3 flex items-center border-b pb-2">
                üî¥ H√ìA ƒê∆†N CH∆ØA HO√ÄN TH√ÄNH
            </h2>
            <div id="uncompletedOverviewContainer" class="p-2 bg-white rounded-lg border border-gray-100 h-40 overflow-y-auto modern-scroll">
                <div class="text-center text-gray-500 py-6">ƒêang t·∫£i danh s√°ch h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh...</div>
            </div>
        </div>
        <div class="flex justify-center border-b-2 border-gray-200 mb-4">
            <button id="tabTueThien" onclick="showPharmacy('NT Tu·ªá Thi·ªán', 'TueThien')" class="py-2 px-4 text-sm font-semibold focus:outline-none transition duration-150 border-transparent hover:bg-gray-100 rounded-t-lg">
                <h3 class="font-bold text-lg text-green-800 text-center">NH√Ä THU·ªêC TU·ªÜ THI·ªÜN</h3>
            </button>

            <button id="tabHungThinh" onclick="showPharmacy('NT H∆∞ng Th·ªãnh', 'HungThinh')" class="py-2 px-4 text-sm font-semibold focus:outline-none transition duration-150 border-transparent hover:bg-gray-100 rounded-t-lg">
                <h3 class="font-bold text-lg text-green-800 text-center">NH√Ä THU·ªêC H∆ØNG TH·ªäNH</h3>
            </button>
        </div>

        <div id="contentTueThien" class="pharmacy-content hidden p-4 border border-gray-200 rounded-lg bg-green-50/50 shadow-inner relative">
            
            <div class="mb-3">
                <input type="text" id="searchTueThien" oninput="searchInvoices('NT Tu·ªá Thi·ªán', 'TueThien', this.value)" 
                       placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n theo t√™n..." 
                       class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
            </div>

            <div id="displayTueThien" class="text-sm text-gray-800 bg-white p-3 rounded-md font-sans h-80 overflow-y-auto border border-gray-200 modern-scroll">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>

            <div class="mt-3 pt-3 flex justify-end sticky-plus">
                <button onclick="toggleInvoiceForm('TueThien')" class="bg-green-600 text-white p-3 rounded-full shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>

            <div id="formTueThien" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center p-4 rounded-lg z-10">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm border border-green-300">
                    <h4 id="formTitleTueThien" class="text-lg font-semibold mb-3 text-gray-700">Th√™m H√≥a ƒê∆°n M·ªõi</h4>

                    <input type="hidden" id="inputTueThienId" value="">

                    <input type="text" id="inputTueThienName" placeholder="Nh·∫≠p t√™n H√≥a ƒë∆°n" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3">
                    <input type="date" id="inputTueThienDate" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3">
                    <input type="url" id="inputTueThienLink" placeholder="Nh·∫≠p Link (URL) ƒë√≠nh k√®m (T√πy ch·ªçn)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3">

                    <div class="flex justify-end space-x-2">
                        <button onclick="toggleInvoiceForm('TueThien')" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400 transition duration-150 text-sm">
                            H·ªßy
                        </button>
                        <button id="saveButtonTueThien" onclick="saveInvoice('NT Tu·ªá Thi·ªán', 'inputTueThienName', 'inputTueThienDate', 'inputTueThienLink', 'inputTueThienId')" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 text-sm">
                            L∆∞u
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="contentHungThinh" class="pharmacy-content hidden p-4 border border-gray-200 rounded-lg bg-green-50/50 shadow-inner relative">

            <div class="mb-3">
                <input type="text" id="searchHungThinh" oninput="searchInvoices('NT H∆∞ng Th·ªãnh', 'HungThinh', this.value)" 
                       placeholder="üîç T√¨m ki·∫øm h√≥a ƒë∆°n theo t√™n..." 
                       class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
            </div>

            <div id="displayHungThinh" class="text-sm text-gray-800 bg-white p-3 rounded-md font-sans h-80 overflow-y-auto border border-gray-200 modern-scroll">Ch∆∞a t·∫£i d·ªØ li·ªáu...</div>

            <div class="mt-3 pt-3 flex justify-end sticky-plus">
                <button onclick="toggleInvoiceForm('HungThinh')" class="bg-green-600 text-white p-3 rounded-full shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>

            <div id="formHungThinh" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center p-4 rounded-lg z-10">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm border border-green-300">
                    <h4 id="formTitleHungThinh" class="text-lg font-semibold mb-3 text-gray-700">Th√™m H√≥a ƒê∆°n M·ªõi</h4>

                    <input type="hidden" id="inputHungThinhId" value="">

                    <input type="text" id="inputHungThinhName" placeholder="Nh·∫≠p t√™n H√≥a ƒë∆°n" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3">
                    <input type="date" id="inputHungThinhDate" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3">
                    <input type="url" id="inputHungThinhLink" placeholder="Nh·∫≠p Link (URL) ƒë√≠nh k√®m (T√πy ch·ªçn)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm mb-3">

                    <div class="flex justify-end space-x-2">
                        <button onclick="toggleInvoiceForm('HungThinh')" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400 transition duration-150 text-sm">
                            H·ªßy
                        </button>
                        <button id="saveButtonHungThinh" onclick="saveInvoice('NT H∆∞ng Th·ªãnh', 'inputHungThinhName', 'inputHungThinhDate', 'inputHungThinhLink', 'inputHungThinhId')" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 text-sm">
                            L∆∞u
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-red-600 mb-3">X√°c nh·∫≠n X√≥a H√≥a ƒê∆°n</h3>
            <p class="text-gray-700 mb-4" id="deleteConfirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y kh√¥ng?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-md hover:bg-gray-400 text-sm">
                    H·ªßy
                </button>
                <button onclick="performDelete()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 text-sm">
                    X√≥a Vƒ©nh Vi·ªÖn
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- GLOBAL DEFINITIONS ---
        const PHARMACY_MAP = {
            'NT Tu·ªá Thi·ªán': 'TueThien',
            'NT H∆∞ng Th·ªãnh': 'HungThinh'
        };
        // 24 gi·ªù t√≠nh b·∫±ng milliseconds
        const ONE_DAY_MS = 24 * 60 * 60 * 1000;
        // M·ª•c ti√™u x√≥a hi·ªán t·∫°i
        let currentDeleteTarget = { pharmacyName: null, invoiceId: null };
        // Cache d·ªØ li·ªáu c·ª•c b·ªô ƒë·ªÉ d·ªÖ d√†ng ch·ªânh s·ª≠a/ki·ªÉm tra (D·ªØ li·ªáu g·ªëc ch∆∞a l·ªçc)
        let currentInvoiceLists = {};
        // Cache d·ªØ li·ªáu ƒë√£ l·ªçc/t√¨m ki·∫øm ƒë·ªÉ render
        let renderedInvoiceLists = {};

        // --- LOCAL STORAGE UTILITIES ---

        /**
         * L·∫•y key localStorage cho m·ªôt Nh√† thu·ªëc c·ª• th·ªÉ.
         */
        function getLocalStorageKey(pharmacyName) {
            return `MEDX_INVOICES_${pharmacyName}`;
        }

        /**
         * T·∫£i danh s√°ch h√≥a ƒë∆°n t·ª´ localStorage.
         */
        function loadInvoices(pharmacyName) {
            const key = getLocalStorageKey(pharmacyName);
            try {
                const data = localStorage.getItem(key);
                const list = data ? JSON.parse(data) : [];
                // ƒê·∫£m b·∫£o ID l√† string v√† timestamp l√† number
                return list.map(item => ({
                    ...item,
                    id: item.id ? item.id.toString() : Date.now().toString(), // G√°n ID m·ªõi n·∫øu thi·∫øu
                    readyForDeletionTimestamp: typeof item.readyForDeletionTimestamp === 'number' ? item.readyForDeletionTimestamp : undefined,
                    link: item.link || '' // ƒê·∫£m b·∫£o tr∆∞·ªùng link t·ªìn t·∫°i
                }));
            } catch (e) {
                console.error("L·ªói khi t·∫£i ho·∫∑c ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ localStorage:", e);
                return [];
            }
        }

        /**
         * L∆∞u to√†n b·ªô danh s√°ch h√≥a ƒë∆°n tr·ªü l·∫°i localStorage.
         * Sau khi l∆∞u, t·ª± ƒë·ªông k√≠ch ho·∫°t qu√° tr√¨nh t·∫£i v√† render UI (th√¥ng qua startLocalListeners).
         */
        function saveAllInvoices(pharmacyName, list) {
            const key = getLocalStorageKey(pharmacyName);
            try {
                localStorage.setItem(key, JSON.stringify(list));
                
                // C·∫≠p nh·∫≠t cache g·ªëc v√† render l·∫°i UI
                currentInvoiceLists[pharmacyName] = list; 
                
                // Ch·ªâ render l·∫°i danh s√°ch c·ªßa nh√† thu·ªëc n√†y v√† t·ªïng quan
                const pharmacyKey = PHARMACY_MAP[pharmacyName];
                const displayElementId = `display${pharmacyKey}`;
                
                // Lu√¥n g·ªçi h√†m render ch√≠nh v·ªõi danh s√°ch g·ªëc sau khi l∆∞u
                const filteredList = runAutoCleanupAndFiltering(pharmacyName, list);

                // D√πng danh s√°ch ƒë√£ ƒë∆∞·ª£c l·ªçc/d·ªçn d·∫πp ƒë·ªÉ render
                renderPharmacyList(pharmacyName, displayElementId, filteredList);
                renderUncompletedOverview();

                return true;
            } catch (e) {
                console.error("L·ªói khi l∆∞u d·ªØ li·ªáu v√†o localStorage:", e);
                showToast('L·ªói khi l∆∞u d·ªØ li·ªáu c·ª•c b·ªô.', 'error');
                return false;
            }
        }

        /**
         * Logic T·ª∞ ƒê·ªòNG D·ªåN D·∫∏P D·ªÆ LI·ªÜU C≈® (N·∫øu h·∫øt 24h sau khi ho√†n th√†nh nh√≥m).
         * Tr·∫£ v·ªÅ danh s√°ch ƒë√£ ƒë∆∞·ª£c l·ªçc (ho·∫∑c danh s√°ch g·ªëc n·∫øu kh√¥ng c√≥ thay ƒë·ªïi).
         */
        function runAutoCleanupAndFiltering(pharmacyName, list) {
            const now = Date.now();
            let hasChanged = false;

            // L·ªçc ra nh·ªØng m·ª•c ƒë√£ h·∫øt h·∫°n x√≥a
            const filteredList = list.filter(c => {
                if (c.readyForDeletionTimestamp && now > c.readyForDeletionTimestamp) {
                    hasChanged = true;
                    return false; // B·ªè qua m·ª•c n√†y
                }
                return true;
            });

            // N·∫øu c√≥ m·ª•c b·ªã x√≥a t·ª± ƒë·ªông, T·ª∞ ƒê·ªòNG L∆ØU l·∫°i localStorage v√† th√¥ng b√°o.
            if (hasChanged) {
                localStorage.setItem(getLocalStorageKey(pharmacyName), JSON.stringify(filteredList));
                showToast(`ƒê√£ t·ª± ƒë·ªông x√≥a c√°c h√≥a ƒë∆°n h·∫øt h·∫°n t·ª´ ${pharmacyName}.`, 'info');
                return filteredList;
            }
            
            return filteredList; // Tr·∫£ v·ªÅ danh s√°ch ƒë√£ d·ªçn d·∫πp (n·∫øu kh√¥ng c√≥ g√¨ b·ªã x√≥a, list g·ªëc)
        }


        // --- UTILITY FUNCTIONS START HERE ---

        /**
         * L·∫•y ng√†y hi·ªán t·∫°i ·ªü ƒë·ªãnh d·∫°ng YYYY-MM-DD.
         */
        function getCurrentDateKey() {
            const d = new Date();
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            let year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        /**
         * ƒê·ªãnh d·∫°ng l·∫°i ng√†y t·ª´ YYYY-MM-DD sang DD/MM/YYYY ƒë·ªÉ hi·ªÉn th·ªã.
         */
        function formatDate(dateKey) {
            if (!dateKey) return 'Kh√¥ng r√µ ng√†y';
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateKey;
        }

        /**
         * H√†m hi·ªÉn th·ªã th√¥ng b√°o Toast.
         */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const id = Date.now();
            let bgColor, icon;

            switch (type) {
                case 'error':
                    bgColor = 'bg-red-600';
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    break;
                case 'info':
                    bgColor = 'bg-blue-600';
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    break;
                case 'success':
                default:
                    bgColor = 'bg-green-600';
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    break;
            }

            const toastHtml = `
                <div id="toast-${id}" class="flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg opacity-0 transform translate-x-full transition-all duration-300">
                    ${icon}
                    <p class="ml-3">${message}</p>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(`toast-${id}`);

            // Animate in
            setTimeout(() => {
                toastElement.style.transform = 'translateX(0)';
                toastElement.style.opacity = '1';
            }, 10);

            // Animate out and remove after 3 seconds
            setTimeout(() => {
                toastElement.style.transform = 'translateX(150%)';
                toastElement.style.opacity = '0';
                setTimeout(() => {
                    toastElement.remove();
                }, 300);
            }, 3000);
        }

        /**
         * ·∫®n/Hi·ªán form nh·∫≠p h√≥a ƒë∆°n m·ªõi (form overlay) v√† reset tr·∫°ng th√°i form.
         */
        function toggleInvoiceForm(key) {
            const formElement = document.getElementById(`form${key}`);
            const nameInput = document.getElementById(`input${key}Name`);
            const dateInput = document.getElementById(`input${key}Date`);
            const linkInput = document.getElementById(`input${key}Link`); // <<< M·ªõi
            const idInput = document.getElementById(`input${key}Id`);
            const formTitle = document.getElementById(`formTitle${key}`);
            const saveButton = document.getElementById(`saveButton${key}`);

            if (formElement.classList.contains('hidden')) {
                formElement.classList.remove('hidden');

                // Reset form state to "Add New"
                nameInput.value = '';
                dateInput.value = getCurrentDateKey();
                linkInput.value = ''; // <<< M·ªõi
                idInput.value = '';

                formTitle.textContent = 'Th√™m H√≥a ƒê∆°n M·ªõi';
                saveButton.textContent = 'L∆∞u';
                saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveButton.classList.add('bg-green-600', 'hover:bg-green-700');

                setTimeout(() => {
                    nameInput.focus();
                }, 50);
            } else {
                formElement.classList.add('hidden');
                nameInput.value = '';
                dateInput.value = '';
                linkInput.value = ''; // <<< M·ªõi
                idInput.value = '';
                nameInput.classList.remove('border-red-500', 'ring-red-500', 'border-orange-500', 'ring-orange-500');
            }
        }

        /**
         * Logic ƒë·ªÉ b·∫Øt ƒë·∫ßu ch·ªânh s·ª≠a m·ªôt h√≥a ƒë∆°n.
         */
        function startEditInvoice(pharmacyName, invoiceId) {
            const list = currentInvoiceLists[pharmacyName] || [];
            const invoiceToEdit = list.find(c => c.id === invoiceId);

            if (!invoiceToEdit) return;

            const key = PHARMACY_MAP[pharmacyName];
            const nameInput = document.getElementById(`input${key}Name`);
            const dateInput = document.getElementById(`input${key}Date`);
            const linkInput = document.getElementById(`input${key}Link`); // <<< M·ªõi
            const idInput = document.getElementById(`input${key}Id`);
            const formTitle = document.getElementById(`formTitle${key}`);
            const saveButton = document.getElementById(`saveButton${key}`);

            // 1. ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            nameInput.value = invoiceToEdit.name;
            dateInput.value = invoiceToEdit.date;
            linkInput.value = invoiceToEdit.link || ''; // <<< M·ªõi
            idInput.value = invoiceToEdit.id;

            // 2. C·∫≠p nh·∫≠t giao di·ªán form
            formTitle.textContent = 'Ch·ªânh S·ª≠a H√≥a ƒê∆°n';
            saveButton.textContent = 'C·∫≠p Nh·∫≠t';
            saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveButton.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // 3. Hi·ªÉn th·ªã form
            const formElement = document.getElementById(`form${key}`);
            formElement.classList.remove('hidden');
            setTimeout(() => {
                nameInput.focus();
            }, 50);
        }

        /**
         * Hi·ªÉn th·ªã modal x√°c nh·∫≠n x√≥a.
         */
        function showDeleteModal(pharmacyName, invoiceId, invoiceName) {
            currentDeleteTarget = { pharmacyName, invoiceId };
            document.getElementById('deleteConfirmMessage').innerHTML = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën **x√≥a vƒ©nh vi·ªÖn** h√≥a ƒë∆°n **${invoiceName}** kh·ªèi ${pharmacyName} kh√¥ng?`;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        /**
         * Th·ª±c hi·ªán x√≥a h√≥a ƒë∆°n sau khi x√°c nh·∫≠n.
         */
        function performDelete() {
            const { pharmacyName, invoiceId } = currentDeleteTarget;

            if (!pharmacyName || !invoiceId) {
                hideDeleteModal();
                return;
            }

            let list = loadInvoices(pharmacyName);

            // L·ªçc h√≥a ƒë∆°n c·∫ßn x√≥a
            const initialLength = list.length;
            list = list.filter(item => item.id !== invoiceId);

            if (list.length < initialLength) {
                // S·ª≠ d·ª•ng saveAllInvoices ƒë·ªÉ t·ª± ƒë·ªông c·∫≠p nh·∫≠t UI
                saveAllInvoices(pharmacyName, list);
                showToast(`ƒê√£ X√ìA h√≥a ƒë∆°n th√†nh c√¥ng!`, 'error');
            } else {
                showToast(`L·ªói: Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ƒë·ªÉ x√≥a.`, 'error');
            }

            hideDeleteModal();
        }

        /**
         * ·∫®n modal x√°c nh·∫≠n x√≥a v√† reset m·ª•c ti√™u.
         */
        function hideDeleteModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            currentDeleteTarget = { pharmacyName: null, invoiceId: null };
        }
        
        /**
         * H·ªßy b·ªè vi·ªác ƒë√°nh d·∫•u x√≥a t·ª± ƒë·ªông (readyForDeletionTimestamp) cho t·∫•t c·∫£ h√≥a ƒë∆°n c√πng m·ªôt ng√†y.
         * N√¢ng c·∫•p: ƒê·∫∑t l·∫°i tr·∫°ng th√°i ho√†n th√†nh th√†nh FALSE ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n.
         */
        function cancelGroupDeletion(pharmacyName, dateKey) {
            let list = loadInvoices(pharmacyName);
            let hasChanged = false;

            // Lo·∫°i b·ªè timestamp x√≥a kh·ªèi t·∫•t c·∫£ h√≥a ƒë∆°n trong ng√†y ƒë√≥
            list = list.map(c => {
                if (c.date === dateKey && c.readyForDeletionTimestamp) {
                    hasChanged = true;
                    // Lo·∫°i b·ªè timestamp
                    const { readyForDeletionTimestamp, ...rest } = c;
                    return { ...rest, completed: false }; // ƒê·∫∑t l·∫°i tr·∫°ng th√°i ho√†n th√†nh th√†nh FALSE
                }
                return c;
            });

            if (hasChanged) {
                saveAllInvoices(pharmacyName, list); // T·ª± ƒë·ªông render l·∫°i
                showToast(`ƒê√£ H·ª¶Y b·ªè vi·ªác x√≥a t·ª± ƒë·ªông cho ng√†y ${formatDate(dateKey)}. H√≥a ƒë∆°n ƒë∆∞·ª£c ƒë·∫∑t l·∫°i l√† CH∆ØA ho√†n th√†nh.`, 'info');
            }
        }


        /**
         * C·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n th√†nh (completed) cho m·ªôt h√≥a ƒë∆°n c·ª• th·ªÉ V√Ä ki·ªÉm tra xo√° nh√≥m n·∫øu ho√†n th√†nh h·∫øt.
         */
        function toggleCompletion(pharmacyName, invoiceId) {
            let list = loadInvoices(pharmacyName);
            const originalCompanyIndex = list.findIndex(c => c.id === invoiceId);

            if (originalCompanyIndex === -1) return;

            const originalCompany = list[originalCompanyIndex];
            const newCompletedState = !originalCompany.completed;
            const dateKey = originalCompany.date;
            
            // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa h√≥a ƒë∆°n
            list[originalCompanyIndex].completed = newCompletedState;

            // 2. Ki·ªÉm tra nh√≥m ng√†y v√† ƒë·∫∑t/x√≥a timestamp x√≥a
            const companiesInDay = list.filter(c => c.date === dateKey);
            const allCompletedAfterUpdate = companiesInDay.every(c => c.completed);
            
            let toastMessage;

            if (allCompletedAfterUpdate) {
                // N·∫øu t·∫•t c·∫£ ƒë√£ ho√†n th√†nh, ƒê√ÅNH D·∫§U ƒë·ªÉ xo√° sau 24 gi·ªù
                const deletionTime = Date.now() + ONE_DAY_MS;

                list = list.map(c => {
                    if (c.date === dateKey) {
                        return { ...c, readyForDeletionTimestamp: deletionTime };
                    }
                    return c;
                });
                toastMessage = `Ng√†y ${formatDate(dateKey)} ƒë√£ ho√†n th√†nh 100% v√† ƒë∆∞·ª£c ƒë√°nh d·∫•u x√≥a sau 24 gi·ªù.`;

            } else {
                // N·∫øu ch∆∞a ho√†n th√†nh h·∫øt, x√≥a timestamp x√≥a (n·∫øu c√≥)
                list = list.map(c => {
                    if (c.date === dateKey && c.readyForDeletionTimestamp) {
                        // Lo·∫°i b·ªè timestamp
                        const { readyForDeletionTimestamp, ...rest } = c;
                        return rest;
                    }
                    return c;
                });
                toastMessage = newCompletedState ? `H√≥a ƒë∆°n ƒë√£ ho√†n th√†nh.` : `H√≥a ƒë∆°n "${originalCompany.name}" ch∆∞a ho√†n th√†nh.`;
            }

            // L∆∞u l·∫°i danh s√°ch ƒë√£ c·∫≠p nh·∫≠t (t·ª± ƒë·ªông render l·∫°i)
            saveAllInvoices(pharmacyName, list);
            showToast(toastMessage, allCompletedAfterUpdate ? 'info' : 'success');
        }

        /**
         * L∆∞u (Th√™m m·ªõi ho·∫∑c C·∫≠p nh·∫≠t) m·ªôt h√≥a ƒë∆°n.
         */
        function saveInvoice(pharmacyName, inputNameId, inputDateId, inputLinkId, inputIdId) { // <<< Th√™m inputLinkId
            const companyInput = document.getElementById(inputNameId);
            const dateInput = document.getElementById(inputDateId);
            const linkInput = document.getElementById(inputLinkId); // <<< M·ªõi
            const idInput = document.getElementById(inputIdId);

            const invoiceId = idInput.value.trim();
            const invoiceName = companyInput.value.trim();
            const dateKey = dateInput.value.trim() || getCurrentDateKey();
            const invoiceLink = linkInput.value.trim(); // <<< M·ªõi

            let successMessage;

            if (invoiceName === "") {
                companyInput.classList.add('border-red-500', 'ring-red-500');
                showToast('T√™n h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error');
                setTimeout(() => {
                    companyInput.classList.remove('border-red-500', 'ring-red-500');
                }, 1000);
                return;
            }

            let list = loadInvoices(pharmacyName);

            // Ki·ªÉm tra tr√πng l·∫∑p t√™n
            const nameExists = list.some(item =>
                item.name.toLowerCase() === invoiceName.toLowerCase() && item.id !== invoiceId
            );

            if (nameExists) {
                companyInput.classList.add('border-orange-500', 'ring-orange-500');
                setTimeout(() => {
                    companyInput.classList.remove('border-orange-500', 'ring-orange-500');
                }, 1000);
                showToast('T√™n h√≥a ƒë∆°n ƒë√£ t·ªìn t·∫°i.', 'error');
                return;
            }

            // --- CH·∫æ ƒê·ªò C·∫¨P NH·∫¨T ---
            if (invoiceId) {
                const index = list.findIndex(item => item.id === invoiceId);
                if (index !== -1) {
                    list[index].name = invoiceName;
                    list[index].date = dateKey;
                    list[index].link = invoiceLink; // <<< M·ªõi
                    successMessage = `H√≥a ƒë∆°n "${invoiceName}" ƒë√£ ƒë∆∞·ª£c C·∫¨P NH·∫¨T th√†nh c√¥ng!`;
                }
            }
            // --- CH·∫æ ƒê·ªò TH√äM M·ªöI ---
            else {
                const newInvoice = {
                    id: Date.now().toString(), // ID duy nh·∫•t
                    name: invoiceName,
                    date: dateKey,
                    link: invoiceLink, // <<< M·ªõi
                    completed: false,
                    createdAt: Date.now()
                };
                list.push(newInvoice);
                successMessage = `ƒê√£ TH√äM h√≥a ƒë∆°n "${invoiceName}" m·ªõi.`;
            }

            if (saveAllInvoices(pharmacyName, list)) { // G·ªçi saveAllInvoices ƒë·ªÉ t·ª± ƒë·ªông render
                const key = PHARMACY_MAP[pharmacyName];
                toggleInvoiceForm(key);
                showToast(successMessage, invoiceId ? 'info' : 'success');
            }
        }

        /**
         * Logic t√¨m ki·∫øm. L·ªçc danh s√°ch g·ªëc v√† render l·∫°i.
         */
        function searchInvoices(pharmacyName, key, searchTerm) {
            const list = currentInvoiceLists[pharmacyName] || [];
            const displayElementId = `display${key}`;
            const query = searchTerm.toLowerCase().trim();

            let listToRender = list;

            if (query.length > 0) {
                listToRender = list.filter(invoice =>
                    invoice.name.toLowerCase().includes(query) || 
                    formatDate(invoice.date).includes(query) // Cho ph√©p t√¨m theo ng√†y (DD/MM/YYYY)
                );
            }
            
            // Render danh s√°ch ƒë√£ l·ªçc/t√¨m ki·∫øm
            renderPharmacyList(pharmacyName, displayElementId, listToRender, true); // true: kh√¥ng ch·∫°y cleanup
        }


        /**
         * T·∫£i d·ªØ li·ªáu t·ª´ localStorage, nh√≥m theo ng√†y v√† hi·ªÉn th·ªã danh s√°ch b·∫±ng HTML c√≥ c·∫•u tr√∫c.
         * @param {string} pharmacyName T√™n nh√† thu·ªëc ('NT Tu·ªá Thi·ªán' / 'NT H∆∞ng Th·ªãnh')
         * @param {string} displayElementId ID c·ªßa th·∫ª div hi·ªÉn th·ªã danh s√°ch
         * @param {Array<Object>} list Danh s√°ch h√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c t·∫£i v√† ti·ªÅn x·ª≠ l√Ω (ƒë√£ d·ªçn d·∫πp n·∫øu c·∫ßn)
         * @param {boolean} isSearchMode Ch·∫ø ƒë·ªô t√¨m ki·∫øm kh√¥ng c·∫ßn hi·ªÉn th·ªã header v√† cleanup
         */
        function renderPharmacyList(pharmacyName, displayElementId, list, isSearchMode = false) {
            const displayArea = document.getElementById(displayElementId);
            const todayKey = getCurrentDateKey();
            
            // C·∫≠p nh·∫≠t cache local (ch·ªâ c·∫ßn thi·∫øt cho list g·ªëc, nh∆∞ng an to√†n khi gi·ªØ l·∫°i)
            if (!isSearchMode) {
                currentInvoiceLists[pharmacyName] = list;
            }


            if (list.length === 0) {
                displayArea.innerHTML = `<div class="text-gray-500 text-center py-2">${isSearchMode ? 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n ph√π h·ª£p.' : 'Danh s√°ch h√≥a ƒë∆°n r·ªóng. H√£y nh·∫•n d·∫•u + ƒë·ªÉ th√™m h√≥a ƒë∆°n m·ªõi.'}</div>`;
                return;
            }

            // 1. Nh√≥m c√°c h√≥a ƒë∆°n theo ng√†y
            const groupedByDate = list.reduce((acc, entry) => {
                const date = entry.date || 'Kh√¥ng r√µ ng√†y';
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(entry);
                return acc;
            }, {});

            let html = isSearchMode ? '' : `<div class="p-2 text-sm font-bold text-gray-700 border-b border-gray-200 mb-4">
                            T·ªïng c·ªông: ${list.length} H√≥a ƒë∆°n
                        </div>`;

            // 2. S·∫Øp x·∫øp c√°c ng√†y theo th·ª© t·ª± gi·∫£m d·∫ßn (ng√†y m·ªõi nh·∫•t tr∆∞·ªõc)
            const sortedDates = Object.keys(groupedByDate).sort().reverse();

            // 3. Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ nh√≥m d∆∞·ªõi d·∫°ng HTML
            sortedDates.forEach(dateKey => {
                const companiesOnDate = groupedByDate[dateKey];
                const formattedDate = formatDate(dateKey); // DD/MM/YYYY
                const isToday = dateKey === todayKey;
                
                // Ki·ªÉm tra tr·∫°ng th√°i x√≥a
                const isDeletionPending = companiesOnDate[0].readyForDeletionTimestamp ? true : false;
                
                let groupStatusText = '';
                if (isDeletionPending) {
                    const timeToDeletion = companiesOnDate[0].readyForDeletionTimestamp - Date.now();
                    const hoursLeft = Math.ceil(timeToDeletion / (60 * 60 * 1000));
                    
                    // TH√äM N√öT H·ª¶Y X√ìA
                    groupStatusText = `<span class="ml-2 text-xs font-medium text-red-600 bg-red-100 px-2 py-0.5 rounded-full flex items-center">
                            <span class="mr-2">üóëÔ∏è S·∫Ω x√≥a sau ${hoursLeft} gi·ªù</span>
                            <button onclick="cancelGroupDeletion('${pharmacyName}', '${dateKey}')"
                                class="text-red-700 hover:text-white hover:bg-red-500 rounded-full transition duration-150 px-1 font-bold">
                                ‚ùå H·ªßy X√≥a
                            </button>
                        </span>`;
                }

                // Header nh√≥m ng√†y hi·ªán ƒë·∫°i - ƒê√É B·ªé "(H√îM NAY)"
                html += `<div class="mt-4 border-l-4 ${isToday ? 'border-red-600' : 'border-green-600'} pl-3 py-1 ${isToday ? 'bg-red-50/70' : 'bg-green-50/70'} rounded-r-lg shadow-sm flex justify-between items-center">
                             <h4 class="font-bold text-base text-gray-800">üìÖ NG√ÄY ${formattedDate} (${companiesOnDate.length} h√≥a ƒë∆°n)</h4>
                             ${groupStatusText}
                         </div>
                         <ul class="space-y-1 mt-2 mb-4 border border-gray-100 p-2 rounded-lg">`;

                // Danh s√°ch h√≥a ƒë∆°n
                companiesOnDate.forEach((company) => {
                    const { completed: isCompleted, id: invoiceId, name: invoiceName, link: invoiceLink } = company;

                    // Icon hi·ªÉn th·ªã tr·∫°ng th√°i ho√†n th√†nh
                    const completionIcon = isCompleted
                         ? `<svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`
                         : `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

                    html += `<li id="company-${invoiceId}" class="flex items-center p-2 rounded-md shadow-xs border border-gray-100 transition duration-100 ${!isCompleted ? 'opacity-60 bg-gray-50' : 'bg-white hover:bg-gray-50'}">

                                <button onclick="toggleCompletion('${pharmacyName}', '${invoiceId}')"
                                         class="p-1 mr-2 rounded-full flex-shrink-0 transition duration-150 transform hover:scale-110 ${isCompleted ? 'bg-green-100' : 'bg-gray-100'}">
                                    ${completionIcon}
                                </button>

                                <span class="flex-grow text-gray-700 ${!isCompleted ? 'text-gray-500' : ''} flex items-center">
                                    üìÑ ${invoiceName}
                                    
                                    ${invoiceLink ? `
                                        <a href="${invoiceLink}" target="_blank" rel="noopener noreferrer"
                                           title="M·ªü Link H√≥a ƒê∆°n ƒê√≠nh K√®m"
                                           class="ml-2 text-blue-500 hover:text-blue-700 transition duration-150 transform hover:scale-110">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-7-5l-5 5m0 0h4m-4 0v4m-1-5l5-5" />
                                            </svg>
                                        </a>
                                    ` : ''}
                                </span>

                                <div class="flex space-x-2 ml-4 flex-shrink-0">
                                    <button onclick="startEditInvoice('${pharmacyName}', '${invoiceId}')"
                                             title="Ch·ªânh s·ª≠a H√≥a ƒë∆°n"
                                            class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="showDeleteModal('${pharmacyName}', '${invoiceId}', '${invoiceName}')"
                                            title="X√≥a H√≥a ƒë∆°n"
                                             class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 11.23a2 2 0 01-1.99 1.77H7.85a2 2 0 01-1.99-1.77L5 7m1 0V6a1 1 0 011-1h10a1 1 0 011 1v1M8 7h8" />
                                        </svg>
                                    </button>
                                </div>
                             </li>`;
                });
                html += `</ul>`;
            });

            displayArea.innerHTML = html;
        }

        /**
         * H√†m hi·ªÉn th·ªã danh s√°ch t·∫•t c·∫£ c√°c h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh t·ª´ c·∫£ hai nh√† thu·ªëc (T·ªïng quan).
         */
        function renderUncompletedOverview() {
            const container = document.getElementById('uncompletedOverviewContainer');
            let allUncompleted = [];

            // 1. Thu th·∫≠p t·∫•t c·∫£ h√≥a ƒë∆°n ch∆∞a ho√†n th√†nh t·ª´ cache g·ªëc
            Object.keys(PHARMACY_MAP).forEach(pharmacyName => {
                const list = currentInvoiceLists[pharmacyName] || [];
                // L·ªçc nh·ªØng m·ª•c ch∆∞a ho√†n th√†nh V√Ä ch∆∞a s·∫µn s√†ng x√≥a
                const uncompleted = list.filter(item => !item.completed && !item.readyForDeletionTimestamp);
                uncompleted.forEach(item => {
                    allUncompleted.push({
                        ...item,
                        pharmacy: pharmacyName // Th√™m th√¥ng tin Nh√† thu·ªëc
                    });
                });
            });

            if (allUncompleted.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-6">üéâ Tuy·ªát v·ªùi! Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o c·∫ßn x·ª≠ l√Ω.</div>`;
                return;
            }

            // 2. S·∫Øp x·∫øp danh s√°ch (theo ng√†y c≈© nh·∫•t tr∆∞·ªõc)
            allUncompleted.sort((a, b) => {
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                return 0;
            });

            // 3. Render danh s√°ch t·ªïng h·ª£p
            let html = `<ul class="space-y-1">`;
            const now = Date.now();

            // Icon cho tr·∫°ng th√°i ch∆∞a ho√†n th√†nh
            const uncompletedIcon = `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

            allUncompleted.forEach(invoice => {
                // ƒê·∫£m b·∫£o invoice.date c√≥ th·ªÉ chuy·ªÉn th√†nh Date object
                const invoiceDate = new Date(invoice.date + 'T00:00:00');
                if (isNaN(invoiceDate)) return; // B·ªè qua n·∫øu ng√†y kh√¥ng h·ª£p l·ªá

                const dateDiffMs = now - invoiceDate.getTime();
                const daysOld = Math.floor(dateDiffMs / ONE_DAY_MS);

                let statusClass = 'text-gray-700';
                let statusEmoji = '‚ö†Ô∏è';
                let actionButton = '';

                // C·∫£nh b√°o h√≥a ƒë∆°n ƒë√£ c≈©
                if (daysOld >= 3) {
                    statusClass = 'text-red-600 font-semibold';
                    statusEmoji = 'üö®'; // C·∫£nh b√°o ∆∞u ti√™n cao (3 ng√†y tu·ªïi)
                } else if (daysOld >= 1) {
                    statusClass = 'text-orange-500 font-semibold';
                    statusEmoji = 'üü†'; // C·∫£nh b√°o trung b√¨nh (1-2 ng√†y tu·ªïi)
                }
                
                // N√∫t h√†nh ƒë·ªông nhanh
                const key = PHARMACY_MAP[invoice.pharmacy];
                actionButton = `<button onclick="showPharmacy('${invoice.pharmacy}', '${key}');"
                                    class="text-blue-500 hover:text-blue-700 font-semibold transition duration-150 text-xs px-2 py-1 bg-blue-50 rounded-md">
                                    Xem chi ti·∫øt
                                </button>`;


                html += `
                    <li class="p-2 border-b border-gray-100 flex justify-between items-center bg-white hover:bg-red-50 transition duration-100 rounded-md shadow-xs">
                        
                        <button onclick="toggleCompletion('${invoice.pharmacy}', '${invoice.id}')"
                                 title="ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh"
                                class="p-1 mr-3 rounded-full transition duration-150 transform hover:scale-110 bg-gray-100 flex-shrink-0">
                            ${uncompletedIcon}
                        </button>
                        
                        <div class="flex-grow flex justify-between items-center">
                            <span class="${statusClass} text-sm flex items-center">
                                ${statusEmoji}
                                 <span class="ml-2">${invoice.name}</span>
                            </span>
                            <span class="text-xs text-gray-500 font-medium bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap flex-shrink-0 mr-3">
                                ${invoice.pharmacy} | Ng√†y: ${formatDate(invoice.date)}
                            </span>
                            ${actionButton}
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;

            container.innerHTML = html;
        }

        /**
         * H√†m hi·ªÉn th·ªã n·ªôi dung c·ªßa nh√† thu·ªëc ƒë∆∞·ª£c ch·ªçn v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i tab.
         */
        function showPharmacy(pharmacyName, key) {
            const tabElement = document.getElementById(`tab${key}`);
            const isAlreadyActive = tabElement.classList.contains('border-green-500');

            // 1. ·∫®n t·∫•t c·∫£ n·ªôi dung v√† ƒë·∫∑t l·∫°i style cho t·∫•t c·∫£ tabs
            const allKeys = Object.values(PHARMACY_MAP);
            allKeys.forEach(k => {
                document.getElementById(`content${k}`)?.classList.add('hidden');
                document.getElementById(`form${k}`)?.classList.add('hidden');
                const t = document.getElementById(`tab${k}`);
                if(t) {
                    t.classList.remove('bg-white', 'border-green-500', 'border-b-2');
                    t.classList.add('text-gray-600', 'hover:bg-gray-100', 'border-transparent');
                    t.style.marginBottom = '0';
                }
            });

            // 2. Ch·ªâ hi·ªÉn th·ªã n·∫øu n√≥ CH∆ØA active
            if (!isAlreadyActive) {
                const contentElement = document.getElementById(`content${key}`);

                // HI·ªÇN TH·ªä n·ªôi dung v√† l√†m ACTIVE tab
                contentElement.classList.remove('hidden');
                tabElement.classList.add('bg-white', 'border-green-500', 'border-b-2');
                tabElement.classList.remove('text-gray-600', 'hover:bg-gray-100', 'border-transparent');
                tabElement.style.marginBottom = '-2px';
            }
        }

        /**
         * B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu c·ª•c b·ªô khi ·ª©ng d·ª•ng kh·ªüi ƒë·ªông ho·∫∑c sau khi l∆∞u.
         */
        function startLocalListeners() {
            // Lo·∫°i b·ªè ch·ªâ b√°o t·∫£i v√† hi·ªÉn th·ªã n·ªôi dung ch√≠nh
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('app-container').classList.remove('opacity-0');

            const pharmacies = Object.keys(PHARMACY_MAP);

            // B1: T·∫£i t·∫•t c·∫£ d·ªØ li·ªáu g·ªëc
            pharmacies.forEach(pharmacyName => {
                const list = loadInvoices(pharmacyName);
                currentInvoiceLists[pharmacyName] = list; // L∆∞u v√†o cache g·ªëc
            });
            
            // B2: Ch·∫°y d·ªçn d·∫πp v√† render l·∫ßn ƒë·∫ßu
            pharmacies.forEach(pharmacyName => {
                const list = currentInvoiceLists[pharmacyName];
                const key = PHARMACY_MAP[pharmacyName];
                
                // Ch·∫°y d·ªçn d·∫πp t·ª± ƒë·ªông (N·∫øu c√≥ m·ª•c h·∫øt h·∫°n, n√≥ s·∫Ω t·ª± ƒë·ªông l∆∞u l·∫°i)
                const filteredList = runAutoCleanupAndFiltering(pharmacyName, list);

                // Render danh s√°ch c·ªßa t·ª´ng nh√† thu·ªëc
                renderPharmacyList(pharmacyName, `display${key}`, filteredList);
            });

            // Render T·ªïng quan H√≥a ƒë∆°n ch∆∞a ho√†n th√†nh
            renderUncompletedOverview();
        }

        /**
         * H√†m kh·ªüi t·∫°o ch·∫°y khi load trang.
         */
        async function initTabs() {
            startLocalListeners();
            // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã tab ƒë·∫ßu ti√™n
            showPharmacy('NT Tu·ªá Thi·ªán', 'TueThien');
        }
    </script>
</body>
</html>
